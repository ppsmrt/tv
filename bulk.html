<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="utf-8"/>
  <meta name="viewport" content="width=device-width, initial-scale=1"/>
  <title>TNM3U Admin Panel</title>

  <meta name="robots" content="noindex, nofollow"/>
  <script src="https://cdn.tailwindcss.com"></script>
  <link href="https://fonts.googleapis.com/css2?family=Baloo+2&display=swap" rel="stylesheet">
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.0/css/all.min.css"/>
  <style>
    body { font-family: 'Baloo 2', cursive; }
    .collapsible { max-height: 0; overflow: hidden; transition: max-height 0.4s ease; }
  </style>
</head>
<body class="bg-[#121212] text-white w-screen h-screen flex flex-col">

  <!-- Header -->
  <div id="header"></div>

  <div class="flex-1 flex flex-col md:flex-row overflow-hidden">

    <!-- Left: Form -->
    <div class="w-full md:w-1/2 p-5 bg-[#1E1E1E] shadow-lg overflow-y-auto rounded-xl space-y-6">

      <!-- Bulk Upload -->
      <div class="bg-gray-800 p-4 rounded-xl space-y-3">
        <h2 class="text-lg font-bold mb-2">üì• Bulk Playlist Upload</h2>

        <div>
          <label class="block text-gray-300 font-semibold mb-1">Playlist URL</label>
          <input type="url" id="playlistUrl" placeholder="https://example.com/playlist.m3u"
            class="w-full p-2 rounded bg-gray-700 text-white border border-gray-600 focus:ring-1 focus:ring-blue-400"/>
          <button id="fetchBtn"
            class="w-full mt-2 bg-blue-600 hover:bg-blue-700 font-semibold py-2 px-4 rounded-lg transition">Fetch & Preview</button>
        </div>

        <div class="flex items-center justify-center text-gray-500">‚Äî OR ‚Äî</div>

        <div>
          <label class="block text-gray-300 font-semibold mb-1">Upload .m3u File</label>
          <input type="file" id="fileInput" accept=".m3u"
            class="w-full p-2 rounded bg-gray-700 text-white border border-gray-600"/>
          <button id="uploadBtn"
            class="w-full mt-2 bg-green-600 hover:bg-green-700 font-semibold py-2 px-4 rounded-lg transition">Upload & Preview</button>
        </div>

        <p id="bulkStatus" class="text-gray-400 mt-2 text-sm"></p>
      </div>

      <!-- Single Channel Form -->
      <form id="channelForm" class="grid gap-4 md:grid-cols-2 bg-gray-800 p-4 rounded-xl shadow-lg">
        <input type="hidden" id="channelId"/>

        <div>
          <label class="block text-gray-300 font-semibold mb-1">Channel Name</label>
          <input type="text" id="name" required class="w-full px-4 py-2 border border-gray-600 bg-[#121212] text-white rounded-lg focus:ring-2 focus:ring-yellow-400 focus:outline-none"/>
        </div>

        <div>
          <label class="block text-gray-300 font-semibold mb-1">Upload Icon</label>
          <div class="relative">
            <input type="file" id="uploadIcon" accept="image/*" class="absolute inset-0 w-full h-full opacity-0 cursor-pointer"/>
            <div class="flex items-center justify-center gap-2 bg-gradient-to-r from-[#d92a1a] to-[#ff4a3f] text-white font-bold py-2 px-4 rounded-xl shadow-lg hover:shadow-xl transition-all cursor-pointer select-none">
              <i class="fa-solid fa-upload"></i> Choose Image
            </div>
          </div>
          <input type="hidden" id="icon" name="icon"/>
          <p id="uploadStatus" class="text-sm text-gray-400 mt-1"></p>
        </div>

        <div>
          <label class="block text-gray-300 font-semibold mb-1">Stream URL</label>
          <input type="url" id="stream" required class="w-full px-4 py-2 border border-gray-600 bg-[#121212] text-white rounded-lg focus:ring-2 focus:ring-yellow-400 focus:outline-none"/>
          <p id="streamStatus" class="text-sm mt-1"></p>
        </div>

        <div>
          <label class="block text-gray-300 font-semibold mb-1">Category</label>
          <select id="category" required class="w-full px-4 py-2 border border-gray-600 bg-[#121212] text-white rounded-lg focus:ring-2 focus:ring-yellow-400 focus:outline-none">
            <option value="Tamil">Tamil</option>
            <option value="Telugu">Telugu</option>
            <option value="Kannada">Kannada</option>
            <option value="Malayalam">Malayalam</option>
            <option value="Hindi">Hindi</option>
            <option value="English">English</option>
            <option value="News">News</option>
            <option value="Movies">Movies</option>
            <option value="Music">Music</option>
            <option value="Sports">Sports</option>
            <option value="International">International</option>
          </select>
        </div>

        <!-- Collapsible Info -->
        <div class="md:col-span-2">
          <button type="button" id="toggleInfo" class="w-full flex items-center justify-between bg-[#1E1E1E] px-4 py-2 rounded-lg font-semibold text-gray-300 hover:bg-gray-700 transition">
            Channel Info
            <i id="infoIcon" class="fa-solid fa-chevron-down"></i>
          </button>

          <div id="extraInfo" class="collapsible mt-3 grid gap-4 md:grid-cols-2">
            <div>
              <label class="block text-gray-300 font-semibold mb-1">Channel Type</label>
              <select id="channelType" class="w-full px-4 py-2 border border-gray-600 bg-[#121212] text-white rounded-lg focus:ring-2 focus:ring-yellow-400 focus:outline-none">
                <option value="Entertainment">Entertainment</option>
                <option value="News">News</option>
                <option value="Sports">Sports</option>
                <option value="Movies">Movies</option>
                <option value="Music">Music</option>
                <option value="Kids">Kids</option>
                <option value="Devotional">Devotional</option>
                <option value="Lifestyle">Lifestyle</option>
                <option value="Documentary">Documentary</option>
                <option value="Education">Education</option>
                <option value="Regional">Regional</option>
                <option value="Local Channels">Local Channels</option>
              </select>
            </div>

            <div>
              <label class="block text-gray-300 font-semibold mb-1">Language</label>
              <select id="language" class="w-full px-4 py-2 border border-gray-600 bg-[#121212] text-white rounded-lg focus:ring-2 focus:ring-yellow-400 focus:outline-none">
                <option value="Tamil">Tamil</option>
                <option value="English">English</option>
                <option value="Hindi">Hindi</option>
              </select>
            </div>

            <div>
              <label class="block text-gray-300 font-semibold mb-1">Country</label>
              <input type="text" id="country" placeholder="India" class="w-full px-4 py-2 border border-gray-600 bg-[#121212] text-white rounded-lg focus:ring-2 focus:ring-yellow-400 focus:outline-none"/>
            </div>

            <div>
              <label class="block text-gray-300 font-semibold mb-1">Tags</label>
              <input type="text" id="tags" placeholder="news,sports,etc." class="w-full px-4 py-2 border border-gray-600 bg-[#121212] text-white rounded-lg focus:ring-2 focus:ring-yellow-400 focus:outline-none"/>
            </div>

            <div class="md:col-span-2">
              <label class="block text-gray-300 font-semibold mb-1">Description</label>
              <textarea id="description" rows="3" placeholder="Channel description..." class="w-full px-4 py-2 border border-gray-600 bg-[#121212] text-white rounded-lg focus:ring-2 focus:ring-yellow-400 focus:outline-none"></textarea>
            </div>
          </div>
        </div>

        <button type="submit" id="submitBtn" class="col-span-2 bg-[#d92a1a] text-white font-bold py-3 rounded-xl shadow-md hover:bg-red-700 transition">
          <i class="fa-solid fa-save mr-2"></i> Save Channel
        </button>
        <p id="statusMsg" class="text-center mt-3 font-semibold text-gray-300"></p>
      </form>
    </div>

    <!-- Right: Channel List -->
    <div class="flex-1 flex flex-col overflow-hidden">
      <div class="p-5 bg-[#1E1E1E] flex flex-col md:flex-row gap-4 md:items-center justify-between rounded-xl">
        <div class="flex gap-3">
          <select id="filterCategory" class="px-4 py-2 border border-gray-600 bg-[#121212] text-white rounded-lg focus:ring-2 focus:ring-yellow-400 focus:outline-none">
            <option value="All">All Categories</option>
            <option value="Tamil">Tamil</option>
            <option value="News">News</option>
            <option value="Movies">Movies</option>
            <option value="Music">Music</option>
          </select>
        </div>
        <input id="searchInput" placeholder="Search by name" class="px-4 py-2 bg-[#121212] border border-gray-600 rounded-lg focus:ring-2 focus:ring-yellow-400"/>
        <select id="sortOption" class="px-4 py-2 border border-gray-600 bg-[#121212] text-white rounded-lg focus:ring-2 focus:ring-yellow-400 focus:outline-none">
          <option value="latest">Latest</option>
          <option value="oldest">Oldest</option>
          <option value="az">A-Z</option>
        </select>
        <button id="logoutBtn" class="bg-red-600 px-4 py-2 rounded-lg hover:bg-red-700 text-white font-semibold">Logout</button>
      </div>
      <div class="flex-1 overflow-y-auto p-5">
        <h2 class="text-xl font-bold text-white mb-4">Channels</h2>
        <div id="channelList" class="grid grid-cols-1 md:grid-cols-2 gap-4"></div>
      </div>
    </div>
  </div>

  <!-- Modal for Bulk Editing -->
  <div id="editModal" class="hidden fixed inset-0 bg-black bg-opacity-60 flex items-center justify-center z-50">
    <div class="bg-gray-800 rounded-2xl shadow-2xl p-6 w-full max-w-3xl max-h-[80vh] overflow-y-auto">
      <h2 class="text-xl font-bold mb-4 text-center">üìù Review & Edit Channels</h2>
      <table class="w-full text-sm text-left border-collapse border border-gray-700">
        <thead class="bg-gray-700">
          <tr>
            <th class="p-2 border border-gray-600 w-10">#</th>
            <th class="p-2 border border-gray-600">Name</th>
            <th class="p-2 border border-gray-600">URL</th>
            <th class="p-2 border border-gray-600 w-24 text-center">Status</th>
            <th class="p-2 border border-gray-600 w-16 text-center">Action</th>
          </tr>
        </thead>
        <tbody id="channelTable"></tbody>
      </table>
      <div class="flex justify-end gap-3 mt-5">
        <button id="cancelBtn" class="bg-gray-600 hover:bg-gray-700 px-4 py-2 rounded-lg font-semibold">Cancel</button>
        <button id="saveBtn" class="bg-blue-600 hover:bg-blue-700 px-4 py-2 rounded-lg font-semibold">Save to Database</button>
      </div>
    </div>
  </div>

  <script src="assets/js/header.js"></script>
  <script src="assets/js/footer.js"></script>
  <script>
    import { initializeApp } from "https://www.gstatic.com/firebasejs/10.12.3/firebase-app.js";
import { getDatabase, ref, push, set, update, remove, onValue } from "https://www.gstatic.com/firebasejs/10.12.3/firebase-database.js";
import { getAuth, signOut } from "https://www.gstatic.com/firebasejs/10.12.3/firebase-auth.js";

// Firebase config
const firebaseConfig = {
  apiKey: "AIzaSyB9GaCbYFH22WbiLs1pc_UJTsM_0Tetj6E",
  authDomain: "tnm3ulive.firebaseapp.com",
  databaseURL: "https://tnm3ulive-default-rtdb.asia-southeast1.firebasedatabase.app",
  projectId: "tnm3ulive",
  storageBucket: "tnm3ulive.appspot.com",
  messagingSenderId: "80664356882",
  appId: "1:80664356882:web:c8464819b0515ec9b210cb",
  measurementId: "G-FNS9JWZ9LS"
};

const app = initializeApp(firebaseConfig);
const db = getDatabase(app);
const auth = getAuth(app);

// DOM Elements
const form = document.getElementById("channelForm");
const channelList = document.getElementById("channelList");
const submitBtn = document.getElementById("submitBtn");
const filterCategory = document.getElementById("filterCategory");
const searchInput = document.getElementById("searchInput");
const sortOption = document.getElementById("sortOption");
const uploadIconInput = document.getElementById("uploadIcon");
const iconHidden = document.getElementById("icon");
const uploadStatus = document.getElementById("uploadStatus");
const descriptionBox = document.getElementById("description");

// Bulk Upload Elements
const playlistUrl = document.getElementById("playlistUrl");
const fetchBtn = document.getElementById("fetchBtn");
const fileInput = document.getElementById("fileInput");
const uploadBtn = document.getElementById("uploadBtn");
const bulkStatus = document.getElementById("bulkStatus");
const editModal = document.getElementById("editModal");
const channelTable = document.getElementById("channelTable");
const cancelBtn = document.getElementById("cancelBtn");
const saveBtn = document.getElementById("saveBtn");

// Toast notifications
function showToast(message, type = "success") {
  const existing = document.querySelector(".toast");
  if (existing) existing.remove();
  const toast = document.createElement("div");
  toast.className = `toast fixed bottom-5 right-5 px-5 py-3 rounded-lg shadow-lg text-white font-semibold z-50 transition-transform transform ${
    type === "success" ? "bg-green-600" : type === "error" ? "bg-red-600" : "bg-gray-600"
  }`;
  toast.textContent = message;
  document.body.appendChild(toast);
  toast.style.opacity = "0";
  toast.style.transform = "translateY(50px)";
  setTimeout(() => {
    toast.style.transition = "opacity 0.3s, transform 0.3s";
    toast.style.opacity = "1";
    toast.style.transform = "translateY(0)";
  }, 50);
  setTimeout(() => {
    toast.style.opacity = "0";
    toast.style.transform = "translateY(50px)";
    setTimeout(() => toast.remove(), 300);
  }, 3000);
}

// Status helper
function showStatus(msg, isError = false) {
  showToast(msg, isError ? "error" : "success");
}

// Channels Data
let channelsData = {};
let bulkChannels = [];

// --------------------- ICON UPLOAD ---------------------
uploadIconInput.addEventListener("change", async () => {
  const file = uploadIconInput.files[0];
  if (!file) return;
  uploadStatus.textContent = "Uploading...";
  const formData = new FormData();
  formData.append("image", file);
  try {
    const response = await fetch(`https://api.imgbb.com/1/upload?key=8604e4b4050c63c460d0bca39cf28708`, {
      method: "POST",
      body: formData
    });
    const data = await response.json();
    if (data.success) {
      iconHidden.value = data.data.url;
      showToast("Image uploaded successfully!");
      uploadStatus.textContent = "";
      uploadIconInput.value = "";
    } else {
      showToast("Upload failed!", "error");
      uploadStatus.textContent = "";
    }
  } catch (error) {
    showToast("Error uploading image!", "error");
    uploadStatus.textContent = "";
    console.error(error);
  }
});

// --------------------- AUTO DESCRIPTION ---------------------
const nameInput = document.getElementById("name");
const channelTypeSelect = document.getElementById("channelType");

const descriptionTemplates = {
  News: (name) => `Stay updated with the latest news. Watch ${name} live on tnm3u.live.`,
  Entertainment: (name) => `Catch your favorite shows and movies on ${name} via tnm3u.live.`,
  Movies: (name) => `Watch blockbuster movies on ${name}, only on tnm3u.live.`,
  Music: (name) => `Listen to the latest hits on ${name}, via tnm3u.live.`,
  Sports: (name) => `Follow live sports on ${name}, only on tnm3u.live.`,
  Kids: (name) => `Fun & learning for kids on ${name}, via tnm3u.live.`,
  Devotional: (name) => `Spiritual programs on ${name}, only on tnm3u.live.`,
  Lifestyle: (name) => `Explore lifestyle content on ${name}, via tnm3u.live.`,
  Documentary: (name) => `Watch documentaries on ${name}, only on tnm3u.live.`,
  Education: (name) => `Learn with ${name}, via tnm3u.live.`,
  Regional: (name) => `Updates from your region on ${name}, via tnm3u.live.`,
  "Local Channels": (name) => `Local news & updates on ${name}, only on tnm3u.live.`
};

function autoGenerateDescription() {
  const name = nameInput.value.trim() || "this channel";
  const type = channelTypeSelect.value;
  if (descriptionTemplates[type]) descriptionBox.value = descriptionTemplates[type](name);
}

[nameInput, channelTypeSelect].forEach(el => {
  el.addEventListener("input", autoGenerateDescription);
  el.addEventListener("change", autoGenerateDescription);
});

// --------------------- FETCH CHANNELS ---------------------
const channelsRef = ref(db, "channels");
onValue(channelsRef, snapshot => {
  channelsData = snapshot.val() || {};
  renderChannels();
});

// --------------------- RENDER CHANNELS ---------------------
function renderChannels() {
  channelList.innerHTML = "";
  const searchTerm = searchInput.value.toLowerCase();
  const selectedCategory = filterCategory.value;
  const sortBy = sortOption.value;

  let filtered = Object.entries(channelsData).filter(([id, ch]) => {
    const matchesCategory = selectedCategory === "All" || ch.category === selectedCategory;
    const matchesSearch = ch.name.toLowerCase().includes(searchTerm);
    return matchesCategory && matchesSearch;
  });

  if (sortBy === "az") filtered.sort((a, b) => a[1].name.localeCompare(b[1].name));
  else if (sortBy === "latest") filtered.sort((a, b) => new Date(b[1].createdAt || 0) - new Date(a[1].createdAt || 0));
  else if (sortBy === "oldest") filtered.sort((a, b) => new Date(a[1].createdAt || 0) - new Date(b[1].createdAt || 0));

  if (!filtered.length) {
    channelList.innerHTML = "<p class='text-gray-500'>No matching channels found.</p>";
    return;
  }

  filtered.forEach(([id, ch]) => {
    const card = document.createElement("div");
    card.className = "flex items-center bg-[#1E1E1E] shadow-md rounded-xl p-4 gap-4 border border-gray-700";
    card.innerHTML = `
      <img src="${ch.icon}" alt="${ch.name}" class="w-16 h-16 object-contain rounded-lg border border-gray-600"/>
      <div class="flex-1">
        <h3 class="text-lg font-bold text-white">${ch.name}</h3>
        <p class="text-gray-400 text-sm">${ch.category} | ${ch.channelType || "N/A"}</p>
      </div>
      <div class="flex gap-2">
        <button class="editBtn bg-blue-600 text-white px-3 py-1 rounded-lg hover:bg-blue-700" data-id="${id}">
          <i class="fa-solid fa-pen"></i>
        </button>
        <button class="deleteBtn bg-red-600 text-white px-3 py-1 rounded-lg hover:bg-red-700" data-id="${id}">
          <i class="fa-solid fa-trash"></i>
        </button>
      </div>
    `;
    channelList.appendChild(card);
  });

  attachActions();
}

// --------------------- EDIT / DELETE ---------------------
function attachActions() {
  document.querySelectorAll(".editBtn").forEach(btn => {
    btn.addEventListener("click", () => {
      const id = btn.dataset.id;
      const ch = channelsData[id];
      document.getElementById("channelId").value = id;
      nameInput.value = ch.name;
      iconHidden.value = ch.icon;
      document.getElementById("stream").value = ch.stream;
      document.getElementById("category").value = ch.category;
      channelTypeSelect.value = ch.channelType || "Entertainment";
      document.getElementById("language").value = ch.language;
      document.getElementById("country").value = ch.country;
      document.getElementById("tags").value = ch.tags || "";
      descriptionBox.value = ch.description || "";
      window.scrollTo({ top: 0, behavior: "smooth" });
    });
  });

  document.querySelectorAll(".deleteBtn").forEach(btn => {
    btn.addEventListener("click", async () => {
      const id = btn.dataset.id;
      if (confirm("Are you sure you want to delete this channel?")) {
        try {
          await remove(ref(db, "channels/" + id));
          showStatus("‚úÖ Channel deleted!");
        } catch (err) {
          showStatus("‚ùå Error deleting channel: " + err.message, true);
        }
      }
    });
  });
}

// --------------------- SINGLE CHANNEL FORM ---------------------
form.addEventListener("submit", async e => {
  e.preventDefault();
  const channelId = document.getElementById("channelId").value;
  const name = nameInput.value.trim();
  const icon = iconHidden.value.trim();
  const stream = document.getElementById("stream").value.trim();
  const category = document.getElementById("category").value;
  const channelType = channelTypeSelect.value;
  const language = document.getElementById("language").value;
  const country = document.getElementById("country").value.trim();
  const tags = document.getElementById("tags").value.trim();
  const description = descriptionBox.value.trim();

  if (!name || !icon || !stream || !category || !channelType || !language || !country) {
    showStatus("‚ö†Ô∏è Please fill all required fields.", true);
    return;
  }

  submitBtn.disabled = true;
  try {
    const now = new Date().toISOString();
    const user = auth.currentUser;
    let adminName = "Unknown Admin";

    if (user) {
      const adminRef = ref(db, "admins/" + user.uid + "/name");
      const snapshot = await new Promise(resolve => onValue(adminRef, resolve, { onlyOnce: true }));
      if (snapshot.exists()) adminName = snapshot.val();
    }

    const channelData = {
      name, icon, stream, category, channelType, language, country, tags, description
    };

    if (channelId) {
      await update(ref(db, "channels/" + channelId), {
        ...channelData,
        editedAt: now,
        editedBy: adminName
      });
      showStatus("‚úÖ Channel updated!");
    } else {
      const newRef = push(ref(db, "channels"));
      await set(newRef, {
        ...channelData,
        createdAt: now,
        createdBy: adminName
      });
      showStatus("‚úÖ Channel added!");
    }

    form.reset();
    document.getElementById("channelId").value = "";
    descriptionBox.value = "";
  } catch (err) {
    showStatus("‚ùå Error: " + err.message, true);
  } finally {
    submitBtn.disabled = false;
  }
});

// --------------------- FILTER / SEARCH / SORT ---------------------
[filterCategory, searchInput, sortOption].forEach(el => el.addEventListener("input", renderChannels));

// --------------------- LOGOUT ---------------------
document.getElementById("logoutBtn").addEventListener("click", () => {
  signOut(auth)
    .then(() => {
      showToast("Logged out successfully!");
      setTimeout(() => window.location.href = "/", 1000);
    })
    .catch(err => showToast("Logout failed: " + err.message, "error"));
});

// --------------------- BULK PLAYLIST PARSING ---------------------
function parseM3U(content) {
  const lines = content.split("\n").map(l => l.trim()).filter(Boolean);
  const channels = [];
  for (let i = 0; i < lines.length; i++) {
    if (lines[i].startsWith("#EXTINF:")) {
      const infoLine = lines[i];
      const streamLine = lines[i + 1];
      const nameMatch = infoLine.match(/,(.+)$/);
      const name = nameMatch ? nameMatch[1] : "Unnamed";
      channels.push({ name, stream: streamLine });
      i++; // skip next line
    }
  }
  return channels;
}

async function handleBulkUpload(content) {
  bulkChannels = parseM3U(content);
  if (!bulkChannels.length) {
    bulkStatus.textContent = "No channels found in playlist.";
    return;
  }

  // Check duplicates
  bulkChannels = bulkChannels.map(ch => {
    const duplicate = Object.values(channelsData).find(c => c.stream === ch.stream || c.name === ch.name);
    return { ...ch, duplicate: !!duplicate };
  });

  // Populate modal
  channelTable.innerHTML = "";
  bulkChannels.forEach((ch, index) => {
    const tr = document.createElement("tr");
    tr.className = ch.duplicate ? "bg-red-800 text-gray-300" : "bg-gray-700";
    tr.innerHTML = `
      <td class="border p-2">${index+1}</td>
      <td class="border p-2"><input value="${ch.name}" class="w-full bg-transparent text-white"/></td>
      <td class="border p-2"><input value="${ch.stream}" class="w-full bg-transparent text-white"/></td>
      <td class="border p-2 text-center">${ch.duplicate ? "Duplicate" : "New"}</td>
      <td class="border p-2 text-center"><input type="checkbox" ${ch.duplicate ? "" : "checked"}/></td>
    `;
    channelTable.appendChild(tr);
  });

  editModal.classList.remove("hidden");
}

// Fetch URL
fetchBtn.addEventListener("click", async () => {
  const url = playlistUrl.value.trim();
  if (!url) return;
  bulkStatus.textContent = "Fetching...";
  try {
    const res = await fetch(url);
    const text = await res.text();
    await handleBulkUpload(text);
    bulkStatus.textContent = "";
  } catch(err) {
    bulkStatus.textContent = "Error fetching playlist.";
    console.error(err);
  }
});

// Upload file
uploadBtn.addEventListener("click", () => {
  const file = fileInput.files[0];
  if (!file) return;
  bulkStatus.textContent = "Reading file...";
  const reader = new FileReader();
  reader.onload = e => handleBulkUpload(e.target.result);
  reader.readAsText(file);
});

// --------------------- MODAL ACTIONS ---------------------
cancelBtn.addEventListener("click", () => editModal.classList.add("hidden"));
saveBtn.addEventListener("click", async () => {
  const rows = channelTable.querySelectorAll("tr");
  submitBtn.disabled = true;
  try {
    const user = auth.currentUser;
    let adminName = "Unknown Admin";
    if (user) {
      const adminRef = ref(db, "admins/" + user.uid + "/name");
      const snapshot = await new Promise(resolve => onValue(adminRef, resolve, { onlyOnce: true }));
      if (snapshot.exists()) adminName = snapshot.val();
    }

    for (let i = 0; i < rows.length; i++) {
      const inputs = rows[i].querySelectorAll("input");
      const name = inputs[0].value.trim();
      const stream = inputs[1].value.trim();
      const saveCheck = inputs[2].checked || inputs[2].type === "checkbox";
      if (!saveCheck) continue;
      const duplicate = Object.values(channelsData).find(c => c.stream === stream);
      if (duplicate) continue;
      const newRef = push(ref(db, "channels"));
      await set(newRef, {
        name, stream,
        icon: "", category: "General", channelType: "Entertainment",
        language: "English", country: "Unknown", tags: "",
        description: descriptionTemplates["Entertainment"](name),
        createdAt: new Date().toISOString(),
        createdBy: adminName
      });
    }

    showStatus("‚úÖ Bulk channels saved!");
    editModal.classList.add("hidden");
  } catch(err) {
    showStatus("‚ùå Error saving bulk channels: " + err.message, true);
    console.error(err);
  } finally {
    submitBtn.disabled = false;
  }
});

// --------------------- COLLAPSIBLE INFO ---------------------
const toggleInfo = document.getElementById("toggleInfo");
const extraInfo = document.getElementById("extraInfo");
const infoIcon = document.getElementById("infoIcon");
toggleInfo.addEventListener("click", () => {
  if (extraInfo.style.maxHeight) {
    extraInfo.style.maxHeight = null;
    infoIcon.classList.remove("fa-chevron-up");
    infoIcon.classList.add("fa-chevron-down");
  } else {
    extraInfo.style.maxHeight = extraInfo.scrollHeight + "px";
    infoIcon.classList.remove("fa-chevron-down");
    infoIcon.classList.add("fa-chevron-up");
  }
});
  
  </script>
</body>
</html>
