<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="utf-8"/>
  <meta name="viewport" content="width=device-width, initial-scale=1"/>
  <title>Channel Manager</title>

  <meta name="robots" content="noindex, nofollow"/>

  <!-- Tailwind CSS -->
  <script src="https://cdn.tailwindcss.com"></script>
  <link href="https://fonts.googleapis.com/css2?family=Baloo+2&display=swap" rel="stylesheet">
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.0/css/all.min.css"/>
  <link href="https://fonts.googleapis.com/css2?family=Material+Symbols+Outlined" rel="stylesheet">
  <style>
    body { font-family: 'Baloo 2', cursive; }
    .modal-bg { background-color: rgba(0,0,0,0.6); }
  </style>
</head>
<body class="bg-[#121212] text-white w-screen h-screen flex flex-col">

  <!-- Header -->
  <div id="header" class="p-5 bg-[#1E1E1E] flex justify-end rounded-xl">
    <button id="openModalBtn"
      class="bg-[#d92a1a] px-4 py-2 rounded-xl font-bold hover:bg-red-700 transition flex items-center gap-2">
      <i class="fa-solid fa-plus"></i> Add Channels
    </button>
  </div>

  <!-- Bulk/Preview Modal -->
  <div id="bulkModal" class="hidden fixed inset-0 flex items-center justify-center modal-bg z-50">
    <div class="bg-[#1E1E1E] rounded-xl p-6 w-11/12 md:w-3/4 max-h-[90vh] overflow-y-auto">
      <h2 class="text-2xl font-bold mb-4">Channels Preview</h2>

      <!-- Unified Input Section -->
      <div class="mb-4 flex flex-col md:flex-row gap-3">
        <input type="url" id="channelsUrl" placeholder="Enter JSON/M3U URL"
          class="flex-1 bg-[#121212] text-white border border-gray-600 rounded-lg p-2"/>
        <button id="fetchUrlBtn" class="bg-blue-600 px-4 py-2 rounded-lg hover:bg-blue-700">Fetch</button>
        <input type="file" id="bulkFile" accept=".txt,.json,.m3u"
          class="bg-[#121212] text-white border border-gray-600 rounded-lg p-2"/>
      </div>

      <table class="w-full text-left border border-gray-700 mb-4">
        <thead>
          <tr class="bg-gray-800">
            <th class="p-2">Icon</th>
            <th class="p-2">Name</th>
            <th class="p-2">Stream</th>
            <th class="p-2">Actions</th>
          </tr>
        </thead>
        <tbody id="bulkPreview" class="divide-y divide-gray-700"></tbody>
      </table>

      <div class="flex justify-end gap-3">
        <button id="closeBulk"
          class="bg-gray-600 px-4 py-2 rounded-lg hover:bg-gray-700">Cancel</button>
        <button id="confirmBulk"
          class="bg-green-600 px-4 py-2 rounded-lg hover:bg-green-700">Add All Channels</button>
      </div>
    </div>
  </div>

  <!-- Firebase + Script -->
  <script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/10.12.3/firebase-app.js";
    import { getDatabase, ref, push, set } from "https://www.gstatic.com/firebasejs/10.12.3/firebase-database.js";
    import { getAuth } from "https://www.gstatic.com/firebasejs/10.12.3/firebase-auth.js";

    const firebaseConfig = {
      apiKey: "AIzaSyB9GaCbYFH22WbiLs1pc_UJTsM_0Tetj6E",
      authDomain: "tnm3ulive.firebaseapp.com",
      databaseURL: "https://tnm3ulive-default-rtdb.asia-southeast1.firebasedatabase.app",
      projectId: "tnm3ulive",
      storageBucket: "tnm3ulive.appspot.com",
      messagingSenderId: "80664356882",
      appId: "1:80664356882:web:c8464819b0515ec9b210cb"
    };

    const app = initializeApp(firebaseConfig);
    const db = getDatabase(app);
    const auth = getAuth(app);

    const openModalBtn = document.getElementById("openModalBtn");
    const modal = document.getElementById("bulkModal");
    const closeBulk = document.getElementById("closeBulk");
    const confirmBulk = document.getElementById("confirmBulk");
    const bulkFile = document.getElementById("bulkFile");
    const bulkPreview = document.getElementById("bulkPreview");
    const channelsUrl = document.getElementById("channelsUrl");
    const fetchUrlBtn = document.getElementById("fetchUrlBtn");

    let bulkData = [];

    // Open modal
    openModalBtn.onclick = () => modal.classList.remove("hidden");

    closeBulk.onclick = () => {
      modal.classList.add("hidden");
      bulkPreview.innerHTML = "";
      bulkData = [];
      channelsUrl.value = "";
      bulkFile.value = "";
    };

    // File Upload Handler
    bulkFile.addEventListener("change", async () => {
      const file = bulkFile.files[0];
      if (!file) return;
      const text = await file.text();
      processInputText(file.name, text);
    });

    // URL Fetch Handler
    fetchUrlBtn.addEventListener("click", async () => {
      const url = channelsUrl.value.trim();
      if (!url) return alert("Please enter a valid URL");
      try {
        const res = await fetch(url);
        const text = await res.text();
        const ext = url.split('.').pop().toLowerCase();
        processInputText(ext, text);
      } catch(e) { alert("Failed to fetch channels"); }
    });

    function processInputText(filename, text) {
      let parsed = [];

      if (filename.endsWith(".json")) {
        parsed = JSON.parse(text);
      } else if (filename.endsWith(".txt")) {
        parsed = text.split("\n").map(l => l.trim()).filter(l => l).map(line => {
          const [name, stream, icon] = line.split(",");
          return { name, stream, icon };
        });
      } else if (filename.endsWith(".m3u")) {
        const lines = text.split("\n").map(l => l.trim());
        for (let i = 0; i < lines.length; i++) {
          if (lines[i].startsWith("#EXTINF")) {
            const nameMatch = lines[i].split(",")[1] || "Unknown";
            const logoMatch = lines[i].match(/tvg-logo="([^"]+)"/);
            const stream = lines[i + 1];
            parsed.push({ name: nameMatch, stream, icon: logoMatch ? logoMatch[1] : "" });
          }
        }
      }

      bulkData = parsed.filter(ch => ch.name && ch.stream);
      renderBulkPreview();
    }

    function renderBulkPreview() {
      bulkPreview.innerHTML = "";
      bulkData.forEach((ch, i) => {
        const tr = document.createElement("tr");
        tr.innerHTML = `
          <td class="p-2"><img src="${ch.icon || ''}" class="w-10 h-10 object-contain rounded"/></td>
          <td class="p-2"><input value="${ch.name}" class="bg-[#121212] w-full border border-gray-600 rounded p-1"/></td>
          <td class="p-2"><input value="${ch.stream}" class="bg-[#121212] w-full border border-gray-600 rounded p-1"/></td>
          <td class="p-2 text-center"><button class="delete bg-red-600 px-3 py-1 rounded hover:bg-red-700">Delete</button></td>
        `;
        tr.querySelector(".delete").onclick = () => { bulkData.splice(i, 1); renderBulkPreview(); };
        bulkPreview.appendChild(tr);
      });
    }

    confirmBulk.onclick = async () => {
      if (!bulkData.length) return alert("No channels to upload");
      confirmBulk.disabled = true;
      for (const ch of bulkData) {
        const channelRef = push(ref(db, "channels"));
        await set(channelRef, {
          name: ch.name.trim(),
          icon: ch.icon || "",
          stream: ch.stream.trim(),
          category: "Entertainment",
          channelType: "Entertainment",
          language: "Tamil",
          country: "India",
          tags: "bulk,tnm3u,live",
          description: `Watch ${ch.name} live on tnm3u.live.`,
          createdAt: new Date().toISOString(),
          createdBy: auth.currentUser ? auth.currentUser.email || "Bulk Admin" : "Bulk Admin"
        });
      }
      alert("✅ Channels added successfully!");
      modal.classList.add("hidden");
      confirmBulk.disabled = false;
      bulkPreview.innerHTML = "";
      bulkData = [];
    };
  </script>
</body>
</html>
