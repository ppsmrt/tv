<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="utf-8"/>
  <meta name="viewport" content="width=device-width, initial-scale=1"/>
  <title>Channel Manager</title>

  <meta name="robots" content="noindex, nofollow"/>

  <!-- Tailwind CSS -->
  <script src="https://cdn.tailwindcss.com"></script>
  <link href="https://fonts.googleapis.com/css2?family=Baloo+2&display=swap" rel="stylesheet">
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.0/css/all.min.css"/>
  <link href="https://fonts.googleapis.com/css2?family=Material+Symbols+Outlined" rel="stylesheet">
  <style>
    body { font-family: 'Baloo 2', cursive; }
    .collapsible { max-height: 0; overflow: hidden; transition: max-height 0.4s ease; }
    .modal-bg { background-color: rgba(0,0,0,0.6); }
  </style>
</head>
<body class="bg-[#121212] text-white w-screen h-screen flex flex-col">

  <!-- Header -->
  <div id="header"></div>
  
  <!-- Content -->
  <div class="flex-1 flex flex-col md:flex-row overflow-hidden">

    <!-- Left: Form -->
    <div class="w-full md:w-1/2 p-5 bg-[#1E1E1E] shadow-lg overflow-y-auto rounded-xl">
      <form id="channelForm" class="grid gap-4 md:grid-cols-2">
        <input type="hidden" id="channelId"/>

        <!-- Essentials -->
        <div>
          <label class="block text-gray-300 font-semibold mb-1">Channel Name</label>
          <input type="text" id="name" required
            class="w-full px-4 py-2 border border-gray-600 bg-[#121212] text-white rounded-lg focus:ring-2 focus:ring-yellow-400 focus:outline-none"/>
        </div>

        <div>
          <label class="block text-gray-300 font-semibold mb-1">Upload Icon</label>
          <div class="relative">
            <input type="file" id="uploadIcon" accept="image/*"
              class="absolute inset-0 w-full h-full opacity-0 cursor-pointer"/>
            <div class="flex items-center justify-center gap-2 bg-gradient-to-r from-[#d92a1a] to-[#ff4a3f] text-white font-bold py-2 px-4 rounded-xl shadow-lg hover:shadow-xl transition-all cursor-pointer select-none">
              <i class="fa-solid fa-upload"></i> Choose Image
            </div>
          </div>
          <input type="hidden" id="icon" name="icon"/>
          <p id="uploadStatus" class="text-sm text-gray-400 mt-1"></p>
        </div>

        <div>
          <label class="block text-gray-300 font-semibold mb-1">Stream URL</label>
          <input type="url" id="stream" required
            class="w-full px-4 py-2 border border-gray-600 bg-[#121212] text-white rounded-lg focus:ring-2 focus:ring-yellow-400 focus:outline-none"/>
        </div>

        <div>
          <label class="block text-gray-300 font-semibold mb-1">Category</label>
          <select id="category" required
            class="w-full px-4 py-2 border border-gray-600 bg-[#121212] text-white rounded-lg focus:ring-2 focus:ring-yellow-400 focus:outline-none">
            <option value="Tamil">Tamil</option>
            <option value="Telugu">Telugu</option>
            <option value="Malayalam">Malayalam</option>
            <option value="Hindi">Hindi</option>
            <option value="English">English</option>
            <option value="Entertainment">Entertainment</option>
            <option value="Movies">Movies</option>
            <option value="Music">Music</option>
            <option value="Sports">Sports</option>
            <option value="Kids">Kids</option>
          </select>
        </div>

        <!-- Collapsible Info -->
        <div class="md:col-span-2">
          <button type="button" id="toggleInfo"
            class="w-full flex items-center justify-between bg-[#1E1E1E] px-4 py-2 rounded-lg font-semibold text-gray-300 hover:bg-gray-700 transition">
            Channel Info
            <i id="infoIcon" class="fa-solid fa-chevron-down"></i>
          </button>

          <div id="extraInfo" class="collapsible mt-3 grid gap-4 md:grid-cols-2">
            <div>
              <label class="block text-gray-300 font-semibold mb-1">Channel Type</label>
              <select id="channelType" required
                class="w-full px-4 py-2 border border-gray-600 bg-[#121212] text-white rounded-lg focus:ring-2 focus:ring-yellow-400 focus:outline-none">
                <option value="Entertainment">Entertainment</option>
                <option value="News">News</option>
                <option value="Movies">Movies</option>
                <option value="Music">Music</option>
                <option value="Sports">Sports</option>
              </select>
            </div>

            <div>
              <label class="block text-gray-300 font-semibold mb-1">Language</label>
              <select id="language"
                class="w-full px-4 py-2 border border-gray-600 bg-[#121212] text-white rounded-lg focus:ring-2 focus:ring-yellow-400 focus:outline-none">
                <option value="Tamil">Tamil</option>
                <option value="Telugu">Telugu</option>
                <option value="Malayalam">Malayalam</option>
                <option value="Hindi">Hindi</option>
                <option value="English">English</option>
              </select>
            </div>

            <div>
              <label class="block text-gray-300 font-semibold mb-1">Country</label>
              <input type="text" id="country" value="India"
                class="w-full px-4 py-2 border border-gray-600 bg-[#121212] text-white rounded-lg focus:ring-2 focus:ring-yellow-400 focus:outline-none"/>
            </div>

            <div>
              <label class="block text-gray-300 font-semibold mb-1">Tags</label>
              <input type="text" id="tags" placeholder="News,Sports,etc."
                class="w-full px-4 py-2 border border-gray-600 bg-[#121212] text-white rounded-lg focus:ring-2 focus:ring-yellow-400 focus:outline-none"/>
            </div>

            <div class="md:col-span-2">
              <label class="block text-gray-300 font-semibold mb-1">Description</label>
              <textarea id="description" rows="3"
                class="w-full px-4 py-2 border border-gray-600 bg-[#121212] text-white rounded-lg focus:ring-2 focus:ring-yellow-400 focus:outline-none"></textarea>
            </div>
          </div>
        </div>

        <!-- Submit + Bulk Upload -->
        <div class="col-span-2 flex gap-3">
          <button type="submit" id="submitBtn"
            class="flex-1 bg-[#d92a1a] text-white font-bold py-3 rounded-xl shadow-md hover:bg-red-700 transition">
            <i class="fa-solid fa-save mr-2"></i> Save Channel
          </button>
          <button type="button" id="bulkUploadBtn"
            class="flex-1 bg-[#ffb400] text-black font-bold py-3 rounded-xl shadow-md hover:bg-yellow-400 transition">
            <i class="fa-solid fa-upload mr-2"></i> Bulk Upload
          </button>
        </div>
      </form>
    </div>

    <!-- Right: Channel List -->
    <div class="flex-1 flex flex-col overflow-hidden">
      <div class="p-5 bg-[#1E1E1E] flex justify-between rounded-xl">
        <h2 class="text-xl font-bold text-white">Channels</h2>
      </div>
      <div id="channelList" class="flex-1 overflow-y-auto p-5 grid grid-cols-1 md:grid-cols-2 gap-4"></div>
    </div>
  </div>

  <!-- Bulk Upload Modal -->
  <div id="bulkModal" class="hidden fixed inset-0 flex items-center justify-center modal-bg z-50">
    <div class="bg-[#1E1E1E] rounded-xl p-6 w-11/12 md:w-3/4 max-h-[90vh] overflow-y-auto">
      <h2 class="text-2xl font-bold mb-4">Bulk Upload Channels</h2>
      <input type="file" id="bulkFile" accept=".txt,.json,.m3u"
        class="mb-4 w-full bg-[#121212] text-white border border-gray-600 rounded-lg p-2"/>
      <table class="w-full text-left border border-gray-700 mb-4">
        <thead>
          <tr class="bg-gray-800">
            <th class="p-2">Icon</th>
            <th class="p-2">Name</th>
            <th class="p-2">Stream</th>
            <th class="p-2">Actions</th>
          </tr>
        </thead>
        <tbody id="bulkPreview" class="divide-y divide-gray-700"></tbody>
      </table>
      <div class="flex justify-end gap-3">
        <button id="closeBulk"
          class="bg-gray-600 px-4 py-2 rounded-lg hover:bg-gray-700">Cancel</button>
        <button id="confirmBulk"
          class="bg-green-600 px-4 py-2 rounded-lg hover:bg-green-700">Add All Channels</button>
      </div>
    </div>
  </div>

  <!-- Firebase + Script -->
  <script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/10.12.3/firebase-app.js";
    import { getDatabase, ref, push, set } from "https://www.gstatic.com/firebasejs/10.12.3/firebase-database.js";
    import { getAuth } from "https://www.gstatic.com/firebasejs/10.12.3/firebase-auth.js";

    const firebaseConfig = {
      apiKey: "AIzaSyB9GaCbYFH22WbiLs1pc_UJTsM_0Tetj6E",
      authDomain: "tnm3ulive.firebaseapp.com",
      databaseURL: "https://tnm3ulive-default-rtdb.asia-southeast1.firebasedatabase.app",
      projectId: "tnm3ulive",
      storageBucket: "tnm3ulive.appspot.com",
      messagingSenderId: "80664356882",
      appId: "1:80664356882:web:c8464819b0515ec9b210cb"
    };

    const app = initializeApp(firebaseConfig);
    const db = getDatabase(app);
    const auth = getAuth(app);

    const bulkBtn = document.getElementById("bulkUploadBtn");
    const modal = document.getElementById("bulkModal");
    const closeBulk = document.getElementById("closeBulk");
    const confirmBulk = document.getElementById("confirmBulk");
    const bulkFile = document.getElementById("bulkFile");
    const bulkPreview = document.getElementById("bulkPreview");
    let bulkData = [];

    bulkBtn.onclick = () => modal.classList.remove("hidden");
    closeBulk.onclick = () => { modal.classList.add("hidden"); bulkPreview.innerHTML = ""; bulkData = []; bulkFile.value = ""; };

    bulkFile.addEventListener("change", async () => {
      const file = bulkFile.files[0];
      if (!file) return;
      const text = await file.text();
      let parsed = [];

      if (file.name.endsWith(".json")) {
        parsed = JSON.parse(text);
      } else if (file.name.endsWith(".txt")) {
        parsed = text.split("\n").map(l => l.trim()).filter(l => l).map(line => {
          const [name, stream, icon] = line.split(",");
          return { name, stream, icon };
        });
      } else if (file.name.endsWith(".m3u")) {
        const lines = text.split("\n").map(l => l.trim());
        for (let i = 0; i < lines.length; i++) {
          if (lines[i].startsWith("#EXTINF")) {
            const nameMatch = lines[i].split(",")[1] || "Unknown";
            const logoMatch = lines[i].match(/tvg-logo="([^"]+)"/);
            const stream = lines[i + 1];
            parsed.push({ name: nameMatch, stream, icon: logoMatch ? logoMatch[1] : "" });
          }
        }
      }

      bulkData = parsed.filter(ch => ch.name && ch.stream);
      renderBulkPreview();
    });

    function renderBulkPreview() {
      bulkPreview.innerHTML = "";
      bulkData.forEach((ch, i) => {
        const tr = document.createElement("tr");
        tr.innerHTML = `
          <td class="p-2"><img src="${ch.icon || ''}" class="w-10 h-10 object-contain rounded"/></td>
          <td class="p-2"><input value="${ch.name}" class="bg-[#121212] w-full border border-gray-600 rounded p-1"/></td>
          <td class="p-2"><input value="${ch.stream}" class="bg-[#121212] w-full border border-gray-600 rounded p-1"/></td>
          <td class="p-2 text-center"><button class="delete bg-red-600 px-3 py-1 rounded hover:bg-red-700">Delete</button></td>
        `;
        tr.querySelector(".delete").onclick = () => { bulkData.splice(i, 1); renderBulkPreview(); };
        bulkPreview.appendChild(tr);
      });
    }

    confirmBulk.onclick = async () => {
      if (!bulkData.length) return alert("No channels to upload");
      confirmBulk.disabled = true;
      for (const ch of bulkData) {
        const channelRef = push(ref(db, "channels"));
        await set(channelRef, {
          name: ch.name.trim(),
          icon: ch.icon || "",
          stream: ch.stream.trim(),
          category: "Entertainment",
          channelType: "Entertainment",
          language: "Tamil",
          country: "India",
          tags: "bulk,tnm3u,live",
          description: `Watch ${ch.name} live on tnm3u.live.`,
          createdAt: new Date().toISOString(),
          createdBy: auth.currentUser ? auth.currentUser.email || "Bulk Admin" : "Bulk Admin"
        });
      }
      alert("âœ… Bulk upload completed!");
      modal.classList.add("hidden");
      confirmBulk.disabled = false;
      bulkPreview.innerHTML = "";
      bulkData = [];
    };
  </script>
</body>
</html>
