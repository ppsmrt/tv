<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="utf-8"/>
  <meta name="viewport" content="width=device-width, initial-scale=1"/>
  <title>TNM3U Admin Panel</title>

  <meta name="robots" content="noindex, nofollow"/>
  <script src="https://cdn.tailwindcss.com"></script>
  <link href="https://fonts.googleapis.com/css2?family=Baloo+2&display=swap" rel="stylesheet">
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.0/css/all.min.css"/>
  <style>
    body { font-family: 'Baloo 2', cursive; }
  </style>
</head>
<body class="bg-[#121212] text-white w-screen h-screen flex flex-col">

  <!-- Header -->
  <div id="header"></div>

  <div class="flex-1 flex flex-col md:flex-row overflow-hidden">

    <!-- Left: Bulk Upload -->
    <div class="w-full md:w-1/2 p-5 bg-[#1E1E1E] shadow-lg overflow-y-auto rounded-xl space-y-6">
      <div class="bg-gray-800 p-4 rounded-xl space-y-3">
        <h2 class="text-lg font-bold mb-2">üì• Bulk Playlist Upload</h2>

        <div>
          <label class="block text-gray-300 font-semibold mb-1">Playlist URL</label>
          <input type="url" id="playlistUrl" placeholder="https://example.com/playlist.m3u"
            class="w-full p-2 rounded bg-gray-700 text-white border border-gray-600 focus:ring-1 focus:ring-blue-400"/>
          <button id="fetchBtn"
            class="w-full mt-2 bg-blue-600 hover:bg-blue-700 font-semibold py-2 px-4 rounded-lg transition">Fetch & Preview</button>
        </div>

        <div class="flex items-center justify-center text-gray-500">‚Äî OR ‚Äî</div>

        <div>
          <label class="block text-gray-300 font-semibold mb-1">Upload .m3u File</label>
          <input type="file" id="fileInput" accept=".m3u"
            class="w-full p-2 rounded bg-gray-700 text-white border border-gray-600"/>
          <button id="uploadBtn"
            class="w-full mt-2 bg-green-600 hover:bg-green-700 font-semibold py-2 px-4 rounded-lg transition">Upload & Preview</button>
        </div>

        <p id="bulkStatus" class="text-gray-400 mt-2 text-sm"></p>
      </div>
    </div>

    <!-- Right: Channel List -->
    <div class="flex-1 flex flex-col overflow-hidden">
      <div class="p-5 bg-[#1E1E1E] flex flex-col md:flex-row gap-4 md:items-center justify-between rounded-xl">
        <div class="flex gap-3">
          <select id="filterCategory" class="px-4 py-2 border border-gray-600 bg-[#121212] text-white rounded-lg focus:ring-2 focus:ring-yellow-400 focus:outline-none">
            <option value="All">All Categories</option>
            <option value="Tamil">Tamil</option>
            <option value="News">News</option>
            <option value="Movies">Movies</option>
            <option value="Music">Music</option>
          </select>
        </div>
        <input id="searchInput" placeholder="Search by name" class="px-4 py-2 bg-[#121212] border border-gray-600 rounded-lg focus:ring-2 focus:ring-yellow-400"/>
        <select id="sortOption" class="px-4 py-2 border border-gray-600 bg-[#121212] text-white rounded-lg focus:ring-2 focus:ring-yellow-400 focus:outline-none">
          <option value="latest">Latest</option>
          <option value="oldest">Oldest</option>
          <option value="az">A-Z</option>
        </select>
        <button id="logoutBtn" class="bg-red-600 px-4 py-2 rounded-lg hover:bg-red-700 text-white font-semibold">Logout</button>
      </div>
      <div class="flex-1 overflow-y-auto p-5">
        <h2 class="text-xl font-bold text-white mb-4">Channels</h2>
        <div id="channelList" class="grid grid-cols-1 md:grid-cols-2 gap-4"></div>
      </div>
    </div>
  </div>

  <!-- Modal for Bulk Editing / Channel Editing -->
  <div id="editModal" class="hidden fixed inset-0 bg-black bg-opacity-60 flex items-center justify-center z-50">
    <div class="bg-gray-800 rounded-2xl shadow-2xl p-6 w-full max-w-3xl max-h-[80vh] overflow-y-auto">
      <h2 class="text-xl font-bold mb-4 text-center">üìù Review & Edit Channels</h2>
      <table class="w-full text-sm text-left border-collapse border border-gray-700">
        <thead class="bg-gray-700">
          <tr>
            <th class="p-2 border border-gray-600 w-10">#</th>
            <th class="p-2 border border-gray-600">Name</th>
            <th class="p-2 border border-gray-600">URL</th>
            <th class="p-2 border border-gray-600 w-24 text-center">Status</th>
            <th class="p-2 border border-gray-600 w-16 text-center">Action</th>
          </tr>
        </thead>
        <tbody id="channelTable"></tbody>
      </table>
      <div class="flex justify-end gap-3 mt-5">
        <button id="cancelBtn" class="bg-gray-600 hover:bg-gray-700 px-4 py-2 rounded-lg font-semibold">Cancel</button>
        <button id="saveBtn" class="bg-blue-600 hover:bg-blue-700 px-4 py-2 rounded-lg font-semibold">Save to Database</button>
      </div>
    </div>
  </div>

  <script>// Firebase imports
import { initializeApp } from "https://www.gstatic.com/firebasejs/10.12.3/firebase-app.js";
import { 
  getDatabase, ref, set, push, onValue, update, remove 
} from "https://www.gstatic.com/firebasejs/10.12.3/firebase-database.js";
import { 
  getAuth, signOut 
} from "https://www.gstatic.com/firebasejs/10.12.3/firebase-auth.js";

// =============================
// üîß Firebase Configuration
// =============================
const firebaseConfig = {
  apiKey: "YOUR_API_KEY",
  authDomain: "YOUR_DOMAIN",
  databaseURL: "YOUR_DB_URL",
  projectId: "YOUR_PROJECT_ID",
  storageBucket: "YOUR_BUCKET",
  messagingSenderId: "YOUR_MSG_SENDER_ID",
  appId: "YOUR_APP_ID",
};

const app = initializeApp(firebaseConfig);
const db = getDatabase(app);
const auth = getAuth(app);

// =============================
// üß© DOM Elements
// =============================
const playlistUrl = document.getElementById("playlistUrl");
const fileInput = document.getElementById("fileInput");
const fetchBtn = document.getElementById("fetchBtn");
const uploadBtn = document.getElementById("uploadBtn");
const bulkStatus = document.getElementById("bulkStatus");
const editModal = document.getElementById("editModal");
const channelTable = document.getElementById("channelTable");
const cancelBtn = document.getElementById("cancelBtn");
const saveBtn = document.getElementById("saveBtn");
const channelList = document.getElementById("channelList");
const searchInput = document.getElementById("searchInput");
const filterCategory = document.getElementById("filterCategory");
const sortOption = document.getElementById("sortOption");
const logoutBtn = document.getElementById("logoutBtn");

let previewChannels = [];
let allChannels = [];

// =============================
// üîå Fetch Channels from Firebase
// =============================
function loadChannels() {
  const channelsRef = ref(db, "drm");
  onValue(channelsRef, (snapshot) => {
    const data = snapshot.val() || {};
    allChannels = Object.entries(data).map(([id, ch]) => ({ id, ...ch }));
    renderChannelList();
  });
}

// =============================
// üß† Render Channels in UI
// =============================
function renderChannelList() {
  const searchValue = searchInput.value.toLowerCase();
  const category = filterCategory.value;
  const sort = sortOption.value;

  let filtered = allChannels.filter(ch => {
    const matchesCategory = category === "All" || (ch.category || "").includes(category);
    const matchesSearch = (ch.name || "").toLowerCase().includes(searchValue);
    return matchesCategory && matchesSearch;
  });

  if (sort === "latest") filtered.reverse();
  else if (sort === "az") filtered.sort((a, b) => (a.name || "").localeCompare(b.name || ""));

  channelList.innerHTML = filtered.map(ch => `
    <div class="bg-gray-800 p-4 rounded-xl shadow-md hover:shadow-lg transition">
      <div class="flex justify-between items-center mb-2">
        <h3 class="text-lg font-bold">${ch.name || "Unnamed"}</h3>
        <div class="flex gap-2">
          <button class="edit-btn text-yellow-400 hover:text-yellow-500" data-id="${ch.id}">
            <i class="fa-solid fa-pen-to-square"></i>
          </button>
          <button class="delete-btn text-red-500 hover:text-red-600" data-id="${ch.id}">
            <i class="fa-solid fa-trash"></i>
          </button>
        </div>
      </div>
      <p class="text-sm text-gray-400 truncate">${ch.url || ""}</p>
      <p class="text-xs text-gray-500 mt-1">${ch.category || "Uncategorized"}</p>
    </div>
  `).join("");

  document.querySelectorAll(".delete-btn").forEach(btn => {
    btn.onclick = () => deleteChannel(btn.dataset.id);
  });
  document.querySelectorAll(".edit-btn").forEach(btn => {
    btn.onclick = () => openEditModal(btn.dataset.id);
  });
}

// =============================
// üßπ Delete Channel
// =============================
function deleteChannel(id) {
  if (!confirm("Delete this channel?")) return;
  remove(ref(db, `drm/${id}`));
}

// =============================
// ‚úèÔ∏è Edit Channel
// =============================
function openEditModal(id) {
  const ch = allChannels.find(c => c.id === id);
  if (!ch) return;

  previewChannels = [{ id, ...ch }];
  renderPreviewTable();
  editModal.classList.remove("hidden");
}

// =============================
// üìã Bulk Upload & Parse
// =============================
fetchBtn.onclick = async () => {
  const url = playlistUrl.value.trim();
  if (!url) return alert("Please enter a valid playlist URL.");
  bulkStatus.textContent = "Fetching playlist...";
  try {
    const res = await fetch(url);
    const text = await res.text();
    previewChannels = parseM3U(text);
    renderPreviewTable();
    editModal.classList.remove("hidden");
    bulkStatus.textContent = `Loaded ${previewChannels.length} channels.`;
  } catch {
    bulkStatus.textContent = "‚ùå Failed to fetch playlist.";
  }
};

uploadBtn.onclick = async () => {
  const file = fileInput.files[0];
  if (!file) return alert("Please select an .m3u file.");
  bulkStatus.textContent = "Reading file...";
  const text = await file.text();
  previewChannels = parseM3U(text);
  renderPreviewTable();
  editModal.classList.remove("hidden");
  bulkStatus.textContent = `Loaded ${previewChannels.length} channels.`;
};

// =============================
// üìú M3U Parser
// =============================
function parseM3U(text) {
  const lines = text.split("\n");
  const result = [];
  let current = {};

  lines.forEach(line => {
    line = line.trim();
    if (line.startsWith("#EXTINF")) {
      const name = line.split(",").pop();
      const categoryMatch = line.match(/group-title="(.*?)"/i);
      current = { name, category: categoryMatch ? categoryMatch[1] : "Other" };
    } else if (line && !line.startsWith("#")) {
      current.url = line;
      result.push(current);
    }
  });
  return result;
}

// =============================
// üìã Render Preview Table
// =============================
function renderPreviewTable() {
  channelTable.innerHTML = previewChannels.map((ch, i) => `
    <tr class="hover:bg-gray-700 transition">
      <td class="p-2 border border-gray-600">${i + 1}</td>
      <td class="p-2 border border-gray-600">
        <input type="text" class="w-full bg-gray-700 text-white rounded p-1"
          value="${ch.name || ""}" data-index="${i}" data-field="name"/>
      </td>
      <td class="p-2 border border-gray-600">
        <input type="text" class="w-full bg-gray-700 text-white rounded p-1"
          value="${ch.url || ""}" data-index="${i}" data-field="url"/>
      </td>
      <td class="p-2 border border-gray-600 text-center">
        <input type="text" class="bg-gray-700 text-white rounded p-1 w-full text-center"
          value="${ch.category || ""}" data-index="${i}" data-field="category"/>
      </td>
      <td class="p-2 border border-gray-600 text-center">
        <button class="remove-row text-red-500 hover:text-red-600" data-index="${i}">
          <i class="fa-solid fa-trash"></i>
        </button>
      </td>
    </tr>
  `).join("");

  // input changes
  channelTable.querySelectorAll("input").forEach(inp => {
    inp.oninput = e => {
      const i = e.target.dataset.index;
      const field = e.target.dataset.field;
      previewChannels[i][field] = e.target.value;
    };
  });

  // row removal
  channelTable.querySelectorAll(".remove-row").forEach(btn => {
    btn.onclick = () => {
      previewChannels.splice(btn.dataset.index, 1);
      renderPreviewTable();
    };
  });
}

// =============================
// üíæ Save Channels to Firebase
// =============================
saveBtn.onclick = async () => {
  if (previewChannels.length === 0) return alert("No channels to save.");
  for (const ch of previewChannels) {
    if (ch.id) {
      await update(ref(db, `drm/${ch.id}`), ch);
    } else {
      const newRef = push(ref(db, "drm"));
      await set(newRef, ch);
    }
  }
  alert("‚úÖ Channels saved successfully!");
  editModal.classList.add("hidden");
};

// =============================
// ‚ùå Cancel Modal
// =============================
cancelBtn.onclick = () => editModal.classList.add("hidden");

// =============================
// üîç Filters
// =============================
searchInput.oninput = renderChannelList;
filterCategory.onchange = renderChannelList;
sortOption.onchange = renderChannelList;

// =============================
// üö™ Logout
// =============================
logoutBtn.onclick = () => {
  signOut(auth).then(() => {
    window.location.href = "login.html";
  });
};

// =============================
// üöÄ Init
// =============================
loadChannels();
  </script>
</body>
</html>
