name: Convert JSON to M3U

on:
  workflow_dispatch:    # Manual trigger
  schedule:
    - cron: "0 * * * *"  # Every hour, optional

jobs:
  convert-playlist:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Set up Node.js
        uses: actions/setup-node@v3
        with:
          node-version: "20"

      - name: Install dependencies
        run: npm init -y

      - name: Convert JSON playlist to M3U
        run: |
          node << 'EOF'
          const fs = require('fs');
          const path = 'assets/playlist/bmcloud.m3u';
          const outputPath = 'assets/playlist/test.m3u';

          // Read JSON playlist (assumes valid JSON array)
          const rawData = fs.readFileSync(path, 'utf8');
          const playlistData = JSON.parse(rawData);

          let m3uContent = '#EXTM3U\n';

          for (const item of playlistData) {
            m3uContent += `#EXTINF:-1 tvg-id="${item.id}" tvg-name="${item.name}" tvg-logo="${item.imageurl}" group-title="TV",${item.name}\n`;
            m3uContent += `${item.videourl}\n`;
          }

          // Ensure output directory exists
          fs.mkdirSync('assets/playlist', { recursive: true });

          fs.writeFileSync(outputPath, m3uContent, 'utf8');
          console.log(`M3U playlist generated at ${outputPath}`);
          EOF

      - name: Commit & push generated M3U
        run: |
          git config --local user.email "github-actions[bot]@users.noreply.github.com"
          git config --local user.name "github-actions[bot]"
          git add assets/playlist/test.m3u
          git commit -m "Auto-generate M3U playlist"
          git push
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
          
