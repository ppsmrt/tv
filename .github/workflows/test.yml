name: Auto-update playlist

on:
  schedule:
    - cron: "0 0 * * *" # every day at 00:00 UTC
  workflow_dispatch:

jobs:
  update-playlist:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout repo
        uses: actions/checkout@v4

      - name: Set up Python
        uses: actions/setup-python@v4
        with:
          python-version: "3.11"

      - name: Install dependencies
        run: |
          python -m pip install --upgrade pip
          pip install requests

      - name: Fetch, decode and write playlist
        run: |
          mkdir -p assets/playlist
          python - <<'PY'
import requests, base64, json, urllib.parse, zlib, gzip, os

API_URL = "https://bmcloud.in/apis/apps/bmcloudapi.php?id=bmcloud"
OUTPUT_FILE = "assets/playlist/test.m3u"

def try_decode_level6(data, max_level=6):
    for _ in range(max_level):
        # try JSON
        try:
            return json.loads(data)
        except:
            pass

        # try base64
        try:
            b = base64.b64decode(data, validate=True)
            if b != data.encode('utf-8', errors='ignore'):
                data = b.decode('utf-8', errors='ignore')
                continue
        except:
            pass

        # try url decode
        ud = urllib.parse.unquote_plus(data)
        if ud != data:
            data = ud
            continue

        # try gzip
        try:
            g = gzip.decompress(data.encode('latin1'))
            data = g.decode('utf-8', errors='ignore')
            continue
        except:
            pass

        # try zlib
        try:
            z = zlib.decompress(data.encode('latin1'))
            data = z.decode('utf-8', errors='ignore')
            continue
        except:
            pass

        break

    try:
        return json.loads(data)
    except:
        return data

def json_to_m3u(data):
    lines = ["#EXTM3U"]
    if isinstance(data, dict):
        items = data.get("channels") or data.get("items") or data.get("list") or []
    elif isinstance(data, list):
        items = data
    else:
        lines.append("# Unable to parse JSON structure; raw output follows as comment")
        lines.append("# RAW-START")
        lines.append(str(data))
        lines.append("# RAW-END")
        return "\n".join(lines)

    for it in items:
        if not isinstance(it, dict):
            continue
        name = it.get("name") or it.get("title") or it.get("channel") or "Unknown"
        url = it.get("url") or it.get("stream") or it.get("link") or ""
        logo = it.get("logo") or it.get("tvg-logo") or ""
        group = it.get("group") or it.get("group-title") or ""
        if not url:
            continue
        # sanitize
        logo_attr = logo.replace('"', "'") if isinstance(logo, str) else ""
        group_attr = group.replace('"', "'") if isinstance(group, str) else ""
        attrs = []
        if logo_attr:
            attrs.append(f'tvg-logo="{logo_attr}"')
        if group_attr:
            attrs.append(f'group-title="{group_attr}"')
        attrstr = " ".join(attrs)
        if attrstr:
            lines.append(f'#EXTINF:-1 {attrstr},{name}')
        else:
            lines.append(f'#EXTINF:-1,{name}')
        lines.append(url)
    return "\n".join(lines)

def fetch_and_save():
    try:
        resp = requests.get(API_URL, timeout=20)
        resp.raise_for_status()
        text = resp.text.strip()
        decoded = try_decode_level6(text)
        m3u = json_to_m3u(decoded)
        os.makedirs(os.path.dirname(OUTPUT_FILE), exist_ok=True)
        with open(OUTPUT_FILE, "w", encoding="utf-8") as f:
            f.write(m3u)
        print("Saved playlist to", OUTPUT_FILE)
    except Exception as e:
        print("Error:", e)
        with open(OUTPUT_FILE, "w", encoding="utf-8") as f:
            f.write("#EXTM3U\n")

if __name__ == "__main__":
    fetch_and_save()
PY

      - name: Commit and push changes
        env:
          GIT_AUTHOR_NAME: github-actions
          GIT_AUTHOR_EMAIL: actions@github.com
        run: |
          git config user.name "${GIT_AUTHOR_NAME}"
          git config user.email "${GIT_AUTHOR_EMAIL}"
          git add assets/playlist/test.m3u
          git commit -m "Auto-update playlist [$(date -u +'%Y-%m-%d %H:%M:%S UTC')]" || echo "No changes to commit"
          git push
