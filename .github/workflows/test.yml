name: Auto-update test.m3u

on:
  schedule:
    - cron: "*/15 * * * *" # every 15 minutes
  workflow_dispatch:

jobs:
  update-playlist:
    runs-on: ubuntu-latest

    steps:
      - name: 🛒 Checkout repo
        uses: actions/checkout@v4

      - name: 🐍 Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: "3.11"

      - name: 📦 Install dependencies
        run: |
          pip install requests

      - name: ⚙️ Fetch and save M3U
        id: generate
        run: |
          mkdir -p assets/playlist
          cat > fetch_m3u.py <<'EOF'
          import requests, os

          M3U_URL = "https://tv.tnm3us.workers.dev/"
          OUTPUT_M3U = "assets/playlist/test.m3u"

          def fetch_m3u():
              print(f"📡 Fetching {M3U_URL}")
              resp = requests.get(M3U_URL, timeout=20)
              resp.raise_for_status()
              os.makedirs(os.path.dirname(OUTPUT_M3U), exist_ok=True)
              with open(OUTPUT_M3U, "w", encoding="utf-8") as f:
                  f.write(resp.text)
              print(f"✅ M3U file saved: {OUTPUT_M3U}")

          if __name__ == "__main__":
              fetch_m3u()
          EOF

          python fetch_m3u.py

          if git diff --quiet assets/playlist/test.m3u; then
            echo "changed=false" >> $GITHUB_OUTPUT
          else
            echo "changed=true" >> $GITHUB_OUTPUT
          fi

      - name: 💾 Commit and push if changed
        if: steps.generate.outputs.changed == 'true'
        run: |
          git config user.name "github-actions[bot]"
          git config user.email "github-actions[bot]@users.noreply.github.com"
          git add assets/playlist/test.m3u
          git commit -m "Auto-update test.m3u [skip ci]"
          git push
