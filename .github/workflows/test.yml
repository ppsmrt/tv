name: Auto-update live.m3u

on:
  schedule:
    - cron: "*/5 * * * *" # Every 5 minutes
  workflow_dispatch:

jobs:
  update-playlist:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout repo
        uses: actions/checkout@v4

      - name: Install tools
        run: sudo apt-get update && sudo apt-get install -y curl gawk

      - name: Fetch, merge, and clean playlists
        run: |
          mkdir -p assets/playlist

          # Fetch both remote playlists
          curl -sL "https://tnm3u.live/assets/playlist/jiostar.m3u" -o jiostar.m3u
          curl -sL "https://tnm3u.live/assets/playlist/tp.m3u" -o tp.m3u

          # Normalize and inject group-title for JioStar
          awk -v group="Jio" '
            BEGIN {print "#EXTM3U"}
            /^#EXTINF/ {
              if ($0 !~ /group-title=/)
                sub(/#EXTINF:[^,]*/, "& group-title=\"" group "\"");
              else
                sub(/group-title=\"[^\"]*\"/, "group-title=\"" group "\"");
              print
              getline url
              print url
            }' jiostar.m3u > tmp_jiostar.m3u

          # Normalize and inject group-title for Tata Play
          awk -v group="Tata Play" '
            /^#EXTINF/ {
              if ($0 !~ /group-title=/)
                sub(/#EXTINF:[^,]*/, "& group-title=\"" group "\"");
              else
                sub(/group-title=\"[^\"]*\"/, "group-title=\"" group "\"");
              print
              getline url
              print url
            }' tp.m3u > tmp_tp.m3u

          # Merge and deduplicate based on URL
          echo "#EXTM3U" > merged.m3u
          awk '!seen[$0]++' tmp_jiostar.m3u tmp_tp.m3u >> merged.m3u

          # Sort alphabetically by channel name (after the comma)
          awk -v RS='' '
            BEGIN { ORS="\n" }
            {print $0 | "sort -t, -k2"}' merged.m3u > assets/playlist/live.m3u

      - name: Commit and push if updated
        run: |
          git config --global user.name "GitHub Action"
          git config --global user.email "actions@github.com"

          if [[ `git status --porcelain` ]]; then
            git add assets/playlist/live.m3u
            git commit -m "Auto-update live.m3u with group titles and sorting"
            git push
          else
            echo "No changes detected."
          fi
