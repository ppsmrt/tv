name: Auto-update main(TP/JIO).m3u

on:
  schedule:
    - cron: "*/5 * * * *" # Every 5 minutes
  workflow_dispatch:

jobs:
  update-playlist:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout repo
        uses: actions/checkout@v4

      - name: Install dependencies
        run: sudo apt-get update && sudo apt-get install -y curl gawk

      - name: Fetch, clean, and merge playlists
        run: |
          mkdir -p assets/playlist

          # Fetch both source playlists
          curl -sL "https://tnm3u.live/assets/playlist/jiostar.m3u" -o jiostar.m3u
          curl -sL "https://tnm3u.live/assets/playlist/tp.m3u" -o tp.m3u

          # ---- Process Jiostar ----
          awk -v group="Jiostar" '
            BEGIN { print "#EXTM3U" }
            /^#EXTINF/ {
              if ($0 !~ /group-title=/)
                sub(/#EXTINF:[^,]*/, "& group-title=\"" group "\"");
              else
                sub(/group-title=\"[^\"]*\"/, "group-title=\"" group "\"");
              print;
              nextline=1;
              next;
            }
            nextline==1 {
              print;
              nextline=0;
              next;
            }
            /^#KODIPROP/ || /^#EXTVLCOPT/ || /^#EXTHTTP/ { print; }
          ' jiostar.m3u > tmp_jiostar.m3u

          # ---- Process Tata Play ----
          awk -v group="Tata Play" '
            /^#EXTINF/ {
              if ($0 !~ /group-title=/)
                sub(/#EXTINF:[^,]*/, "& group-title=\"" group "\"");
              else
                sub(/group-title=\"[^\"]*\"/, "group-title=\"" group "\"");
              print;
              getline url;
              print url;
            }' tp.m3u > tmp_tp.m3u

          # ---- Merge, deduplicate by URL, and sort ----
          echo "#EXTM3U" > merged.m3u

          awk '
            BEGIN {RS=""; ORS="\n\n"}
            NR==FNR {block=$0; if (match($0, /(https?:[^\n]+)/, a)) {url=a[1]; if (!seen[url]++) print block}}
          ' tmp_jiostar.m3u tmp_tp.m3u | sort -t, -k2 > assets/playlist/live.m3u

      - name: Commit and push if updated
        run: |
          git config --global user.name "GitHub Action"
          git config --global user.email "actions@github.com"

          if [[ `git status --porcelain` ]]; then
            git add assets/playlist/live.m3u
            git commit -m "Auto-update live.m3u (Jiostar + Tata Play)"
            git push
          else
            echo "No changes detected."
          fi
