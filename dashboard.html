<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8"/>
<meta name="viewport" content="width=device-width, initial-scale=1.0, viewport-fit=cover"/>
<title>TamilGeo - Dashboard</title>

<!-- Tailwind CSS -->
<script src="https://cdn.tailwindcss.com"></script>

<!-- Material Icons -->
<link href="https://fonts.googleapis.com/icon?family=Material+Icons" rel="stylesheet"/>

<!-- Fav Icon -->
<link rel="icon" type="image/x-icon" href="assets/icon/favicon.ico">

<!-- Baloo 2 Font -->
<link href="https://fonts.googleapis.com/css2?family=Baloo+2&display=swap" rel="stylesheet"/>

<style>
  body {
    font-family: 'Baloo 2', cursive;
    background-color: #111827;
    color: #f9fafb;
    margin: 0;
    min-height: 100vh;
  }

  header {
    height: 64px;
    display: flex;
    align-items: center;
    padding: 0 1.5rem;
    background: rgba(31,41,55,0.95);
    box-shadow: 0 2px 8px rgba(0,0,0,0.5);
    z-index: 20;
  }

  main {
    padding: 20px 1rem 100px;
    max-width: 1200px;
    margin: 0 auto;
  }

  .stat-grid {
    display: grid;
    grid-template-columns: repeat(auto-fill,minmax(180px,1fr));
    gap: 20px;
    margin-bottom: 32px;
  }

  .stat-card {
    background: #1f2937;
    border-radius: 16px;
    padding: 1.5rem;
    display: flex;
    flex-direction: column;
    justify-content: space-between;
    box-shadow: 0 4px 12px rgba(0,0,0,0.5);
    transition: transform 0.3s ease, box-shadow 0.3s ease;
    cursor: pointer;
  }
  .stat-card:hover {
    transform: translateY(-6px);
    box-shadow: 0 8px 24px rgba(248, 113, 113, 0.5);
  }
  .stat-card h2 {
    font-size: 0.95rem;
    font-weight: 600;
    color: #f9fafb;
  }
  .stat-card p {
    font-size: 1.8rem;
    font-weight: 700;
    margin-top: 0.5rem;
  }

  .page-card {
    background: #1f2937;
    border-radius: 16px;
    display: flex;
    align-items: center;
    justify-content: space-between;
    padding: 0.75rem 1rem;
    margin-bottom: 8px;
    transition: background 0.3s ease;
    cursor: pointer;
  }
  .page-card:hover {
    background: #374151;
  }

  .welcome-card {
    background: #1f2937;
    border-radius: 16px;
    padding: 1.5rem;
    margin-bottom: 32px;
    display: flex;
    justify-content: space-between;
    align-items: center;
    box-shadow: 0 4px 12px rgba(0,0,0,0.5);
  }

  .welcome-card h1 {
    font-size: 2rem;
    font-weight: 700;
    color: #f9fafb;
  }
  .welcome-card p {
    color: #9ca3af;
    margin-top: 0.25rem;
  }

  .rounded-avatar {
    width: 56px;
    height: 56px;
    border-radius: 9999px;
    overflow: hidden;
    border: 2px solid #22c55e;
  }

  .section-heading {
    font-weight: 700;
    font-size: 1rem;
    padding: 0.5rem 1rem;
    border-radius: 12px 12px 0 0;
    margin-bottom: 8px;
    color: #fff;
  }

  .toast {
    position: fixed;
    bottom: 20px;
    right: 20px;
    min-width: 200px;
    padding: 12px 16px;
    border-radius: 12px;
    box-shadow: 0 4px 16px rgba(0,0,0,0.5);
    display: flex;
    align-items: center;
    justify-content: space-between;
    color: #f9fafb;
    font-weight: 500;
    background-color: #1f2937;
    opacity: 0;
    transform: translateY(20px);
    transition: opacity 0.3s ease, transform 0.3s ease;
    z-index: 9999;
  }
  .toast.show {
    opacity: 1;
    transform: translateY(0);
  }
  .toast.success { border-left: 4px solid #22c55e; }
  .toast.error { border-left: 4px solid #ef4444; }
</style>
</head>
<body>

<!-- Header -->
<div id="header"></div>

<main>
  <!-- Welcome -->
  <div class="welcome-card">
    <div>
      <h1 id="fullname">Loading...</h1>
      <p>Welcome back ðŸ‘‹</p>
    </div>
    <div class="rounded-avatar">
      <img src="https://via.placeholder.com/150" alt="Profile" class="w-full h-full object-cover">
    </div>
  </div>

  <!-- Stats -->
  <div class="stat-grid">
    <div class="stat-card" style="border-left: 4px solid #22c55e;">
      <h2>Likes</h2>
      <p id="likesCount">0</p>
      <i class="material-icons text-red-500 text-2xl">favorite</i>
    </div>
    <div class="stat-card" style="border-left: 4px solid #ef4444;">
      <h2>Reports</h2>
      <p id="reportsCount">0</p>
      <i class="material-icons text-red-500 text-2xl">report_problem</i>
    </div>
    <div class="stat-card" style="border-left: 4px solid #facc15;">
      <h2>Pending</h2>
      <p id="pendingCount">0</p>
      <i class="material-icons text-yellow-400 text-2xl">hourglass_top</i>
    </div>
    <div class="stat-card" style="border-left: 4px solid #3b82f6;">
      <h2>Approved</h2>
      <p id="approvedCount">None</p>
      <i class="material-icons text-blue-400 text-2xl">check_circle</i>
    </div>
  </div>

  <!-- Pages -->
  <div>
    <div class="section-heading" style="background: linear-gradient(90deg, #22c55e, #16a34a)">Site Pages</div>
    <div class="page-card"><span>About Us</span><i class="material-icons">chevron_right</i></div>
    <div class="page-card"><span>Contact Us</span><i class="material-icons">chevron_right</i></div>
    <div class="page-card"><span>Donate Us</span><i class="material-icons">chevron_right</i></div>
    <div class="page-card"><span>Disclaimer</span><i class="material-icons">chevron_right</i></div>
    <div class="page-card"><span>Privacy Policy</span><i class="material-icons">chevron_right</i></div>
    <div class="page-card"><span>Terms & Conditions</span><i class="material-icons">chevron_right</i></div>
  </div>

  <div style="margin-top:32px;">
    <div class="section-heading" style="background: linear-gradient(90deg,#3b82f6,#2563eb)">Account & Settings</div>
    <div class="page-card"><span>Edit Profile</span><i class="material-icons">chevron_right</i></div>
    <div class="page-card"><span>Change Password</span><i class="material-icons">chevron_right</i></div>
    <div class="page-card" id="logoutLink"><span>Log Out</span><i class="material-icons">chevron_right</i></div>
  </div>

<!-- Admin Section (hidden by default) -->
<div id="adminSection" style="margin-top:32px; display:none;">
  <div class="section-heading" style="background: linear-gradient(90deg,#3b82f6,#2563eb)">
    Channel Management
  </div>
  <div class="page-card" onclick="window.location.href='admin'">
    <span>Channel Manager</span>
    <i class="material-icons">chevron_right</i>
  </div>
  <div class="page-card" onclick="window.location.href='approve'">
    <span>Approve Channel</span>
    <i class="material-icons">chevron_right</i>
  </div>
</div>

<!-- Always show logout (for everyone) -->
<div class="page-card" id="logoutLink" style="margin-top:12px;">
  <span>Log Out</span>
  <i class="material-icons">chevron_right</i>
</div>

</main>

<!-- Footer -->
<div id="footer"></div>

<!-- JS Files -->
<script type="module" src="assets/js/header.js"></script>
<script type="module" src="assets/js/footer.js"></script>

<!-- Toast Container -->
<div id="toastContainer"></div>

<!-- Firebase & Dashboard Logic -->
<script type="module">
import { initializeApp } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-app.js";
import { getDatabase, ref, onValue } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-database.js";
import { getAuth, onAuthStateChanged, signOut } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-auth.js";

const firebaseConfig = {
  apiKey: "AIzaSyB9GaCbYFH22WbiLs1pc_UJTsM_0Tetj6E",
  authDomain: "tnm3ulive.firebaseapp.com",
  databaseURL: "https://tnm3ulive-default-rtdb.asia-southeast1.firebasedatabase.app",
  projectId: "tnm3ulive",
  storageBucket: "tnm3ulive.firebasestorage.app",
  messagingSenderId: "80664356882",
  appId: "1:80664356882:web:c8464819b0515ec9b210cb",
  measurementId: "G-FNS9JWZ9LS"
};

const app = initializeApp(firebaseConfig);
const db = getDatabase(app);
const auth = getAuth(app);

const likesEl = document.getElementById('likesCount');
const reportsEl = document.getElementById('reportsCount');
const pendingEl = document.getElementById('pendingCount');
const approvedEl = document.getElementById('approvedCount');
const fullnameEl = document.getElementById('fullname');
const toastContainer = document.getElementById('toastContainer');
const adminSection = document.getElementById('adminSection'); // hidden by default

function showToast(message, type='success'){
  const toast = document.createElement('div');
  toast.className = `toast ${type}`;
  toast.textContent = message;
  toastContainer.appendChild(toast);
  setTimeout(()=>toast.classList.add('show'),50);
  setTimeout(()=>{
    toast.classList.remove('show');
    setTimeout(()=>toast.remove(),300);
  },3000);
}

// ðŸ”¹ Auth state listener
onAuthStateChanged(auth, (user) => {
  if (user) {
    // Load fullname
    onValue(ref(db, 'users/' + user.uid), snapshot => {
      const data = snapshot.val();
      fullnameEl.textContent = data?.fullname || 'User';
    });

    // Check if this user is admin
    onValue(ref(db, 'admins/' + user.uid), snapshot => {
      if (snapshot.exists()) {
        adminSection.style.display = 'block'; // âœ… show for admins
      } else {
        adminSection.style.display = 'none'; // ðŸš« hide for normal users
      }
    });

  } else {
    fullnameEl.textContent = 'Guest';
    adminSection.style.display = 'none';
  }
});

// ðŸ”¹ Stats
onValue(ref(db, 'channels'), snapshot => {
  try {
    const channels = snapshot.val() || {};
    let likes = 0, pending = 0, approved = 0;
    Object.values(channels).forEach(c => {
      likes += c.likes || 0;
      if (c.status === 'pending') pending++;
      if (c.status === 'approved') approved++;
    });
    likesEl.textContent = likes;
    pendingEl.textContent = pending;
    approvedEl.textContent = approved || 'None';
  } catch (e) {
    showToast('Error loading stats', 'error');
  }
});

onValue(ref(db, 'reports'), snapshot => {
  try {
    const reports = snapshot.val() || {};
    reportsEl.textContent = Object.keys(reports).length;
  } catch (e) {
    showToast('Error loading reports', 'error');
  }
});

// ðŸ”¹ Logout
document.getElementById('logoutLink').addEventListener('click', e => {
  e.preventDefault();
  signOut(auth).then(() => {
    showToast('Logged out');
    setTimeout(() => window.location.href = '/', 1000);
  }).catch(err => {
    showToast('Logout failed: ' + err.message, 'error');
  });
});
</script>
</body>
</html>