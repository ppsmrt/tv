<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8"/>
<meta name="viewport" content="width=device-width, initial-scale=1, viewport-fit=cover"/>
<title>Live TV - Dashboard</title>

<script src="https://cdn.tailwindcss.com"></script>
<link href="https://fonts.googleapis.com/icon?family=Material+Icons" rel="stylesheet"/>
<link href="https://fonts.googleapis.com/css2?family=Baloo+2&display=swap" rel="stylesheet"/>

<style>
  html, body { font-family: 'Baloo 2', cursive; background-color: #111827; color: #fff; margin: 0; min-height: 100vh; }
  header { height: 64px; display: flex; align-items: center; padding: 0 1.5rem; background: rgba(31,41,55,0.9); box-shadow: 0 2px 8px rgba(0,0,0,0.5); z-index: 20; }
  main { padding: 20px 1rem 100px; max-width: 1200px; margin: 0 auto; }
  .hidden { display: none; }
  .channel-card { background: #1f2937; border-radius: 16px; padding:10px; margin-bottom:8px; display:flex; align-items:center; gap:10px; }
  .channel-card img { width:50px; height:50px; border-radius:8px; object-fit:cover; }
  select, input, button { width:100%; padding:8px; margin:4px 0; border-radius:6px; border:none; background:#1f2937; color:white; }
  button:hover{ background:#f87171; }
</style>
</head>
<body>

<header>
  <span class="material-icons">live_tv</span>
  <h1 class="ml-2 text-lg font-bold">Live TV Dashboard</h1> <div class="flex justify-between items-center mb-4 max-w-3xl mx-auto">
  <p id="welcome-msg" class="text-lg font-semibold"></p>
  <button id="logout-btn" class="px-4 py-2 bg-red-500 rounded hover:bg-red-600 transition-colors">Logout</button>
</div>
</header>

<main>
  <p id="welcome-msg" class="mb-4 text-lg"></p>

  <!-- User Section -->
<div id="user-section" class="hidden space-y-8">

  <!-- Submission Card -->
  <div class="bg-gray-800 p-6 rounded-xl shadow-lg max-w-lg mx-auto space-y-4">
    <h2 class="text-2xl font-bold text-red-500">Submit a Channel</h2>
    <input type="text" id="channel-name" placeholder="Channel Name" class="w-full p-3 rounded-lg bg-gray-700 placeholder-gray-400 text-white focus:ring-2 focus:ring-red-500"/>
    <input type="text" id="channel-icon" placeholder="Channel Icon URL" class="w-full p-3 rounded-lg bg-gray-700 placeholder-gray-400 text-white focus:ring-2 focus:ring-red-500"/>
    <input type="text" id="channel-url" placeholder="Stream URL" class="w-full p-3 rounded-lg bg-gray-700 placeholder-gray-400 text-white focus:ring-2 focus:ring-red-500"/>
    <select id="channel-category" class="w-full p-3 rounded-lg bg-gray-700 text-white focus:ring-2 focus:ring-red-500">
      <option value="News">News</option>
      <option value="Music">Music</option>
      <option value="Entertainment">Entertainment</option>
    </select>
    <button onclick="submitChannel()" class="w-full bg-red-500 hover:bg-red-600 font-bold py-3 rounded-lg transition-colors duration-300 shadow-md">Submit Channel</button>
  </div>

  <!-- Pending Requests -->
  <div class="space-y-2 max-w-3xl mx-auto">
    <h3 class="text-xl font-semibold border-b border-gray-700 pb-2">Pending Requests</h3>
    <div id="user-pending" class="space-y-3"></div>
  </div>

  <!-- Approved Channels -->
  <div class="space-y-2 max-w-3xl mx-auto">
    <h3 class="text-xl font-semibold border-b border-gray-700 pb-2">Approved Channels</h3>
    <div id="user-approved" class="space-y-3"></div>
  </div>
</div>

  <!-- Admin Section -->
  <div id="admin-section" class="hidden space-y-6">
    <h2 class="text-xl font-semibold">Pending Channel Requests</h2>
    <div id="admin-requests" class="space-y-2"></div>
  </div>
</main>

<script src="https://www.gstatic.com/firebasejs/9.22.2/firebase-app-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.22.2/firebase-auth-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.22.2/firebase-database-compat.js"></script>

<script>
const firebaseConfig = {
  apiKey: "AIzaSyB9GaCbYFH22WbiLs1pc_UJTsM_0Tetj6E",
  authDomain: "tnm3ulive.firebaseapp.com",
  databaseURL: "https://tnm3ulive-default-rtdb.asia-southeast1.firebasedatabase.app",
  projectId: "tnm3ulive",
  storageBucket: "tnm3ulive.firebasestorage.app",
  messagingSenderId: "80664356882",
  appId: "1:80664356882:web:c8464819b0515ec9b210cb",
  measurementId: "G-FNS9JWZ9LS"
};

firebase.initializeApp(firebaseConfig);
const auth = firebase.auth();
const db = firebase.database();

const userSection = document.getElementById('user-section');
const adminSection = document.getElementById('admin-section');
const welcomeMsg = document.getElementById('welcome-msg');
const userPending = document.getElementById('user-pending');
const userApproved = document.getElementById('user-approved');
const adminRequestsList = document.getElementById('admin-requests');

auth.onAuthStateChanged(async user => {
  if(!user){ alert('Please log in'); window.location.href='login.html'; return; }
  welcomeMsg.textContent = `Welcome, ${user.email}`;

  const isAdmin = await db.ref(`admins/${user.uid}`).get().then(snap=>snap.exists());

  if(isAdmin){
    adminSection.classList.remove('hidden');
    loadAdminRequests();
  } else {
    userSection.classList.remove('hidden');
    loadUserChannels(user.uid);
  }
});

// ================= User Functions =================
function submitChannel(){
  const name = document.getElementById('channel-name').value.trim();
  const icon = document.getElementById('channel-icon').value.trim();
  const url = document.getElementById('channel-url').value.trim();
  const category = document.getElementById('channel-category').value;
  const user = auth.currentUser;

  if(!name || !url || !icon){
    alert('Please fill all fields');
    return;
  }

  const requestId = db.ref('channelRequests').push().key;
  db.ref(`channelRequests/${requestId}`).set({
    name,
    icon,
    url,
    category,
    submittedBy: user.uid,
    status: 'pending',
    timestamp: Date.now()
  }).then(()=>{
    alert('Channel request submitted');
    document.getElementById('channel-name').value = '';
    document.getElementById('channel-icon').value = '';
    document.getElementById('channel-url').value = '';
    loadUserChannels(user.uid);
  });
}

function loadUserChannels(uid){
  db.ref('channelRequests').orderByChild('submittedBy').equalTo(uid).on('value', snap => {
    userPending.innerHTML = '';
    userApproved.innerHTML = '';

    snap.forEach(child => {
      const c = child.val();
      const card = document.createElement('div');
      card.className = 'flex items-center gap-4 p-3 bg-gray-700 rounded-xl shadow-md hover:shadow-lg transition-shadow';

      card.innerHTML = `
        <img src="${c.icon}" alt="${c.name}" class="w-16 h-16 rounded-lg object-cover border border-gray-600"/>
        <div class="flex-1">
          <h4 class="font-semibold text-white">${c.name}</h4>
          <p class="text-gray-300">${c.category}</p>
        </div>
        <span class="px-3 py-1 rounded-full text-sm font-semibold ${c.status === 'pending' ? 'bg-yellow-500 text-gray-900' : 'bg-green-500 text-white'}">
          ${c.status.charAt(0).toUpperCase() + c.status.slice(1)}
        </span>
      `;

      if(c.status === 'pending') userPending.appendChild(card);
      else if(c.status === 'approved') userApproved.appendChild(card);
    });
  });
}

// ================= Admin Functions =================
function loadAdminRequests(){
  db.ref('channelRequests').orderByChild('status').equalTo('pending').on('value', snap=>{
    adminRequestsList.innerHTML='';
    snap.forEach(child=>{
      const r=child.val();
      const li=document.createElement('div');
      li.className='channel-card justify-between';
      li.innerHTML=`<div class="flex items-center gap-2"><img src="${r.icon}" alt="${r.name}"/><div>${r.name} (${r.category}) by ${r.submittedBy}</div></div>`;
      const btns=document.createElement('div');

      const approve=document.createElement('button');
      approve.textContent='Approve';
      approve.onclick=()=>approveRequest(child.key,r);

      const reject=document.createElement('button');
      reject.textContent='Reject';
      reject.onclick=()=>rejectRequest(child.key);

      btns.appendChild(approve); btns.appendChild(reject);
      li.appendChild(btns);
      adminRequestsList.appendChild(li);
    });
  });
}

function approveRequest(id,r){
  const adminId=auth.currentUser.uid;
  db.ref(`channelRequests/${id}`).update({status:'approved'});
  // Optionally, move to `channels` if needed globally
}

function rejectRequest(id){
  db.ref(`channelRequests/${id}`).update({status:'rejected'});
}

// Logout Button
const logoutBtn = document.getElementById('logout-btn');
logoutBtn.addEventListener('click', () => {
  auth.signOut()
    .then(() => {
      // Redirect to home page
      window.location.href = '/';
    })
    .catch(error => {
      console.error("Logout Error:", error);
      alert("Error logging out. Please try again.");
    });
});
</script>
</body>
</html>