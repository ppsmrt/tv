<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8"/>
<meta name="viewport" content="width=device-width, initial-scale=1.0, viewport-fit=cover"/>
<title>TamilGeo - Dashboard</title>

<!-- Tailwind CSS -->
<script src="https://cdn.tailwindcss.com"></script>

<!-- Material Icons -->
<link href="https://fonts.googleapis.com/icon?family=Material+Icons" rel="stylesheet"/>

<!-- Fav Icon -->
<link rel="icon" type="image/x-icon" href="assets/icon/favicon.ico">

<!-- Baloo 2 Font -->
<link href="https://fonts.googleapis.com/css2?family=Baloo+2&display=swap" rel="stylesheet"/>

<style>
  body { font-family: 'Baloo 2', cursive; background-color: #111827; color: #f9fafb; margin: 0; min-height: 100vh; }
  main { padding: 20px 1rem 100px; max-width: 800px; margin: 0 auto; }
  .profile-card { background: #1f2937; border-radius: 16px; padding: 1.5rem; margin-top: 32px; display: flex; align-items: center; gap: 16px; box-shadow: 0 4px 12px rgba(0,0,0,0.5); }
  .rounded-avatar { width: 72px; height: 72px; border-radius: 9999px; overflow: hidden; border: 2px solid #3b82f6; }
  .section-heading { font-weight: 700; font-size: 1rem; padding: 0.5rem 1rem; border-radius: 12px 12px 0 0; margin-top: 32px; margin-bottom: 8px; color: #fff; }
  .page-card { background: #1f2937; border-radius: 16px; display: flex; align-items: center; justify-content: space-between; padding: 0.75rem 1rem; margin-bottom: 8px; cursor: pointer; transition: background 0.3s ease; }
  .page-card:hover { background: #374151; }
  .toast { position: fixed; bottom: 20px; right: 20px; min-width: 200px; padding: 12px 16px; border-radius: 12px; box-shadow: 0 4px 16px rgba(0,0,0,0.5); color: #f9fafb; font-weight: 500; background-color: #1f2937; opacity: 0; transform: translateY(20px); transition: opacity 0.3s ease, transform 0.3s ease; z-index: 9999; }
  .toast.show { opacity: 1; transform: translateY(0); }
  .toast.success { border-left: 4px solid #22c55e; }
  .toast.error { border-left: 4px solid #ef4444; }
</style>
</head>
<body>

<main>
  <!-- Profile -->
  <div class="profile-card" id="profileCard">
    <div class="rounded-avatar">
      <img id="profileImg" src="https://via.placeholder.com/150" alt="Profile" class="w-full h-full object-cover">
    </div>
    <div>
      <h2 id="fullname">Loading...</h2>
      <p id="email" class="text-gray-400 text-sm">...</p>
    </div>
  </div>

  <!-- Site Pages (Users only) -->
  <div id="sitePages">
    <div class="section-heading" style="background: linear-gradient(90deg,#22c55e,#16a34a)">Site Pages</div>
    <div class="page-card"><span>About Us</span><i class="material-icons">chevron_right</i></div>
    <div class="page-card"><span>Contact Us</span><i class="material-icons">chevron_right</i></div>
    <div class="page-card"><span>Donate Us</span><i class="material-icons">chevron_right</i></div>
    <div class="page-card"><span>Disclaimer</span><i class="material-icons">chevron_right</i></div>
    <div class="page-card"><span>Privacy Policy</span><i class="material-icons">chevron_right</i></div>
    <div class="page-card"><span>Terms & Conditions</span><i class="material-icons">chevron_right</i></div>
  </div>

  <!-- Account Settings (Users only) -->
  <div id="accountSettings" style="margin-top:32px;">
    <div class="section-heading" style="background: linear-gradient(90deg,#3b82f6,#2563eb)">Account & Settings</div>
    <div class="page-card"><span>Edit Profile</span><i class="material-icons">chevron_right</i></div>
    <div class="page-card"><span>Change Password</span><i class="material-icons">chevron_right</i></div>
  </div>

  <!-- Admin Section (Admins only) -->
  <div id="adminSection" style="margin-top:32px; display:none;">
    <div class="section-heading" style="background: linear-gradient(90deg,#3b82f6,#2563eb)">Channel Management</div>
    <div class="page-card" onclick="window.location.href='admin'">
      <span>Channel Manager</span><i class="material-icons">chevron_right</i>
    </div>
    <div class="page-card" onclick="window.location.href='approve'">
      <span>Approve Channel</span><i class="material-icons">chevron_right</i>
    </div>
  </div>

  <!-- Logout -->
  <div class="page-card" id="logoutLink" style="margin-top:12px; cursor:pointer;">
    <span>Log Out</span><i class="material-icons">chevron_right</i>
  </div>
</main>

<!-- Toast Container -->
<div id="toastContainer"></div>

<!-- Firebase & Dashboard Logic -->
<script type="module">
import { initializeApp } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-app.js";
import { getDatabase, ref, onValue } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-database.js";
import { getAuth, onAuthStateChanged, signOut } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-auth.js";

const firebaseConfig = {
  apiKey: "AIzaSyB9GaCbYFH22WbiLs1pc_UJTsM_0Tetj6E",
  authDomain: "tnm3ulive.firebaseapp.com",
  databaseURL: "https://tnm3ulive-default-rtdb.asia-southeast1.firebasedatabase.app",
  projectId: "tnm3ulive",
  storageBucket: "tnm3ulive.firebasestorage.app",
  messagingSenderId: "80664356882",
  appId: "1:80664356882:web:c8464819b0515ec9b210cb",
  measurementId: "G-FNS9JWZ9LS"
};

const app = initializeApp(firebaseConfig);
const db = getDatabase(app);
const auth = getAuth(app);

const fullnameEl = document.getElementById('fullname');
const emailEl = document.getElementById('email');
const profileImgEl = document.getElementById('profileImg');
const adminSection = document.getElementById('adminSection');
const sitePages = document.getElementById('sitePages');
const accountSettings = document.getElementById('accountSettings');
const toastContainer = document.getElementById('toastContainer');

function showToast(message, type='success'){
  const toast = document.createElement('div');
  toast.className = `toast ${type}`;
  toast.textContent = message;
  toastContainer.appendChild(toast);
  setTimeout(()=>toast.classList.add('show'),50);
  setTimeout(()=>{
    toast.classList.remove('show');
    setTimeout(()=>toast.remove(),300);
  },3000);
}

// Auth check
onAuthStateChanged(auth, (user) => {
  if (!user) {
    // ðŸ”¹ Not logged in â†’ redirect to signin
    window.location.href = "/signin";
    return;
  }

  // Load profile data
  onValue(ref(db, 'users/' + user.uid), snapshot => {
    const data = snapshot.val();
    fullnameEl.textContent = data?.fullname || 'User';
    emailEl.textContent = user.email || '';
    if (data?.profileImg) profileImgEl.src = data.profileImg;
  });

  // Check admin
  onValue(ref(db, 'admins/' + user.uid), snapshot => {
    if (snapshot.exists()) {
      adminSection.style.display = 'block';
      sitePages.style.display = 'none';
      accountSettings.style.display = 'none';
    } else {
      adminSection.style.display = 'none';
      sitePages.style.display = 'block';
      accountSettings.style.display = 'block';
    }
  });
});

// Logout
document.getElementById('logoutLink').addEventListener('click', e => {
  e.preventDefault();
  signOut(auth).then(() => {
    showToast('Logged out');
    setTimeout(() => window.location.href = "/", 1000);
  }).catch(err => {
    showToast('Logout failed: ' + err.message, 'error');
  });
});
</script>
</body>
</html>