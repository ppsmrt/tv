<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8"/>
  <meta name="viewport" content="width=device-width, initial-scale=1, viewport-fit=cover"/>
  <title>Edit Account - TNM3U Live</title>

  <!-- Tailwind CSS -->
  <script src="https://cdn.tailwindcss.com"></script>

  <!-- Material Icons -->
  <link href="https://fonts.googleapis.com/icon?family=Material+Icons" rel="stylesheet"/>

  <!-- Baloo 2 Font -->
  <link href="https://fonts.googleapis.com/css2?family=Baloo+2&display=swap" rel="stylesheet"/>

  <!-- Fav Icon -->
  <link rel="icon" type="image/x-icon" href="https://tnm3u.live/assets/icon/favicon.ico">

  <style>
    html, body {
      font-family: 'Baloo 2', cursive;
      background-color: #111827;
      color: #fff;
      margin: 0;
      min-height: 100vh;
    }

    main {
      padding: 100px 1rem 100px; /* push below header */
      width: 100%;
      max-width: 1200px;
      margin: 0 auto;
    }

    /* Toast Styles */
    .toast {
      position: fixed;
      top: 1rem;
      right: 1rem;
      background: #1f2937;
      color: #fff;
      padding: 12px 16px;
      border-radius: 10px;
      box-shadow: 0 4px 10px rgba(0,0,0,0.3);
      opacity: 0;
      transform: translateY(-20px);
      transition: all 0.3s ease-in-out;
      z-index: 9999;
      font-size: 14px;
    }
    .toast.show {
      opacity: 1;
      transform: translateY(0);
    }
    .toast.success { border-left: 6px solid #22c55e; }
    .toast.error { border-left: 6px solid #ef4444; }
  </style>
</head>
<body class="flex flex-col min-h-screen">

  <!-- Header -->
  <div id="header"></div>

  <!-- Main -->
  <main class="flex-1">

    <!-- Profile Picture -->
    <div class="bg-gray-800 rounded-2xl shadow p-6 text-center mb-6">
      <div class="flex flex-col items-center">
        <div class="relative">
          <img id="profile-pic" src="https://via.placeholder.com/120" alt="Profile"
            class="w-28 h-28 rounded-full object-cover border-4 border-green-500 shadow-md" />
          <label for="upload-pic" class="absolute bottom-0 right-0 bg-green-600 text-white rounded-full p-2 shadow hover:scale-105 transition cursor-pointer">
            <span class="material-icons text-sm">edit</span>
          </label>
          <input type="file" id="upload-pic" class="hidden" accept="image/*"/>
        </div>
        <h2 class="mt-4 text-lg font-semibold text-white">Edit Profile</h2>
      </div>
    </div>

    <!-- Full-Width Form -->
    <form id="edit-profile-form" class="grid grid-cols-1 md:grid-cols-2 gap-6 bg-gray-800 rounded-2xl shadow p-6 w-full">

      <!-- Name -->
      <div class="col-span-1">
        <label class="block text-sm font-medium text-gray-300 mb-1">Name</label>
        <input id="name" type="text"
          class="w-full px-4 py-3 rounded-xl bg-gray-900 text-white border border-gray-700 focus:ring-2 focus:ring-green-500 focus:border-green-500 outline-none" />
      </div>

      <!-- Username -->
      <div class="col-span-1">
        <label class="block text-sm font-medium text-gray-300 mb-1">Username</label>
        <input id="username" type="text"
          class="w-full px-4 py-3 rounded-xl bg-gray-900 text-white border border-gray-700 focus:ring-2 focus:ring-green-500 focus:border-green-500 outline-none" />
        <p class="text-xs text-gray-400 mt-1">⚠️ Can only be set once.</p>
      </div>

      <!-- Email -->
      <div class="col-span-1">
        <label class="block text-sm font-medium text-gray-300 mb-1">Email</label>
        <input id="email" type="email" readonly
          class="w-full px-4 py-3 rounded-xl bg-gray-700 text-gray-400 border border-gray-600 cursor-not-allowed" />
      </div>

      <!-- Bio -->
      <div class="col-span-1">
        <label class="block text-sm font-medium text-gray-300 mb-1">Bio</label>
        <textarea id="bio" rows="3"
          class="w-full px-4 py-3 rounded-xl bg-gray-900 text-white border border-gray-700 focus:ring-2 focus:ring-green-500 focus:border-green-500 outline-none"></textarea>
      </div>

      <!-- Location -->
      <div class="col-span-1">
        <label class="block text-sm font-medium text-gray-300 mb-1">Location</label>
        <input id="location" type="text"
          class="w-full px-4 py-3 rounded-xl bg-gray-900 text-white border border-gray-700 focus:ring-2 focus:ring-green-500 focus:border-green-500 outline-none" />
      </div>

      <!-- Role -->
      <div class="col-span-1">
        <label class="block text-sm font-medium text-gray-300 mb-1">Role</label>
        <input id="role" type="text" readonly value="User"
          class="w-full px-4 py-3 rounded-xl bg-gray-700 text-gray-400 border border-gray-600 cursor-not-allowed" />
      </div>

      <!-- Save Button -->
      <div class="col-span-1 md:col-span-2">
        <button type="submit"
          class="w-full py-3 rounded-xl bg-gradient-to-r from-green-600 to-green-700 text-white font-semibold shadow hover:scale-105 transition">
          Save Changes
        </button>
      </div>
    </form>
  </main>

  <!-- Toast Container -->
  <div id="toast-container"></div>

  <!-- Footer -->
  <div id="footer"></div>

  <!-- Firebase SDK -->
  <script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/11.0.1/firebase-app.js";
    import { getDatabase, ref, update, get } from "https://www.gstatic.com/firebasejs/11.0.1/firebase-database.js";
    import { getAuth, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/11.0.1/firebase-auth.js";

    const firebaseConfig = {
      apiKey: "AIzaSyB9GaCbYFH22WbiLs1pc_UJTsM_0Tetj6E",
      authDomain: "tnm3ulive.firebaseapp.com",
      databaseURL: "https://tnm3ulive-default-rtdb.asia-southeast1.firebasedatabase.app",
      projectId: "tnm3ulive",
      storageBucket: "tnm3ulive.appspot.com",
      messagingSenderId: "80664356882",
      appId: "1:80664356882:web:c8464819b0515ec9b210cb"
    };

    const app = initializeApp(firebaseConfig);
    const db = getDatabase(app);
    const auth = getAuth(app);

    const profilePic = document.getElementById("profile-pic");
    const uploadInput = document.getElementById("upload-pic");

    // Toast function
    function showToast(message, type = "success") {
      const toast = document.createElement("div");
      toast.className = `toast ${type}`;
      toast.innerText = message;
      document.getElementById("toast-container").appendChild(toast);

      setTimeout(() => toast.classList.add("show"), 10);
      setTimeout(() => {
        toast.classList.remove("show");
        setTimeout(() => toast.remove(), 300);
      }, 4000);
    }

    // Load profile data
    onAuthStateChanged(auth, async (user) => {
      if (user) {
        try {
          const snap = await get(ref(db, "users/" + user.uid));
          if (snap.exists()) {
            const data = snap.val();
            document.getElementById("name").value = data.name || "";
            document.getElementById("username").value = data.username || "";
            document.getElementById("email").value = user.email || "";
            document.getElementById("bio").value = data.bio || "";
            document.getElementById("location").value = data.location || "";
            if (data.profilePic) profilePic.src = data.profilePic;

            if (data.username) {
              const u = document.getElementById("username");
              u.readOnly = true;
              u.classList.add("bg-gray-700","text-gray-400","cursor-not-allowed");
            }
          }
        } catch (e) {
          showToast("Unable to load profile. Please try again later.", "error");
        }
      }
    });

    // Upload image to imgbb
    uploadInput.addEventListener("change", async (e) => {
      const file = e.target.files[0];
      if (!file) return;
      const formData = new FormData();
      formData.append("image", file);

      try {
        const res = await fetch(`https://api.imgbb.com/1/upload?key=8604e4b4050c63c460d0bca39cf28708`, {
          method: "POST",
          body: formData
        });
        const data = await res.json();
        if (data.success) {
          const url = data.data.url;
          profilePic.src = url;

          const user = auth.currentUser;
          if (user) {
            await update(ref(db, "users/" + user.uid), { profilePic: url });
            showToast("Profile picture updated!");
          }
        } else {
          showToast("Image upload failed. Try another picture.", "error");
        }
      } catch (err) {
        showToast("Could not upload picture. Please try again.", "error");
      }
    });

    // Save updates
    document.getElementById("edit-profile-form").addEventListener("submit", async (e) => {
      e.preventDefault();
      const name = document.getElementById("name").value.trim();
      const bio = document.getElementById("bio").value.trim();
      const location = document.getElementById("location").value.trim();
      const usernameField = document.getElementById("username");
      const username = usernameField.value.trim();

      const user = auth.currentUser;
      if (user) {
        try {
          const updates = { name, bio, location, role: "user" }; // role always "user"
          if (!usernameField.readOnly && username) updates.username = username;

          await update(ref(db, "users/" + user.uid), updates);

          if (updates.username) {
            usernameField.readOnly = true;
            usernameField.classList.add("bg-gray-700","text-gray-400","cursor-not-allowed");
          }
          showToast("Profile updated successfully!", "success");
        } catch (err) {
          showToast("Could not update profile. Please try again later.", "error");
        }
      } else {
        showToast("You must be logged in to update profile.", "error");
      }
    });
  </script>

  <!-- Header & Footer -->
  <script type="module" src="assets/js/header.js"></script>
  <script type="module" src="assets/js/footer.js"></script>
</body>
</html>