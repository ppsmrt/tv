<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <title>Universal IPTV Player</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <style>
    body { margin:0; font-family:Arial, sans-serif; background:#111; color:#fff; }
    #player { width:100%; height:60vh; background:#000; }
    #controls { display:flex; gap:8px; padding:8px; background:#222; }
    #playlist { max-height:40vh; overflow:auto; background:#181818; }
    .channel { display:flex; align-items:center; gap:8px; padding:6px; cursor:pointer; }
    .channel:hover { background:#333; }
    .active { background:#444; }
    .channel img { width:40px; height:40px; object-fit:contain; border-radius:6px; }
    input, select, button { padding:6px; border:none; border-radius:4px; }
  </style>
</head>
<body>
  <video id="player" controls autoplay playsinline></video>
  <div id="controls">
    <input id="urlInput" type="text" placeholder="Enter playlist (.m3u) or stream URL (.m3u8/.mpd/.ts)" style="flex:1" />
    <button id="loadBtn">Load</button>
    <input id="filter" type="text" placeholder="Search channel..." />
    <select id="group"></select>
  </div>
  <div id="playlist"></div>

  <!-- Dependencies -->
  <script src="https://cdn.jsdelivr.net/npm/hls.js@1.5.16/dist/hls.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/dashjs@4.7.4/dist/dash.all.min.js"></script>

  <script>
    const video = document.getElementById('player');
    const urlInput = document.getElementById('urlInput');
    const loadBtn = document.getElementById('loadBtn');
    const filterInput = document.getElementById('filter');
    const groupSelect = document.getElementById('group');
    const playlistDiv = document.getElementById('playlist');

    let hls, dash;
    let channels = [];
    let currentIndex = -1;

    function destroyEngines() {
      if (hls) { hls.destroy(); hls = null; }
      if (dash) { dash.reset(); dash = null; }
      video.src = '';
    }

    function ext(url) {
      const clean = url.split('?')[0];
      return (clean.split('.').pop() || '').toLowerCase();
    }

    function playStream(url) {
      destroyEngines();
      const extension = ext(url);

      if (extension === 'm3u8') {
        if (video.canPlayType('application/vnd.apple.mpegurl')) {
          video.src = url;
          video.play().catch(()=>{});
        } else if (Hls.isSupported()) {
          hls = new Hls();
          hls.loadSource(url);
          hls.attachMedia(video);
          hls.on(Hls.Events.MANIFEST_PARSED, () => video.play().catch(()=>{}));
        } else {
          alert('HLS not supported in this browser');
        }
      } else if (extension === 'mpd') {
        dash = dashjs.MediaPlayer().create();
        dash.initialize(video, url, true);
      } else if (extension === 'ts') {
        video.src = url;
        video.type = 'video/mp2t';
        video.play().catch(()=>{});
      } else {
        video.src = url;
        video.play().catch(()=>{});
      }
    }

    function parseM3U(text) {
      const lines = text.split(/\r?\n/).map(l => l.trim()).filter(Boolean);
      const out = [];
      let meta = null;
      for (let line of lines) {
        if (line.startsWith('#EXTINF')) {
          const title = line.split(',').slice(1).join(',').trim();
          const attrs = {};
          line.replace(/(\w+)="([^"]*)"/g, (_, k, v) => { attrs[k] = v; });
          meta = { title, attrs };
        } else if (!line.startsWith('#')) {
          out.push({
            name: meta?.attrs?.['tvg-name'] || meta?.title || line,
            url: line,
            group: meta?.attrs?.['group-title'] || 'Other',
            logo: meta?.attrs?.['tvg-logo'] || ''
          });
          meta = null;
        }
      }
      return out;
    }

    function renderPlaylist() {
      playlistDiv.innerHTML = '';
      const f = filterInput.value.toLowerCase();
      const g = groupSelect.value;
      channels.forEach((c,i) => {
        if ((g==='All'||c.group===g) && c.name.toLowerCase().includes(f)) {
          const div = document.createElement('div');
          div.className = 'channel'+(i===currentIndex?' active':'');
          div.innerHTML = (c.logo?`<img src="${c.logo}" />`:'')+`<span>${c.name}</span>`;
          div.onclick = () => { currentIndex=i; playStream(c.url); renderPlaylist(); };
          playlistDiv.appendChild(div);
        }
      });
    }

    function updateGroups() {
      const groups = ['All', ...new Set(channels.map(c=>c.group))];
      groupSelect.innerHTML = groups.map(g=>`<option>${g}</option>`).join('');
    }

    filterInput.oninput = renderPlaylist;
    groupSelect.onchange = renderPlaylist;

    loadBtn.onclick = () => {
      const u = urlInput.value.trim();
      if (!u) return;
      if (u.endsWith('.m3u')) {
        fetch(u).then(r=>r.text()).then(txt => {
          channels = parseM3U(txt);
          updateGroups(); renderPlaylist();
        }).catch(()=>alert("Error loading playlist"));
      } else {
        channels = [{name:u,url:u,group:'Direct'}];
        updateGroups(); renderPlaylist();
        currentIndex=0; playStream(u);
      }
    };
  </script>
</body>
</html>