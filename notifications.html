<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8"/>
<meta name="viewport" content="width=device-width, initial-scale=1, viewport-fit=cover"/>
<title>Notifications - Live TV</title>

<!-- Tailwind CSS -->
<script src="https://cdn.tailwindcss.com"></script>

<!-- Material Icons -->
<link href="https://fonts.googleapis.com/icon?family=Material+Icons" rel="stylesheet"/>

<!-- Baloo 2 Font -->
<link href="https://fonts.googleapis.com/css2?family=Baloo+2&display=swap" rel="stylesheet"/>

<style>
  html, body {
    font-family: 'Baloo 2', cursive;
    background-color: #111827;
    color: #fff;
    margin: 0;
    min-height: 100vh;
  }

  header {
    height: 64px;
    display: flex;
    align-items: center;
    padding: 0 1.5rem;
    background: rgba(31,41,55,0.9);
    box-shadow: 0 2px 8px rgba(0,0,0,0.5);
    z-index: 20;
  }

  main {
    padding: 20px 1rem 100px;
    max-width: 800px;
    margin: 0 auto;
  }

  .notification-card {
    display: flex;
    align-items: center;
    background: #1f2937;
    border-radius: 12px;
    padding: 12px 16px;
    margin-bottom: 12px;
    box-shadow: 0 4px 12px rgba(0,0,0,0.5);
    transition: transform 0.3s ease, box-shadow 0.3s ease, background 0.3s ease;
    cursor: pointer;
  }
  .notification-card:hover {
    background: #374151;
    transform: translateY(-3px);
    box-shadow: 0 6px 16px rgba(248,113,113,0.4);
  }

  .notification-icon {
    width: 50px;
    height: 50px;
    border-radius: 12px;
    object-fit: cover;
    margin-right: 16px;
    flex-shrink: 0;
  }

  .notification-content {
    flex: 1;
  }
  .notification-title {
    font-weight: 700;
    font-size: 1rem;
    color: #f9fafb;
  }
  .notification-category {
    font-size: 0.875rem;
    color: #9ca3af;
  }

  .empty-state {
    display: flex;
    flex-direction: column;
    align-items: center;
    justify-content: center;
    margin-top: 3rem;
    text-align: center;
    animation: fadeIn 0.5s ease-in-out;
  }
  .empty-state .title {
    font-size: 1.5rem;
    font-weight: 700;
    color: #f87171;
    margin-bottom: 1rem;
  }
  .empty-state img {
    max-width: 260px;
    border-radius: 12px;
    box-shadow: 0 4px 14px rgba(0,0,0,0.6);
  }
  @keyframes fadeIn {
    from { opacity: 0; transform: translateY(20px); }
    to { opacity: 1; transform: translateY(0); }
  }
</style>
</head>
<body>

<!-- Header -->
<div id="header"></div>

<main id="notificationsContainer">
  <p class="no-notifications">Loading notifications...</p>
</main>
  
<!-- Footer -->
<div id="footer"></div>

<!-- JS Files -->
<script type="module" src="assets/js/header.js"></script>
<script type="module" src="assets/js/footer.js"></script>

<script type="module">
import { initializeApp } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-app.js";
import { getDatabase, ref, onValue } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-database.js";
import { getAuth, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-auth.js";

const firebaseConfig = {
  apiKey: "AIzaSyB9GaCbYFH22WbiLs1pc_UJTsM_0Tetj6E",
  authDomain: "tnm3ulive.firebaseapp.com",
  databaseURL: "https://tnm3ulive-default-rtdb.asia-southeast1.firebasedatabase.app",
  projectId: "tnm3ulive",
  storageBucket: "tnm3ulive.firebasestorage.app",
  messagingSenderId: "80664356882",
  appId: "1:80664356882:web:c8464819b0515ec9b210cb",
  measurementId: "G-FNS9JWZ9LS"
};

const app = initializeApp(firebaseConfig);
const db = getDatabase(app);
const auth = getAuth(app);

const container = document.getElementById('notificationsContainer');

// ✅ Convert timestamp to "time ago"
function timeAgo(timestamp) {
  if (!timestamp) return "";
  const diff = Math.floor((Date.now() - timestamp) / 1000);
  if (diff < 60) return `${diff}s ago`;
  if (diff < 3600) return `${Math.floor(diff / 60)}m ago`;
  if (diff < 86400) return `${Math.floor(diff / 3600)}h ago`;
  return `${Math.floor(diff / 86400)}d ago`;
}

// ✅ Create Notification Card
function createNotificationCard(notification) {
  const card = document.createElement('div');
  card.className = 'notification-card';
  if (notification.url) {
    card.onclick = () => window.open(notification.url, "_blank");
  }

  const img = document.createElement('img');
  img.className = 'notification-icon';
  img.src = notification.logo || 'https://via.placeholder.com/50';
  img.alt = (notification.name || "Notification") + ' logo';

  const content = document.createElement('div');
  content.className = 'notification-content';

  const title = document.createElement('div');
  title.className = 'notification-title';
  title.textContent = notification.message;

  const meta = document.createElement('div');
  meta.className = 'notification-category';
  meta.textContent = `${notification.category || ''} ${timeAgo(notification.timestamp)}`;

  content.appendChild(title);
  content.appendChild(meta);
  card.appendChild(img);
  card.appendChild(content);

  return card;
}

// ✅ Empty State UI
function renderEmptyState() {
  container.innerHTML = `
    <div class="empty-state">
      <div class="title" lang="ta">ஒன்னும் இல்லை!</div>
      <img src="https://tvicn.wordpress.com/wp-content/uploads/2025/09/20250903_0032382345023889667523819.jpg" 
           alt="Cartoon of a man with a mustache wearing a yellow shirt and striped lungi, pulling out his empty pockets to show no money">
    </div>
  `;
}

// ✅ Render All Notifications
function renderNotifications(notifications) {
  container.innerHTML = '';
  if (notifications.length === 0) {
    renderEmptyState();
    return;
  }
  notifications.forEach(n => container.appendChild(createNotificationCard(n)));
}

// ✅ Fetch Data & Merge
onAuthStateChanged(auth, user => {
  if (!user) {
    container.innerHTML = `<p class="text-center mt-4">Please log in to see notifications</p>`;
    return;
  }

  const notificationsRef = ref(db, 'notifications');
  const channelsRef = ref(db, 'channels');

  onValue(channelsRef, snapshot => {
    const channelsData = snapshot.val();
    let latestChannels = [];
    if (channelsData) {
      latestChannels = Object.values(channelsData)
        .map(c => ({
          message: `New channel added: ${c.name || 'Unknown'}`,
          logo: c.logo || '',
          url: c.url || '',
          timestamp: c.timestamp || 0,
          category: 'Channel'
        }))
        .sort((a, b) => b.timestamp - a.timestamp)
        .slice(0, 5);
    }

    onValue(notificationsRef, snapshot2 => {
      const notifData = snapshot2.val();
      let notifications = [];
      if (notifData) {
        notifications = Object.values(notifData)
          .filter(n => !n.userId || n.userId === user.uid)
          .sort((a, b) => (b.timestamp || 0) - (a.timestamp || 0));
      }

      const merged = [...latestChannels, ...notifications];
      renderNotifications(merged);
    });
  });
});
</script>

</body>
</html>
