<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>FM Radio Premium UI</title>

<!-- Tailwind -->
<script src="https://cdn.tailwindcss.com"></script>
<!-- Font Awesome -->
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.0/css/all.min.css" />
<!-- Google Fonts -->
<link href="https://fonts.googleapis.com/css2?family=Baloo+2:wght@400;600;700&display=swap" rel="stylesheet">

<style>
body { font-family: 'Baloo 2', cursive; }
.scrollbar-hide::-webkit-scrollbar { display: none; }
.scrollbar-hide { -ms-overflow-style: none; scrollbar-width: none; }
@keyframes pulse {0%,100%{transform:scale(1)}50%{transform:scale(1.08)}}
@keyframes bounce {0%,100%{transform:translateY(0)}50%{transform:translateY(-5px)}}

/* Screensaver animations */
@keyframes spin-slow { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }
.animate-spin-slow { animation: spin-slow 6s linear infinite; }

@keyframes wave { 0%,100% { height: 20%; } 50% { height: 80%; } }
.animate-wave { animation: wave 1s ease-in-out infinite; }
.delay-200 { animation-delay: 0.2s; }
.delay-400 { animation-delay: 0.4s; }
.delay-600 { animation-delay: 0.6s; }
.delay-800 { animation-delay: 0.8s; }
</style>
</head>
<body class="bg-gray-100 overflow-x-hidden">

<!-- Header -->
<header class="bg-gradient-to-r from-indigo-600 to-sky-500 text-white rounded-b-2xl shadow-lg p-4 text-center">
  <div class="flex justify-between items-center text-sm font-semibold opacity-90 mb-2">
    <span id="current-time">--:--</span>
    <span id="battery-status">ðŸ”‹ --%</span>
  </div>

  <div class="w-24 h-24 bg-white/20 backdrop-blur-md rounded-full mx-auto flex items-center justify-center animate-pulse">
    <i class="fa-solid fa-headphones text-3xl text-white"></i>
  </div>

  <!-- Dynamic Station Name & Location -->
  <div class="mt-2">
    <div id="headerStation" class="font-bold text-xl animate-pulse">--</div>
    <div id="headerLocation" class="text-sm opacity-80">--</div>
  </div>
</header>

<!-- Search -->
<div class="px-5 py-3">
  <input type="text" id="channelSearch" placeholder="Search Stations..." class="w-full px-4 py-2 rounded-full shadow-md border-none focus:ring-2 focus:ring-indigo-500 outline-none text-sm">
</div>

<!-- Station List -->
<section id="stationList" class="px-5 py-3 space-y-4 max-h-[60vh] overflow-y-auto scrollbar-hide">
  <!-- Firebase stations will render here -->
</section>

<!-- Mini Player -->
<div id="miniPlayer" class="fixed bottom-20 left-3 right-3 bg-indigo-600 text-white rounded-2xl p-3 flex flex-col md:flex-row justify-between items-center shadow-lg backdrop-blur-md hidden cursor-pointer transition-all">
  <div class="flex justify-between items-center w-full md:w-auto gap-2">
    <span id="miniStation" class="text-sm md:text-base font-semibold">Playing: --</span>
    <div class="flex gap-2 ml-2 md:ml-4">
      <button id="playPauseBtn" class="w-9 h-9 bg-white/20 rounded-xl flex justify-center items-center hover:bg-white/40 transition"><i class="fa-solid fa-play"></i></button>
      <button id="muteBtn" class="w-9 h-9 bg-white/20 rounded-xl flex justify-center items-center hover:bg-white/40 transition"><i class="fa-solid fa-volume-high"></i></button>
      <button id="stopBtn" class="w-9 h-9 bg-white/20 rounded-xl flex justify-center items-center hover:bg-white/40 transition"><i class="fa-solid fa-stop"></i></button>
    </div>
  </div>
</div>

<!-- Footer -->
<footer class="fixed bottom-0 left-0 right-0 bg-white/10 backdrop-blur-md flex justify-around p-2 text-xs font-semibold rounded-t-2xl shadow-inner">
  <div class="flex flex-col items-center cursor-pointer hover:translate-y-1 transition"><i class="fa-solid fa-share-nodes"></i>Share</div>
  <div class="flex flex-col items-center cursor-pointer hover:translate-y-1 transition"><i class="fa-solid fa-music"></i>Browser</div>
  <div class="flex flex-col items-center cursor-pointer hover:translate-y-1 transition"><i class="fa-solid fa-star"></i>Favorites</div>
  <div class="flex flex-col items-center cursor-pointer hover:translate-y-1 transition"><i class="fa-solid fa-clock-rotate-left"></i>Recent</div>
</footer>

<!-- Screensaver -->
<div id="screensaver" class="fixed inset-0 bg-black/90 z-50 flex flex-col justify-center items-center hidden">
  <div class="w-40 h-40 rounded-full overflow-hidden border-8 border-white mb-6 animate-spin-slow flex justify-center items-center">
    <i class="fa-solid fa-compact-disc text-4xl text-white"></i>
  </div>
  <div class="w-48 h-6 flex justify-around items-end mb-4">
    <div class="w-2 bg-indigo-500 animate-wave"></div>
    <div class="w-2 bg-indigo-500 animate-wave delay-200"></div>
    <div class="w-2 bg-indigo-500 animate-wave delay-400"></div>
    <div class="w-2 bg-indigo-500 animate-wave delay-600"></div>
    <div class="w-2 bg-indigo-500 animate-wave delay-800"></div>
  </div>
  <div class="text-center text-white">
    <div id="screensaverStation" class="text-xl font-bold mb-1">--</div>
    <div id="screensaverLanguage" class="text-sm opacity-80 mb-2">--</div>
    <div id="screensaverTime" class="text-sm opacity-80">--:--</div>
  </div>
</div>

<!-- Radio Info Modal -->
<div id="radioInfoModal" class="fixed inset-0 bg-black/70 z-60 flex justify-center items-center hidden">
  <div class="bg-white rounded-2xl p-6 w-80 text-center">
    <h2 class="text-lg font-bold mb-2" id="infoName">Radio Name</h2>
    <p id="infoLanguage" class="mb-1">Language: --</p>
    <p id="infoLocation" class="mb-1">Location: --</p>
    <p id="infoType" class="mb-1">Type: --</p>
    <p id="infoGenre" class="mb-2">Genre: --</p>
    <button id="closeModal" class="bg-indigo-600 text-white px-4 py-2 rounded-full mt-2">Close</button>
  </div>
</div>

<!-- Firebase + Radio Logic -->
<script type="module">
import { initializeApp } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-app.js";
import { getDatabase, ref, onValue, runTransaction } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-database.js";

const firebaseConfig = {
  apiKey: "AIzaSyB9GaCbYFH22WbiLs1pc_UJTsM_0Tetj6E",
  authDomain: "tnm3ulive.firebaseapp.com",
  databaseURL: "https://tnm3ulive-default-rtdb.asia-southeast1.firebasedatabase.app",
  projectId: "tnm3ulive",
  storageBucket: "tnm3ulive.firebasestorage.app",
  messagingSenderId: "80664356882",
  appId: "1:80664356882:web:c8464819b0515ec9b210cb",
  measurementId: "G-FNS9JWZ9LS"
};

const app = initializeApp(firebaseConfig);
const db = getDatabase(app);
const audio = new Audio();
audio.volume = 0.5;

const stationList = document.getElementById("stationList");
const miniPlayer = document.getElementById("miniPlayer");
const miniStation = document.getElementById("miniStation");
const playPauseBtn = document.getElementById("playPauseBtn");
const stopBtn = document.getElementById("stopBtn");
const muteBtn = document.getElementById("muteBtn");
const headerStation = document.getElementById("headerStation");
const headerLocation = document.getElementById("headerLocation");

const screensaver = document.getElementById("screensaver");
const screensaverStation = document.getElementById("screensaverStation");
const screensaverLanguage = document.getElementById("screensaverLanguage");
const screensaverTime = document.getElementById("screensaverTime");

const radioInfoModal = document.getElementById("radioInfoModal");
const closeModal = document.getElementById("closeModal");
const infoName = document.getElementById("infoName");
const infoLanguage = document.getElementById("infoLanguage");
const infoLocation = document.getElementById("infoLocation");
const infoType = document.getElementById("infoType");
const infoGenre = document.getElementById("infoGenre");

let radios = [];
let currentIndex = null;
let screensaverTimer;

// Reset screensaver timer
function resetScreensaverTimer() {
  if (!audio.src || currentIndex === null) {
    screensaver.classList.add("hidden");
    return;
  }
  screensaver.classList.add("hidden");
  clear
clearTimeout(screensaverTimer);
  screensaverTimer = setTimeout(() => {
    screensaver.classList.remove("hidden");
    if (currentIndex !== null) {
      const radio = radios[currentIndex];
      screensaverStation.textContent = radio.name;
      screensaverLanguage.textContent = radio.language || radio.location || "";
      const now = new Date();
      screensaverTime.textContent = `${now.getHours().toString().padStart(2,'0')}:${now.getMinutes().toString().padStart(2,'0')}`;
    }
  }, 15000); // 15 seconds idle
}

// Call resetScreensaverTimer on user interactions
['mousemove','keydown','touchstart','click'].forEach(evt => {
  document.addEventListener(evt, resetScreensaverTimer);
});
resetScreensaverTimer();

// Play radio function
function playRadio(index) {
  const radio = radios[index];
  if (!radio) return;

  // Toggle same channel
  if (currentIndex === index) {
    if (audio.paused) {
      audio.play();
      playPauseBtn.innerHTML = '<i class="fa-solid fa-pause"></i>';
    } else {
      audio.pause();
      playPauseBtn.innerHTML = '<i class="fa-solid fa-play"></i>';
    }
    resetScreensaverTimer();
    return;
  }

  // Stop previous
  if (currentIndex !== null && currentIndex !== index) {
    audio.pause();
    audio.currentTime = 0;
  }

  // Play new channel
  audio.src = radio.stream;
  audio.play().catch(() => console.log("Tap play to start audio"));

  currentIndex = index;

  // Update Mini Player & Header
  miniStation.textContent = `Playing: ${radio.name}`;
  miniPlayer.classList.remove("hidden");
  playPauseBtn.innerHTML = '<i class="fa-solid fa-pause"></i>';

  headerStation.textContent = radio.name;
  headerLocation.textContent = radio.location || "";

  renderStationList();

  // Increment play count in Firebase
  const radioRef = ref(db, `radios/${radio.id}/playCount`);
  runTransaction(radioRef, current => (current || 0) + 1);

  resetScreensaverTimer();
}

// Mini player buttons
playPauseBtn.addEventListener("click", () => {
  if (!audio.src) return;
  if (audio.paused) {
    audio.play();
    playPauseBtn.innerHTML = '<i class="fa-solid fa-pause"></i>';
  } else {
    audio.pause();
    playPauseBtn.innerHTML = '<i class="fa-solid fa-play"></i>';
  }
  resetScreensaverTimer();
});

muteBtn.addEventListener("click", () => {
  audio.muted = !audio.muted;
  muteBtn.innerHTML = audio.muted ? '<i class="fa-solid fa-volume-xmark"></i>' : '<i class="fa-solid fa-volume-high"></i>';
});

stopBtn.addEventListener("click", () => {
  audio.pause();
  audio.currentTime = 0;
  miniPlayer.classList.add("hidden");
  playPauseBtn.innerHTML = '<i class="fa-solid fa-play"></i>';
  currentIndex = null;

  headerStation.textContent = "--";
  headerLocation.textContent = "--";
  resetScreensaverTimer();
});

// Render station list
function renderStationList() {
  const searchTerm = document.getElementById("channelSearch").value.toLowerCase();
  stationList.innerHTML = "";

  radios.forEach((radio, i) => {
    if (!radio.name.toLowerCase().includes(searchTerm)) return;

    const isPlaying = currentIndex === i;

    const item = document.createElement("div");
    item.className = `station-item flex items-center gap-4 bg-white rounded-2xl p-3 shadow hover:-translate-y-1 hover:shadow-lg transition cursor-pointer ${isPlaying ? 'scale-[1.02] bg-blue-50' : ''}`;
    item.innerHTML = `
      <div class="w-12 h-12 flex justify-center items-center text-white text-lg rounded-xl bg-gradient-to-tr from-indigo-600 to-sky-500">
        <i class="fa-solid fa-radio"></i>
      </div>
      <div class="flex-1">
        <h2 class="text-sm font-semibold">${radio.name}</h2>
        <p class="text-xs text-gray-500">${radio.location || ""}</p>
      </div>
      <span class="text-xs text-gray-600 play-count">${radio.playCount || 0} plays</span>
      <i class="fa-regular fa-star text-indigo-600 ml-2 cursor-pointer"></i>
      <i class="fa-solid fa-ellipsis-vertical text-indigo-600 ml-2 cursor-pointer info-btn"></i>
    `;

    // Click to play
    item.addEventListener("click", () => playRadio(i));

    // Favorite toggle
    const favStar = item.querySelector(".fa-regular.fa-star");
    favStar.addEventListener("click", e => {
      e.stopPropagation();
      favStar.classList.toggle("fa-solid");
      favStar.classList.toggle("animate-bounce");
      setTimeout(() => favStar.classList.remove("animate-bounce"), 500);
    });

    // Info modal
    const infoBtn = item.querySelector(".info-btn");
    infoBtn.addEventListener("click", e => {
      e.stopPropagation();
      infoName.textContent = radio.name;
      infoLanguage.textContent = `Language: ${radio.language || "--"}`;
      infoLocation.textContent = `Location: ${radio.location || "--"}`;
      infoType.textContent = `Type: ${radio.type || "FM/Live"}`;
      infoGenre.textContent = `Genre: ${radio.genre || "--"}`;
      radioInfoModal.classList.remove("hidden");
    });

    stationList.appendChild(item);
  });
}

// Close modal
closeModal.addEventListener("click", () => {
  radioInfoModal.classList.add("hidden");
});

// Search input
document.getElementById("channelSearch").addEventListener("input", renderStationList);

// ---------------------- Firebase Load ----------------------
onValue(ref(db, "radios"), snapshot => {
  radios = [];
  snapshot.forEach(child => {
    const radio = { id: child.key, ...child.val() };
    radios.push(radio);
  });

  renderStationList();
});

// Current time & battery
function updateTime() {
  const now = new Date();
  document.getElementById('current-time').innerText = `${now.getHours().toString().padStart(2,'0')}:${now.getMinutes().toString().padStart(2,'0')}`;
}
setInterval(updateTime, 1000);
updateTime();

if (navigator.getBattery) {
  navigator.getBattery().then(battery => {
    function updateBattery() {
      const percent = Math.floor(battery.level * 100);
      document.getElementById('battery-status').innerText = `ðŸ”‹ ${percent}%`;
    }
    updateBattery();
    battery.addEventListener('levelchange', updateBattery);
  });
} else { document.getElementById('battery-status').innerText = 'ðŸ”‹ N/A'; }
</script>

</body>
</html>