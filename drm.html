<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="utf-8"/>
  <meta name="viewport" content="width=device-width, initial-scale=1"/>
  <title>DRM Channel Manager</title>

  <!-- Disable Indexing -->
  <meta name="robots" content="noindex, nofollow"/>

  <!-- Tailwind CSS -->
  <script src="https://cdn.tailwindcss.com"></script>
  <link href="https://fonts.googleapis.com/css2?family=Baloo+2&display=swap" rel="stylesheet">
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.0/css/all.min.css"/>
  <style>
    body { font-family: 'Baloo 2', cursive; }
    .collapsible {
      max-height: 0;
      overflow: hidden;
      transition: max-height 0.4s ease;
    }
  </style>
</head>
<body class="bg-[#121212] text-white w-screen h-screen flex flex-col">

  <!-- Header -->
  <div class="text-center py-4 text-2xl font-bold bg-[#1E1E1E] text-yellow-400 shadow">
    <i class="fa-solid fa-lock mr-2"></i>DRM M3U Channel Manager
  </div>

  <div class="flex-1 flex flex-col md:flex-row overflow-hidden">

    <!-- Left: DRM Form -->
    <div class="w-full md:w-1/2 p-5 bg-[#1E1E1E] shadow-lg overflow-y-auto rounded-xl">
      <h1 class="text-xl font-bold mb-4 text-center text-yellow-400">Add New DRM Channel</h1>

      <form id="drmForm" class="grid gap-4 md:grid-cols-2">
        
        <!-- Basic Fields -->
        <div>
          <label class="block text-gray-300 font-semibold mb-1">Channel Name</label>
          <input type="text" id="name" placeholder="Example Channel" required
            class="w-full px-4 py-2 border border-gray-600 bg-[#121212] text-white rounded-lg focus:ring-2 focus:ring-yellow-400 focus:outline-none"/>
        </div>

        <div>
          <label class="block text-gray-300 font-semibold mb-1">Logo URL</label>
          <input type="url" id="logo" placeholder="https://example.com/logo.png"
            class="w-full px-4 py-2 border border-gray-600 bg-[#121212] text-white rounded-lg focus:ring-2 focus:ring-yellow-400 focus:outline-none"/>
        </div>

        <div>
          <label class="block text-gray-300 font-semibold mb-1">Group Title</label>
          <input type="text" id="group" placeholder="Movies / Sports / News"
            class="w-full px-4 py-2 border border-gray-600 bg-[#121212] text-white rounded-lg focus:ring-2 focus:ring-yellow-400 focus:outline-none"/>
        </div>

        <div>
          <label class="block text-gray-300 font-semibold mb-1">Stream URL</label>
          <input type="url" id="stream" placeholder="https://example.com/manifest.mpd" required
            class="w-full px-4 py-2 border border-gray-600 bg-[#121212] text-white rounded-lg focus:ring-2 focus:ring-yellow-400 focus:outline-none"/>
        </div>

        <div>
          <label class="block text-gray-300 font-semibold mb-1">License Type</label>
          <select id="drmtype" class="w-full px-4 py-2 border border-gray-600 bg-[#121212] text-white rounded-lg focus:ring-2 focus:ring-yellow-400 focus:outline-none">
            <option value="com.widevine.alpha">Widevine (Google)</option>
            <option value="com.apple.fps.1_0">FairPlay (Apple)</option>
            <option value="com.microsoft.playready">PlayReady (Microsoft)</option>
            <option value="clearkey">ClearKey</option>
          </select>
        </div>

        <div>
          <label class="block text-gray-300 font-semibold mb-1">License URL</label>
          <input type="url" id="license" placeholder="https://license-server.com/getlicense" required
            class="w-full px-4 py-2 border border-gray-600 bg-[#121212] text-white rounded-lg focus:ring-2 focus:ring-yellow-400 focus:outline-none"/>
        </div>

        <!-- Collapsible Advanced -->
        <div class="md:col-span-2">
          <button type="button" id="toggleAdvanced"
            class="w-full flex items-center justify-between bg-[#1E1E1E] px-4 py-2 rounded-lg font-semibold text-gray-300 hover:bg-gray-700 transition">
            Advanced Options
            <i id="advIcon" class="fa-solid fa-chevron-down"></i>
          </button>

          <div id="advancedFields" class="collapsible mt-3 grid gap-4 md:grid-cols-2">
            <div>
              <label class="block text-gray-300 font-semibold mb-1">Headers / Tokens</label>
              <input type="text" id="headers" placeholder="Authorization=Bearer%20TOKEN"
                class="w-full px-4 py-2 border border-gray-600 bg-[#121212] text-white rounded-lg focus:ring-2 focus:ring-yellow-400 focus:outline-none"/>
            </div>

            <div>
              <label class="block text-gray-300 font-semibold mb-1">Origin</label>
              <input type="text" id="origin" placeholder="https://example.com"
                class="w-full px-4 py-2 border border-gray-600 bg-[#121212] text-white rounded-lg focus:ring-2 focus:ring-yellow-400 focus:outline-none"/>
            </div>

            <div>
              <label class="block text-gray-300 font-semibold mb-1">Referer</label>
              <input type="text" id="referer" placeholder="https://example.com"
                class="w-full px-4 py-2 border border-gray-600 bg-[#121212] text-white rounded-lg focus:ring-2 focus:ring-yellow-400 focus:outline-none"/>
            </div>

            <div>
              <label class="block text-gray-300 font-semibold mb-1">TVG ID</label>
              <input type="text" id="tvgid" placeholder="tvg123"
                class="w-full px-4 py-2 border border-gray-600 bg-[#121212] text-white rounded-lg focus:ring-2 focus:ring-yellow-400 focus:outline-none"/>
            </div>

            <div>
              <label class="block text-gray-300 font-semibold mb-1">TVG Name</label>
              <input type="text" id="tvgn" placeholder="Channel TVG Name"
                class="w-full px-4 py-2 border border-gray-600 bg-[#121212] text-white rounded-lg focus:ring-2 focus:ring-yellow-400 focus:outline-none"/>
            </div>

            <div>
              <label class="block text-gray-300 font-semibold mb-1">TVG Channel Number</label>
              <input type="text" id="tvgchno" placeholder="101"
                class="w-full px-4 py-2 border border-gray-600 bg-[#121212] text-white rounded-lg focus:ring-2 focus:ring-yellow-400 focus:outline-none"/>
            </div>

            <div>
              <label class="block text-gray-300 font-semibold mb-1">Manifest Type</label>
              <select id="manifest" class="w-full px-4 py-2 border border-gray-600 bg-[#121212] text-white rounded-lg focus:ring-2 focus:ring-yellow-400 focus:outline-none">
                <option value="mpd">DASH (.mpd)</option>
                <option value="hls">HLS (.m3u8)</option>
              </select>
            </div>
          </div>
        </div>

        <!-- Submit -->
        <button type="submit" class="col-span-2 bg-yellow-500 text-black font-bold py-3 rounded-xl shadow-md hover:bg-yellow-400 transition">
          <i class="fa-solid fa-plus mr-2"></i> Add DRM Channel
        </button>
      </form>
    </div>

    <!-- Right: DRM Channels Display -->
    <div class="flex-1 flex flex-col p-5 overflow-auto">
      <h2 class="text-xl font-bold mb-3">DRM Channels</h2>
      <div id="channelList" class="grid gap-3"></div>
    </div>

  </div>

  <script type="module">
    // ============================
    // Firebase + DRM Renderer + Uploader
    // ============================
    import { initializeApp } from "https://www.gstatic.com/firebasejs/10.12.3/firebase-app.js";
    import { getDatabase, ref, onValue, push, set } from "https://www.gstatic.com/firebasejs/10.12.3/firebase-database.js";

    const firebaseConfig = {
      apiKey: "AIzaSyB9GaCbYFH22WbiLs1pc_UJTsM_0Tetj6E",
      authDomain: "tnm3ulive.firebaseapp.com",
      databaseURL: "https://tnm3ulive-default-rtdb.asia-southeast1.firebasedatabase.app",
      projectId: "tnm3ulive",
      storageBucket: "tnm3ulive.appspot.com",
      messagingSenderId: "80664356882",
      appId: "1:80664356882:web:c8464819b0515ec9b210cb",
      measurementId: "G-FNS9JWZ9LS"
    };

    const app = initializeApp(firebaseConfig);
    const db = getDatabase(app);

    const drmRef = ref(db, "drm");
    const channelList = document.getElementById("channelList");
    let advancedOpen = false;

    // Render Channels
    function renderChannels(data) {
      channelList.innerHTML = "";
      if (!data) {
        channelList.innerHTML = "<p class='text-gray-400'>No DRM channels available.</p>";
        return;
      }

      Object.entries(data).forEach(([id, ch]) => {
        const div = document.createElement("div");
        div.className = "flex items-center bg-[#1E1E1E] border border-gray-700 rounded-xl p-3 gap-3";
        div.innerHTML = `
          <img src="${ch.logo || ''}" alt="${ch.name}" class="w-14 h-14 object-contain rounded-lg border border-gray-700"/>
          <div class="flex-1">
            <h3 class="font-bold text-lg">${ch.name}</h3>
            <p class="text-gray-400 text-sm">${ch.group || "N/A"} | ${ch.manifest || "Unknown"}</p>
          </div>
        `;
        channelList.appendChild(div);
      });
    }

    // Live update from drm node
    onValue(drmRef, snapshot => renderChannels(snapshot.val()));

    // Collapsible logic
    const toggleBtn = document.getElementById("toggleAdvanced");
    const advancedFields = document.getElementById("advancedFields");
    const advIcon = document.getElementById("advIcon");

    toggleBtn.addEventListener("click", () => {
      if (advancedOpen) {
        advancedFields.style.maxHeight = null;
        advIcon.classList.remove("fa-chevron-up");
        advIcon.classList.add("fa-chevron-down");
        advancedOpen = false;
      } else {
        advancedFields.style.maxHeight = advancedFields.scrollHeight + "px";
        advIcon.classList.remove("fa-chevron-down");
        advIcon.classList.add("fa-chevron-up");
        advancedOpen = true;
      }
    });

    // Form Submit → Add to DRM node
    document.getElementById("drmForm").addEventListener("submit", e => {
      e.preventDefault();

      const name = document.getElementById('name').value.trim();
      const logo = document.getElementById('logo').value.trim();
      const group = document.getElementById('group').value.trim();
      const stream = document.getElementById('stream').value.trim();
      const drmtype = document.getElementById('drmtype').value;
      const license = document.getElementById('license').value.trim();
      const headers = document.getElementById('headers').value.trim();
      const origin = document.getElementById('origin').value.trim();
      const referer = document.getElementById('referer').value.trim();
      const tvgid = document.getElementById('tvgid').value.trim();
      const tvgn = document.getElementById('tvgn').value.trim();
      const tvgchno = document.getElementById('tvgchno').value.trim();
      const manifest = document.getElementById('manifest').value;

      if (!name || !stream || !license) {
        alert("Please fill Channel Name, Stream URL, and License URL.");
        return;
      }

      const newChannel = {
        name, logo, group, stream, drmtype, license,
        headers, origin, referer, tvgid, tvgn, tvgchno, manifest,
        timestamp: Date.now()
      };

      const newRef = push(drmRef);
      set(newRef, newChannel)
        .then(() => {
          alert("✅ Channel added successfully to DRM node!");
          e.target.reset();
        })
        .catch(err => alert("❌ Error adding channel: " + err.message));
    });
  </script>

</body>
</html>
