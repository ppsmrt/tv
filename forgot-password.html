<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Reset Password</title>
<style>
  body { font-family: Arial; background:#f5f5f5; display:flex; justify-content:center; align-items:center; height:100vh; }
  .container { background:#fff; padding:30px; border-radius:8px; box-shadow:0 4px 12px rgba(0,0,0,0.1); max-width:400px; width:100%; }
  input, button { width:100%; padding:12px; margin:10px 0; border-radius:6px; border:1px solid #ccc; font-size:16px; }
  button { background:#4A90E2; color:#fff; border:none; cursor:pointer; font-weight:bold; }
  button:hover { background:#357ABD; }
  #message { font-size:14px; margin-top:10px; }
  #timer { font-size:14px; margin-top:5px; color:#555; }
</style>
</head>
<body>

<div class="container">
  <h2 style="text-align:center;">Reset Password</h2>

  <!-- Step 1: Enter Email -->
  <input type="email" id="email" placeholder="Enter your email" required />
  <button id="send-code">Send Reset Code</button>
  <div id="timer"></div>

  <!-- Step 2: Enter Code + New Password -->
  <div id="reset-section" style="display:none;">
    <input type="text" id="code" placeholder="Enter code" required />
    <input type="password" id="new-password" placeholder="Enter new password" required />
    <button id="reset-password">Reset Password</button>
    <button id="resend-code" style="background:#888;">Resend Code</button>
  </div>

  <p id="message"></p>
</div>

<script>
const SEND_CODE_URL = "https://us-central1-tnm3ulive.cloudfunctions.net/sendResetCode";
const VERIFY_RESET_URL = "https://us-central1-tnm3ulive.cloudfunctions.net/verifyCodeAndReset";

const sendCodeBtn = document.getElementById("send-code");
const resetBtn = document.getElementById("reset-password");
const resendBtn = document.getElementById("resend-code");
const emailInput = document.getElementById("email");
const codeInput = document.getElementById("code");
const newPasswordInput = document.getElementById("new-password");
const message = document.getElementById("message");
const resetSection = document.getElementById("reset-section");
const timerEl = document.getElementById("timer");

let countdown;

// -----------------------
// Countdown Timer
// -----------------------
function startTimer(duration) {
  clearInterval(countdown);
  let time = duration;
  timerEl.textContent = `Code expires in ${Math.floor(time/60)}:${String(time%60).padStart(2,'0')}`;
  countdown = setInterval(() => {
    time--;
    timerEl.textContent = `Code expires in ${Math.floor(time/60)}:${String(time%60).padStart(2,'0')}`;
    if(time <= 0) {
      clearInterval(countdown);
      timerEl.textContent = "Code expired. Please resend.";
      sendCodeBtn.disabled = false;
    }
  }, 1000);
}

// -----------------------
// Send Reset Code
// -----------------------
async function sendResetCode() {
  const email = emailInput.value.trim();
  if (!email) return message.textContent = "Enter your email";

  message.style.color = "black";
  message.textContent = "Sending reset code...";
  try {
    const res = await fetch(SEND_CODE_URL, {
      method: "POST",
      headers: { "Content-Type": "application/json" },
      body: JSON.stringify({ email })
    });
    const data = await res.json();
    if (res.ok && data.success) {
      message.style.color = "green";
      message.textContent = "Reset code sent!";
      resetSection.style.display = "block";
      sendCodeBtn.disabled = true;
      startTimer(15*60); // 15 minutes countdown
    } else {
      message.style.color = "red";
      message.textContent = data.error || "Failed to send code";
    }
  } catch(err) {
    message.style.color = "red";
    message.textContent = "Network error. Try again.";
    console.error(err);
  }
}

// -----------------------
// Verify Code & Reset Password
// -----------------------
async function verifyCodeAndReset() {
  const email = emailInput.value.trim();
  const code = codeInput.value.trim();
  const newPassword = newPasswordInput.value;

  if (!code || !newPassword) return message.textContent = "Enter code and new password";
  if(newPassword.length < 6) return message.textContent = "Password must be at least 6 characters";

  message.style.color = "black";
  message.textContent = "Resetting password...";

  try {
    const res = await fetch(VERIFY_RESET_URL, {
      method: "POST",
      headers: { "Content-Type": "application/json" },
      body: JSON.stringify({ email, code, newPassword })
    });
    const data = await res.json();
    if (res.ok && data.success) {
      message.style.color = "green";
      message.textContent = "Password successfully reset!";
      resetSection.style.display = "none";
      sendCodeBtn.disabled = false;
      emailInput.value = codeInput.value = newPasswordInput.value = "";
      timerEl.textContent = "";
      clearInterval(countdown);
    } else {
      message.style.color = "red";
      message.textContent = data.error || "Failed to reset password";
    }
  } catch(err) {
    message.style.color = "red";
    message.textContent = "Network error. Try again.";
    console.error(err);
  }
}

// -----------------------
// Event Listeners
// -----------------------
sendCodeBtn.addEventListener("click", sendResetCode);
resendBtn.addEventListener("click", sendResetCode);
resetBtn.addEventListener("click", verifyCodeAndReset);

</script>
</body>
</html>
