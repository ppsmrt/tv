<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Reset Password</title>
<style>
  body { font-family: Arial, sans-serif; background: #f5f5f5; display: flex; justify-content: center; align-items: center; height: 100vh; }
  .container { background: #fff; padding: 30px; border-radius: 8px; box-shadow: 0 4px 12px rgba(0,0,0,0.1); width: 100%; max-width: 400px; }
  input, button { width: 100%; padding: 12px; margin: 10px 0; border-radius: 6px; border: 1px solid #ccc; font-size: 16px; }
  button { background: #4A90E2; color: #fff; border: none; cursor: pointer; font-weight: bold; }
  button:hover { background: #357ABD; }
  #message { margin-top: 10px; font-size: 14px; }
</style>
</head>
<body>

<div class="container">
  <h2 style="text-align:center;">Reset Password</h2>

  <div id="step-email">
    <input type="email" id="email" placeholder="Enter your email" required />
    <button id="send-code">Send Reset Code</button>
    <p id="message-email"></p>
  </div>

  <div id="step-password" style="display:none;">
    <input type="text" id="code" placeholder="Enter code sent to email" required />
    <input type="password" id="new-password" placeholder="Enter new password" required />
    <button id="reset-password">Reset Password</button>
    <p id="message-password"></p>
  </div>
</div>

<script type="module">
import { initializeApp } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-app.js";
import { getAuth, updatePassword, signInWithEmailAndPassword } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-auth.js";
import { getDatabase, ref, set, get, child } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-database.js";

const firebaseConfig = {
  apiKey: "AIzaSyB9GaCbYFH22WbiLs1pc_UJTsM_0Tetj6E",
  authDomain: "tnm3ulive.firebaseapp.com",
  databaseURL: "https://tnm3ulive-default-rtdb.asia-southeast1.firebasedatabase.app",
  projectId: "tnm3ulive",
  storageBucket: "tnm3ulive.firebasestorage.app",
  messagingSenderId: "80664356882",
  appId: "1:80664356882:web:c8464819b0515ec9b210cb",
  measurementId: "G-FNS9JWZ9LS"
};

const app = initializeApp(firebaseConfig);
const auth = getAuth(app);
const db = getDatabase(app);

const stepEmail = document.getElementById("step-email");
const stepPassword = document.getElementById("step-password");

const messageEmail = document.getElementById("message-email");
const messagePassword = document.getElementById("message-password");

// Step 1: Generate and send code
document.getElementById("send-code").addEventListener("click", async () => {
  const email = document.getElementById("email").value;

  try {
    // Generate random 6-digit code
    const code = Math.floor(100000 + Math.random() * 900000);

    // Save code in Realtime DB under email
    await set(ref(db, 'reset_codes/' + email.replace('.', ',')), { code, timestamp: Date.now() });

    // Normally, send the code via email here (use your email API)
    // For demo, we just log it:
    console.log(`Reset code for ${email}: ${code}`);

    messageEmail.style.color = "green";
    messageEmail.textContent = "Reset code sent! Check your email (or check console in demo).";

    stepPassword.style.display = "block";
  } catch (error) {
    messageEmail.style.color = "red";
    messageEmail.textContent = error.message;
  }
});

// Step 2: Verify code and reset password
document.getElementById("reset-password").addEventListener("click", async () => {
  const email = document.getElementById("email").value;
  const code = document.getElementById("code").value;
  const newPassword = document.getElementById("new-password").value;

  try {
    const snapshot = await get(child(ref(db), 'reset_codes/' + email.replace('.', ',')));
    if (!snapshot.exists()) throw new Error("No code found. Request a new one.");
    const data = snapshot.val();
    if (data.code != code) throw new Error("Invalid code. Try again.");

    // Sign in temporarily to update password (requires current password, workaround)
    // For demo, you would typically verify with secure session/token
    messagePassword.style.color = "green";
    messagePassword.textContent = "Code verified! Implement secure password update next.";

  } catch (error) {
    messagePassword.style.color = "red";
    messagePassword.textContent = error.message;
  }
});
</script>

</body>
</html>
