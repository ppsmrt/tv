<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1, viewport-fit=cover" />
<title>Live TV - Dashboard</title>

<!-- Tailwind -->
<script src="https://cdn.tailwindcss.com"></script>

<!-- Material Icons -->
<link href="https://fonts.googleapis.com/icon?family=Material+Icons" rel="stylesheet" />

<!-- Baloo 2 -->
<link href="https://fonts.googleapis.com/css2?family=Baloo+2&display=swap" rel="stylesheet" />

<style>
  html, body {
    font-family: 'Baloo 2', cursive;
    background-color: #111827;
    color: #fff;
    margin: 0;
    min-height: 100vh;
  }
  header {
    height: 64px;
    display: flex;
    align-items: center;
    padding: 0 1.5rem;
    background: rgba(31,41,55,0.9);
    box-shadow: 0 2px 8px rgba(0,0,0,0.5);
    z-index: 50;
  }
  main {
    padding: 20px 1rem 100px;
    max-width: 1200px;
    margin: 0 auto;
  }
  .input-field {
    width: 100%;
    padding: 14px;
    border-radius: 14px;
    border: none;
    background: #1f2937;
    color: #fff;
    font-weight: 500;
    outline: none;
    transition: all 0.3s ease;
  }
  .input-field:focus {
    box-shadow: 0 0 0 3px rgba(248, 113, 113, 0.5);
    background: #111827;
  }
  .file-input::file-selector-button {
    background: #f87171;
    color: white;
    padding: 8px 16px;
    border-radius: 10px;
    border: none;
    cursor: pointer;
    font-weight: 600;
    transition: all 0.3s ease;
  }
  .file-input::file-selector-button:hover {
    background: #ef4444;
  }
  #admin-requests .channel-card {
    background: rgba(31, 41, 55, 0.85);
    border-radius: 1rem;
    padding: 1rem;
    display: flex;
    justify-content: space-between;
    align-items: center;
    gap: 1rem;
    transition: all 0.3s ease;
    box-shadow: 0 4px 15px rgba(0,0,0,0.4);
  }
  #admin-requests .channel-card:hover {
    transform: scale(1.03);
    box-shadow: 0 8px 25px rgba(0,0,0,0.6);
  }
</style>
</head>
<body>

<!-- Header -->
<header class="fixed top-0 left-0 right-0 z-50 h-16 flex items-center justify-between px-6 bg-gray-800 bg-opacity-90 backdrop-blur-md shadow-lg">
  <div class="flex items-center space-x-3">
    <span class="material-icons text-white text-3xl">account_circle</span>
    <h1 class="text-xl font-bold text-white">Dashboard</h1>
  </div>
  <div>
    <button id="logout-btn" class="flex items-center space-x-2 text-gray-200 hover:text-red-400 transition">
      <span class="material-icons text-lg">logout</span>
      <span class="font-semibold text-sm">Logout</span>
    </button>
  </div>
</header>

<!-- Main Content -->
<main class="pt-20 px-6">
  
  <!-- User Section -->
  <div id="user-section" class="hidden space-y-10">
    <!-- Submit Channel -->
    <div class="bg-gradient-to-br from-gray-800 via-gray-900 to-gray-800 p-8 rounded-3xl shadow-2xl max-w-lg mx-auto space-y-6 transform transition-all duration-300 hover:scale-105">
      <h2 class="text-3xl font-extrabold text-red-500 text-center tracking-wide">Submit a Channel</h2>
      <div class="space-y-4">
        <input type="text" id="channel-name" placeholder="Channel Name" class="input-field" />
        
        <!-- Upload Icon Section -->
        <div class="mb-4">
          <label class="block font-semibold mb-1">Upload Channel Icon</label>
          <div class="relative border border-gray-300 rounded-lg p-4 flex items-center justify-center cursor-pointer hover:border-blue-500 transition">
            <input type="file" id="uploadIcon" accept="image/*" class="absolute inset-0 w-full h-full opacity-0 cursor-pointer" />
            <span class="text-gray-600">Click to Upload Icon</span>
          </div>
          <input type="hidden" id="icon" name="icon" />
          <p id="uploadStatus" class="text-sm text-gray-500 mt-1"></p>
          <div id="iconPreview" class="mt-2 hidden">
            <img id="previewImg" src="" alt="Preview" class="w-20 h-20 rounded-lg border" />
          </div>
        </div>

        <input type="text" id="channel-url" placeholder="Stream URL" class="input-field" />
        <select id="channel-category" class="input-field">
         <option value="">Select Category</option>
        <option value="Tamil">Tamil</option>
        <option value="Telugu">Telugu</option>
        <option value="Kannada">Kannada</option>
        <option value="Malayalam">Malayalam</option>
        <option value="Hindi">Hindi</option>
        <option value="Kids">Kids</option>
        <option value="Sports">Sports</option>
        </select>
        <button onclick="submitChannel()" class="w-full bg-red-500 hover:bg-red-600 text-white font-bold py-3 rounded-xl shadow-lg transition-all duration-300 transform hover:-translate-y-1">Submit Channel</button>
      </div>
      <!-- Tip -->
  <p class="text-xs text-gray-400 text-center">ðŸ’¡ Use PNG/JPG for better results. Max size 2MB.</p>
</div>
    </div>

    <!-- User Pending -->
    <div id="user-section" class="space-y-4 max-w-3xl mx-auto">
      <h3 class="text-2xl font-semibold border-b border-gray-700 pb-2">Pending Requests</h3>
      <div id="user-pending" class="space-y-3"></div>
    </div>

    <!-- User Approved -->
    <div id="user-section" class="space-y-4 max-w-3xl mx-auto">
      <h3 class="text-2xl font-semibold border-b border-gray-700 pb-2">Approved Channels</h3>
      <div id="user-approved" class="space-y-3"></div>
    </div>
  </div>

  <!-- Admin Section -->
  <div id="admin-section" class="hidden space-y-8">
    <div class="max-w-4xl mx-auto flex items-center justify-between bg-gray-800/90 backdrop-blur-sm p-5 rounded-2xl shadow-xl">
      <h2 class="text-2xl md:text-3xl font-extrabold text-red-500 tracking-wide">Pending Channel Requests</h2>
      <span class="material-icons text-white text-3xl cursor-pointer hover:text-red-400" title="Refresh" onclick="loadAdminRequests()">refresh</span>
    </div>
    <div id="admin-requests" class="space-y-4 max-w-4xl mx-auto"></div>
  </div>

<!-- Footer -->
<div id="footer"></div>

<!-- JS Files -->
<script type="module" src="assets/js/header.js"></script>
<script type="module" src="assets/js/footer.js"></script>

<!-- Toast -->
<div id="toast-container" class="fixed bottom-6 right-6 flex flex-col gap-3 z-50"></div>

<!-- Firebase Scripts -->
<script src="https://www.gstatic.com/firebasejs/9.22.2/firebase-app-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.22.2/firebase-auth-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.22.2/firebase-database-compat.js"></script>

<!-- Dashboard JS -->
<script type="module">
  document.addEventListener('DOMContentLoaded', () => {
  const firebaseConfig = {
    apiKey: "AIzaSyB9GaCbYFH22WbiLs1pc_UJTsM_0Tetj6E",
    authDomain: "tnm3ulive.firebaseapp.com",
    databaseURL: "https://tnm3ulive-default-rtdb.asia-southeast1.firebasedatabase.app",
    projectId: "tnm3ulive",
    storageBucket: "tnm3ulive.firebasestorage.app",
    messagingSenderId: "80664356882",
    appId: "1:80664356882:web:c8464819b0515ec9b210cb",
    measurementId: "G-FNS9JWZ9LS"
  };
  firebase.initializeApp(firebaseConfig);
  const auth = firebase.auth();
  const db = firebase.database();

  const userSection = document.getElementById('user-section');
  const adminSection = document.getElementById('admin-section');
  const userPending = document.getElementById('user-pending');
  const userApproved = document.getElementById('user-approved');
  const adminRequestsList = document.getElementById('admin-requests');

  function showToast(message, type = "info") {
    const toast = document.createElement('div');
    toast.className = `
      flex items-center gap-3 px-4 py-3 rounded-xl shadow-lg text-white transition-all duration-300 transform
      opacity-0 translate-x-10
      ${type === "success" ? "bg-green-500" :
        type === "error" ? "bg-red-500" :
        "bg-gray-700"}
    `;
    const icon = document.createElement('span');
    icon.className = 'material-icons';
    icon.textContent = type === "success" ? 'check_circle' : type === "error" ? 'error' : 'info';
    toast.appendChild(icon);
    const msg = document.createElement('span');
    msg.textContent = message;
    toast.appendChild(msg);
    document.getElementById('toast-container').appendChild(toast);
    requestAnimationFrame(() => {
      toast.style.opacity = '1';
      toast.style.transform = 'translateX(0)';
    });
    setTimeout(() => {
      toast.style.opacity = '0';
      toast.style.transform = 'translateX(50px)';
      toast.addEventListener('transitionend', () => toast.remove());
    }, 3000);
  }

  // Upload Elements
  const uploadIconInput = document.getElementById("uploadIcon");
  const iconHidden = document.getElementById("icon");
  const uploadStatus = document.getElementById("uploadStatus");
  const iconPreview = document.getElementById("iconPreview");
  const previewImg = document.getElementById("previewImg");

  uploadIconInput.addEventListener("change", async () => {
    const file = uploadIconInput.files[0];
    if (!file) return;

    uploadStatus.textContent = "Uploading...";
    const formData = new FormData();
    formData.append("image", file);

    try {
      const response = await fetch(`https://api.imgbb.com/1/upload?key=8604e4b4050c63c460d0bca39cf28708`, {
        method: "POST",
        body: formData
      });
      const data = await response.json();
      if (data.success) {
        iconHidden.value = data.data.url; // âœ… Save URL in hidden field
        previewImg.src = data.data.url;
        iconPreview.classList.remove("hidden");
        showToast("Image uploaded successfully!", "success");
      } else {
        showToast("Upload failed!", "error");
      }
    } catch (error) {
      showToast("Error uploading image!", "error");
      console.error(error);
    } finally {
      uploadStatus.textContent = "";
      uploadIconInput.value = "";
    }
  });

  // Auth listener
  auth.onAuthStateChanged(async user => {
    if (!user) {
      showToast('Please log in', 'error');
      setTimeout(() => window.location.href = 'signin', 1000);
      return;
    }

    const isAdmin = await db.ref(`admins/${user.uid}`).get().then(snap => snap.exists());
    if (isAdmin) {
      adminSection.classList.remove('hidden');
      loadAdminRequests();
    } else {
      userSection.classList.remove('hidden');
      loadUserChannels(user.uid);
    }
    loadPublicChannels();
  });

  // Submit channel
window.submitChannel = async function () {
  const name = document.getElementById('channel-name').value.trim();
  const url = document.getElementById('channel-url').value.trim();
  const category = document.getElementById('channel-category').value;
  const iconUrl = iconHidden.value;
  const user = auth.currentUser;

  if (!user) return showToast("User not signed in", "error");
  if (!name || !url || !iconUrl) return showToast("Fill all fields and upload image", "error");

  try {
    const requestId = db.ref('channelRequests').push().key;
    await db.ref(`channelRequests/${requestId}`).set({
      name,
      icon: iconUrl,
      stream: url,
      category,
      submittedByName: user.displayName || user.email,
      status: 'pending',
      timestamp: Date.now()
    });

    showToast('Channel request submitted', 'success');
    document.getElementById('channel-name').value = '';
    document.getElementById('channel-url').value = '';
    iconHidden.value = '';
    iconPreview.classList.add("hidden");
    previewImg.src = '';
    loadUserChannels(user.uid);
  } catch (err) {
    console.error(err);
    showToast("Failed to submit channel", "error");
  }
};

  // Load user channels
  function loadUserChannels(uid) {
    const q = db.ref('channelRequests').orderByChild('submittedBy').equalTo(uid);
    q.on('value', snap => {
      userPending.innerHTML = '';
      userApproved.innerHTML = '';
      if (!snap.exists()) return;

      const items = [];
      snap.forEach(childSnap => {
        items.push({ id: childSnap.key, ...childSnap.val() });
      });

      items.sort((a, b) => (a.timestamp || 0) - (b.timestamp || 0));

      items.forEach(c => {
        const status = (c.status || 'pending').toLowerCase();
        const card = document.createElement('div');
        card.className = 'flex items-center gap-4 p-3 bg-gray-700 rounded-xl shadow-md hover:shadow-lg transition-shadow';
        card.innerHTML = `
          <img src="${c.icon}" class="w-16 h-16 rounded-lg object-cover border border-gray-600"/>
          <div class="flex-1">
            <h4 class="font-semibold text-white">${c.name}</h4>
            <p class="text-gray-300">${c.category}</p>
          </div>
          <span class="px-2 py-1 rounded-xl text-sm ${status === 'approved' ? 'bg-green-500' : 'bg-yellow-500'}">${status}</span>
        `;
        if (status === 'pending') userPending.appendChild(card);
        else if (status === 'approved') userApproved.appendChild(card);
      });
    });
  }

 // Admin functions
window.loadAdminRequests = function () {
  const requestsRef = db.ref('channelRequests').orderByChild('status').equalTo('pending');
  requestsRef.on('value', snap => {
    adminRequestsList.innerHTML = '';
    if (!snap.exists()) {
      adminRequestsList.innerHTML = '<p class="text-gray-400 text-center py-4">No pending requests</p>';
      return;
    }
    snap.forEach(child => {
      const r = child.val();
      const li = document.createElement('div');
      li.className = 'channel-card flex flex-col md:flex-row items-start md:items-center justify-between gap-4';
      
      // Editable card
      li.innerHTML = `
        <div class="flex flex-col md:flex-row items-center gap-4 p-4 bg-gray-900 rounded-xl shadow-lg w-full max-w-4xl mx-auto border border-gray-700">
  <!-- Channel Icon Preview -->
  <div class="relative">
    <img src="${r.icon}" class="w-20 h-20 md:w-24 md:h-24 rounded-lg object-cover border border-gray-600" id="icon-preview-${child.key}" />
  </div>
  <!-- Input Fields -->
  <div class="flex-1 flex flex-col gap-3 w-full">
    <!-- Channel Name -->
    <input 
      type="text" 
      class="w-full px-4 py-2 rounded-lg bg-gray-800 text-gray-100 placeholder-gray-400 border border-gray-700 focus:outline-none focus:ring-2 focus:ring-indigo-500" 
      value="${r.name}" 
      id="name-${child.key}" 
      placeholder="Channel Name" 
    />
    <!-- Stream URL -->
    <input 
      type="text" 
      class="w-full px-4 py-2 rounded-lg bg-gray-800 text-gray-100 placeholder-gray-400 border border-gray-700 focus:outline-none focus:ring-2 focus:ring-indigo-500" 
      value="${r.url}" 
      id="url-${child.key}" 
      placeholder="Stream URL" 
    />
    <!-- Category Dropdown -->
    <select 
      id="category-${child.key}" 
      class="w-full px-4 py-2 rounded-lg bg-gray-800 text-gray-100 border border-gray-700 focus:outline-none focus:ring-2 focus:ring-indigo-500"
    >
      <option ${r.category === 'Tamil' ? 'selected' : ''}>Tamil</option>
      <option ${r.category === 'Telugu' ? 'selected' : ''}>Telugu</option>
      <option ${r.category === 'Kann