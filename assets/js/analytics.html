<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Analytics Dashboard</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <link href="https://fonts.googleapis.com/icon?family=Material+Icons" rel="stylesheet"/>
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
</head>
<body class="bg-gray-900 text-white p-6 font-sans">

  <h1 class="text-3xl font-bold mb-6">IPTV Analytics Dashboard</h1>

  <div class="grid grid-cols-1 md:grid-cols-2 gap-6">

    <!-- Top Channels Chart -->
    <div class="bg-gray-800 p-4 rounded-xl shadow-lg">
      <h2 class="text-xl font-semibold mb-4">Top Channels by Views</h2>
      <canvas id="topChannelsChart"></canvas>
    </div>

    <!-- User Interactions Chart -->
    <div class="bg-gray-800 p-4 rounded-xl shadow-lg">
      <h2 class="text-xl font-semibold mb-4">User Interactions</h2>
      <canvas id="userInteractionsChart"></canvas>
    </div>

  </div>

  <!-- Search Queries -->
  <div class="bg-gray-800 p-4 rounded-xl shadow-lg mt-6">
    <h2 class="text-xl font-semibold mb-4">Search Queries</h2>
    <ul id="searchQueries" class="space-y-1 max-h-64 overflow-y-auto"></ul>
  </div>

  <script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-app.js";
    import { getDatabase, ref, onValue } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-database.js";

    const firebaseConfig = {
      apiKey: "AIzaSyB9GaCbYFH22WbiLs1pc_UJTsM_0Tetj6E",
      authDomain: "tnm3ulive.firebaseapp.com",
      databaseURL: "https://tnm3ulive-default-rtdb.asia-southeast1.firebasedatabase.app",
      projectId: "tnm3ulive",
      storageBucket: "tnm3ulive.firebasestorage.app",
      messagingSenderId: "80664356882",
      appId: "1:80664356882:web:c8464819b0515ec9b210cb",
      measurementId: "G-FNS9JWZ9LS"
    };

    const app = initializeApp(firebaseConfig);
    const db = getDatabase(app);

    const searchQueriesList = document.getElementById("searchQueries");

    // Chart instances
    let topChannelsChart, userInteractionsChart;

    function updateTopChannelsChart(data) {
      const labels = data.map(c => c.id);
      const values = data.map(c => c.views || 0);

      if (topChannelsChart) {
        topChannelsChart.data.labels = labels;
        topChannelsChart.data.datasets[0].data = values;
        topChannelsChart.update();
      } else {
        const ctx = document.getElementById('topChannelsChart').getContext('2d');
        topChannelsChart = new Chart(ctx, {
          type: 'bar',
          data: {
            labels,
            datasets: [{
              label: 'Views',
              data: values,
              backgroundColor: 'rgba(255, 99, 132, 0.7)',
              borderColor: 'rgba(255, 99, 132, 1)',
              borderWidth: 1
            }]
          },
          options: {
            responsive: true,
            plugins: { legend: { display: false } },
            scales: {
              y: { beginAtZero: true }
            }
          }
        });
      }
    }

    function updateUserInteractionsChart(users) {
      const labels = Object.keys(users);
      const favClicks = labels.map(u => users[u].favoritesClicked || 0);
      const infoClicks = labels.map(u => users[u].infoClicked || 0);

      if (userInteractionsChart) {
        userInteractionsChart.data.labels = labels;
        userInteractionsChart.data.datasets[0].data = favClicks;
        userInteractionsChart.data.datasets[1].data = infoClicks;
        userInteractionsChart.update();
      } else {
        const ctx = document.getElementById('userInteractionsChart').getContext('2d');
        userInteractionsChart = new Chart(ctx, {
          type: 'bar',
          data: {
            labels,
            datasets: [
              { label: 'Favorites Clicked', data: favClicks, backgroundColor: 'rgba(54, 162, 235, 0.7)' },
              { label: 'Info Clicks', data: infoClicks, backgroundColor: 'rgba(255, 206, 86, 0.7)' }
            ]
          },
          options: { responsive: true, scales: { y: { beginAtZero: true } } }
        });
      }
    }

    // Fetch Channels Analytics
    onValue(ref(db, "analytics/channels"), (snapshot) => {
      if (snapshot.exists()) {
        const data = Object.entries(snapshot.val())
          .sort((a,b) => b[1].views - a[1].views)
          .map(([id, info]) => ({ id, ...info }))
          .slice(0,10); // top 10 channels
        updateTopChannelsChart(data);
      }
    });

    // Fetch User Interactions
    onValue(ref(db, "analytics/interactions"), (snapshot) => {
      searchQueriesList.innerHTML = "";
      if (snapshot.exists()) {
        const users = snapshot.val();
        updateUserInteractionsChart(users);

        // Search queries
        Object.values(users).forEach(stats => {
          if (stats.searchQueries) {
            stats.searchQueries.forEach(q => {
              const li = document.createElement("li");
              li.className = "bg-gray-700 p-1 rounded text-sm";
              li.textContent = q;
              searchQueriesList.appendChild(li);
            });
          }
        });
      }
    });

  </script>
</body>
</html>