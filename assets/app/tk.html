<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Tokens Dashboard</title>
<script type="module">
  import { initializeApp } from "https://www.gstatic.com/firebasejs/10.12.3/firebase-app.js";
  import { getDatabase, ref, get, set } from "https://www.gstatic.com/firebasejs/10.12.3/firebase-database.js";
  import { getAuth, signInWithEmailAndPassword, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/10.12.3/firebase-auth.js";

  const firebaseConfig = {
    apiKey: "AIzaSyB9GaCbYFH22WbiLs1pc_UJTsM_0Tetj6E",
    authDomain: "tnm3ulive.firebaseapp.com",
    databaseURL: "https://tnm3ulive-default-rtdb.asia-southeast1.firebasedatabase.app",
    projectId: "tnm3ulive",
    storageBucket: "tnm3ulive.firebasestorage.app",
    messagingSenderId: "80664356882",
    appId: "1:80664356882:web:c8464819b0515ec9b210cb",
    measurementId: "G-FNS9JWZ9LS"
  };

  const app = initializeApp(firebaseConfig);
  const db = getDatabase(app);
  const auth = getAuth(app);

  const latestEl = document.getElementById('latestToken');
  const historyBody = document.getElementById('historyBody');
  const statusEl = document.getElementById('status');
  const generateBtn = document.getElementById('generateBtn');

  const ADMIN_EMAIL = "admin@example.com"; // replace
  const ADMIN_PASSWORD = "YOUR_PASSWORD";  // replace

  // Generate 6-letter alphabet token (upper & lower)
  function randomToken(length = 6) {
    const chars = "ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz";
    let result = "";
    for (let i = 0; i < length; i++) {
      result += chars.charAt(Math.floor(Math.random() * chars.length));
    }
    return result;
  }

  async function isAdmin(uid) {
    try {
      const adminSnap = await get(ref(db, `admins/${uid}`));
      return adminSnap.exists();
    } catch (err) {
      console.error("Error checking admin:", err);
      return false;
    }
  }

  async function loadTokens() {
    try {
      const uid = auth.currentUser.uid;
      statusEl.textContent = "Checking admin permissions...";
      const admin = await isAdmin(uid);
      if (!admin) {
        statusEl.textContent = "Access Denied: You are not an admin.";
        latestEl.textContent = "-";
        historyBody.innerHTML = `<tr><td colspan="3">No access</td></tr>`;
        generateBtn.disabled = true;
        return;
      }

      generateBtn.disabled = false;
      statusEl.textContent = "Loading tokens...";
      const tokensRef = ref(db, 'tokens');
      const snapshot = await get(tokensRef);
      let tokensData = snapshot.val();
      let latest = null;
      let history = [];

      if (!tokensData) {
        // No token exists, generate new
        await generateAndSaveToken();
        tokensData = (await get(ref(db, 'tokens'))).val();
      }

      const sortedKeys = Object.keys(tokensData).sort((a,b)=>new Date(b)-new Date(a));
      latest = tokensData[sortedKeys[0]];
      history = sortedKeys.slice(1).map(k => tokensData[k]);

      latestEl.textContent = latest.token;

      historyBody.innerHTML = '';
      if (history.length === 0) {
        historyBody.innerHTML = `<tr><td colspan="3">No previous tokens</td></tr>`;
      } else {
        history.forEach((h, idx)=>{
          const tr = document.createElement('tr');
          tr.innerHTML = `
            <td>${idx+1}</td>
            <td>${h.token}</td>
            <td>${new Date(h.createdAt).toLocaleString()}</td>
          `;
          historyBody.appendChild(tr);
        });
      }

      statusEl.textContent = "Tokens loaded successfully.";

    } catch(err) {
      statusEl.textContent = "Error loading tokens: " + err.message;
      console.error(err);
    }
  }

  async function generateAndSaveToken() {
    const newToken = randomToken(6);
    // Safe key for Firebase
    const dateKey = new Date().toISOString().replace(/[.#$/\[\]]/g,'-');
    await set(ref(db, `tokens/${dateKey}`), { token: newToken, createdAt: new Date().toISOString() });
    return newToken;
  }

  async function generateNewToken() {
    try {
      statusEl.textContent = "Generating new token...";
      await generateAndSaveToken();
      statusEl.textContent = "New token generated successfully.";
      loadTokens();
    } catch(err) {
      statusEl.textContent = "Error generating token: " + err.message;
      console.error(err);
    }
  }

  generateBtn.addEventListener('click', generateNewToken);

  onAuthStateChanged(auth, user => {
    if (user) {
      loadTokens();
    } else {
      signInWithEmailAndPassword(auth, ADMIN_EMAIL, ADMIN_PASSWORD)
        .then(() => loadTokens())
        .catch(err => {
          statusEl.textContent = "Login failed: " + err.message;
        });
    }
  });

</script>
<script src="https://cdn.tailwindcss.com"></script>
</head>
<body class="bg-gray-50 text-gray-900">
<div class="max-w-4xl mx-auto p-6">
  <h1 class="text-2xl font-bold mb-4">Playlist Tokens Dashboard</h1>
  <div id="status" class="mb-4 text-sm text-gray-600"></div>

  <section class="bg-white p-4 rounded shadow mb-6">
    <div class="flex justify-between items-center mb-2">
      <h2 class="text-lg font-semibold">Latest Token</h2>
      <button id="generateBtn" class="bg-blue-600 text-white px-3 py-1 rounded hover:bg-blue-700 disabled:opacity-50">Generate New Token</button>
    </div>
    <pre id="latestToken" class="bg-gray-100 p-3 rounded font-mono text-lg">-</pre>
  </section>

  <section class="bg-white p-4 rounded shadow">
    <h2 class="text-lg font-semibold mb-2">Expired / Previous Tokens</h2>
    <div class="overflow-x-auto">
      <table class="min-w-full text-left">
        <thead class="text-xs uppercase text-gray-500">
          <tr>
            <th>#</th>
            <th>Token</th>
            <th>Created At</th>
          </tr>
        </thead>
        <tbody id="historyBody">
          <tr><td colspan="3">Loading...</td></tr>
        </tbody>
      </table>
    </div>
  </section>
</div>
</body>
</html>
