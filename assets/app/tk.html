<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Tokens Dashboard</title>
<script type="module">
  // Firebase v10 modular SDK
  import { initializeApp } from "https://www.gstatic.com/firebasejs/10.12.3/firebase-app.js";
  import { getDatabase, ref, get, set, push } from "https://www.gstatic.com/firebasejs/10.12.3/firebase-database.js";
  import { getAuth, signInWithEmailAndPassword, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/10.12.3/firebase-auth.js";

  const firebaseConfig = {
    apiKey: "AIzaSyB9GaCbYFH22WbiLs1pc_UJTsM_0Tetj6E",
    authDomain: "tnm3ulive.firebaseapp.com",
    databaseURL: "https://tnm3ulive-default-rtdb.asia-southeast1.firebasedatabase.app",
    projectId: "tnm3ulive",
    storageBucket: "tnm3ulive.firebasestorage.app",
    messagingSenderId: "80664356882",
    appId: "1:80664356882:web:c8464819b0515ec9b210cb",
    measurementId: "G-FNS9JWZ9LS"
  };

  const app = initializeApp(firebaseConfig);
  const db = getDatabase(app);
  const auth = getAuth(app);

  const latestEl = document.getElementById('latestToken');
  const historyBody = document.getElementById('historyBody');
  const statusEl = document.getElementById('status');

  // TODO: Replace with your admin credentials for auto-login
  const ADMIN_EMAIL = "admin@example.com";
  const ADMIN_PASSWORD = "YOUR_PASSWORD";

  function randomToken(length = 12) {
    const chars = "ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz0123456789";
    let result = "";
    for (let i = 0; i < length; i++) {
      result += chars.charAt(Math.floor(Math.random() * chars.length));
    }
    return result;
  }

  async function loadTokens() {
    try {
      statusEl.textContent = "Loading tokens...";
      const tokensRef = ref(db, 'tokens');
      const snapshot = await get(tokensRef);

      let tokensData = snapshot.val();
      let latest = null;
      let history = [];

      if (!tokensData) {
        // No token exists, generate new
        const newToken = randomToken(12);
        const dateKey = new Date().toISOString();
        await set(ref(db, `tokens/${dateKey}`), {
          token: newToken,
          createdAt: dateKey
        });
        tokensData = {};
        tokensData[dateKey] = { token: newToken, createdAt: dateKey };
      }

      // Parse tokens and history
      const sortedKeys = Object.keys(tokensData).sort((a,b)=>new Date(b)-new Date(a));
      latest = tokensData[sortedKeys[0]];
      history = sortedKeys.slice(1).map(k => tokensData[k]);

      // Display latest
      latestEl.textContent = latest.token;

      // Display history
      historyBody.innerHTML = '';
      if (history.length === 0) {
        historyBody.innerHTML = `<tr><td colspan="3">No previous tokens</td></tr>`;
      } else {
        history.forEach((h, idx)=>{
          const tr = document.createElement('tr');
          tr.innerHTML = `
            <td>${idx+1}</td>
            <td>${h.token}</td>
            <td>${new Date(h.createdAt).toLocaleString()}</td>
          `;
          historyBody.appendChild(tr);
        });
      }

      statusEl.textContent = "Tokens loaded successfully.";

    } catch(err) {
      statusEl.textContent = "Error: " + err.message;
      console.error(err);
    }
  }

  onAuthStateChanged(auth, user => {
    if (user) {
      loadTokens();
    } else {
      // Sign in automatically (only for admin testing)
      signInWithEmailAndPassword(auth, ADMIN_EMAIL, ADMIN_PASSWORD)
        .then(() => loadTokens())
        .catch(err => {
          statusEl.textContent = "Login failed: " + err.message;
        });
    }
  });

</script>
<script src="https://cdn.tailwindcss.com"></script>
</head>
<body class="bg-gray-50 text-gray-900">
<div class="max-w-4xl mx-auto p-6">
  <h1 class="text-2xl font-bold mb-4">Playlist Tokens Dashboard</h1>
  <div id="status" class="mb-4 text-sm text-gray-600"></div>

  <section class="bg-white p-4 rounded shadow mb-6">
    <h2 class="text-lg font-semibold mb-2">Latest Token</h2>
    <pre id="latestToken" class="bg-gray-100 p-3 rounded font-mono text-lg"></pre>
  </section>

  <section class="bg-white p-4 rounded shadow">
    <h2 class="text-lg font-semibold mb-2">Expired / Previous Tokens</h2>
    <div class="overflow-x-auto">
      <table class="min-w-full text-left">
        <thead class="text-xs uppercase text-gray-500">
          <tr>
            <th>#</th>
            <th>Token</th>
            <th>Created At</th>
          </tr>
        </thead>
        <tbody id="historyBody"></tbody>
      </table>
    </div>
  </section>
</div>
</body>
</html>
