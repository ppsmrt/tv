<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1, viewport-fit=cover" />
<title>Live TV - Dashboard</title>

<!-- Tailwind -->
<script src="https://cdn.tailwindcss.com"></script>

<!-- Material Icons -->
<link href="https://fonts.googleapis.com/icon?family=Material+Icons" rel="stylesheet" />

<!-- Baloo 2 -->
<link href="https://fonts.googleapis.com/css2?family=Baloo+2&display=swap" rel="stylesheet" />

<style>
  html, body {
    font-family: 'Baloo 2', cursive;
    background-color: #111827;
    color: #fff;
    margin: 0;
    min-height: 100vh;
  }
  header {
    height: 64px;
    display: flex;
    align-items: center;
    padding: 0 1.5rem;
    background: rgba(31,41,55,0.9);
    box-shadow: 0 2px 8px rgba(0,0,0,0.5);
    z-index: 50;
  }
  main {
    padding: 20px 1rem 100px;
    max-width: 1200px;
    margin: 0 auto;
  }
  .input-field {
    width: 100%;
    padding: 14px;
    border-radius: 14px;
    border: none;
    background: #1f2937;
    color: #fff;
    font-weight: 500;
    outline: none;
    transition: all 0.3s ease;
  }
  .input-field:focus {
    box-shadow: 0 0 0 3px rgba(248, 113, 113, 0.5);
    background: #111827;
  }
  .file-input::file-selector-button {
    background: #f87171;
    color: white;
    padding: 8px 16px;
    border-radius: 10px;
    border: none;
    cursor: pointer;
    font-weight: 600;
    transition: all 0.3s ease;
  }
  .file-input::file-selector-button:hover {
    background: #ef4444;
  }
  #admin-requests .channel-card {
    background: rgba(31, 41, 55, 0.85);
    border-radius: 1rem;
    padding: 1rem;
    display: flex;
    justify-content: space-between;
    align-items: center;
    gap: 1rem;
    transition: all 0.3s ease;
    box-shadow: 0 4px 15px rgba(0,0,0,0.4);
  }
  #admin-requests .channel-card:hover {
    transform: scale(1.03);
    box-shadow: 0 8px 25px rgba(0,0,0,0.6);
  }
</style>
</head>
<body>

<!-- Header -->
<header class="fixed top-0 left-0 right-0 z-50 h-16 flex items-center justify-between px-6 bg-gray-800 bg-opacity-90 backdrop-blur-md shadow-lg">
  <div class="flex items-center space-x-3">
    <span class="material-icons text-white text-3xl">account_circle</span>
    <h1 class="text-xl font-bold text-white">Dashboard</h1>
  </div>
  <div>
    <button id="logout-btn" class="flex items-center space-x-2 text-gray-200 hover:text-red-400 transition">
      <span class="material-icons text-lg">logout</span>
      <span class="font-semibold text-sm">Logout</span>
    </button>
  </div>
</header>

<!-- Main Content -->
<main class="pt-20 px-6">
  
  <!-- User Section -->
  <div id="user-section" class="hidden space-y-10">
    <!-- Submit Channel -->
    <div class="bg-gradient-to-br from-gray-800 via-gray-900 to-gray-800 p-8 rounded-3xl shadow-2xl max-w-lg mx-auto space-y-6 transform transition-all duration-300 hover:scale-105">
      <h2 class="text-3xl font-extrabold text-red-500 text-center tracking-wide">Submit a Channel</h2>
      <div class="space-y-4">
        <input type="text" id="channel-name" placeholder="Channel Name" class="input-field" />
        <div class="flex flex-col">
          <input type="file" id="channel-icon-file" accept="image/*" class="file-input" />
          <small id="upload-status" class="text-gray-400 block text-sm mt-1"></small>
        </div>
        <input type="text" id="channel-url" placeholder="Stream URL" class="input-field" />
        <select id="channel-category" class="input-field">
         <option value="">Select Category</option>
        <option value="Tamil">Tamil</option>
        <option value="Telugu">Telugu</option>
        <option value="Kannada">Kannada</option>
        <option value="Malayalam">Malayalam</option>
        <option value="Hindi">Hindi</option>
        <option value="Kids">Kids</option>
        <option value="Sports">Sports</option>
        </select>
        <button onclick="submitChannel()" class="w-full bg-red-500 hover:bg-red-600 text-white font-bold py-3 rounded-xl shadow-lg transition-all duration-300 transform hover:-translate-y-1">Submit Channel</button>
      </div>
      <!-- Tip -->
  <p class="text-xs text-gray-400 text-center">💡 Use PNG/JPG for better results. Max size 2MB.</p>
</div>
    </div>

    <!-- User Pending -->
    <div class="space-y-4 max-w-3xl mx-auto">
      <h3 class="text-2xl font-semibold border-b border-gray-700 pb-2">Pending Requests</h3>
      <div id="user-pending" class="space-y-3"></div>
    </div>

    <!-- User Approved -->
    <div class="space-y-4 max-w-3xl mx-auto">
      <h3 class="text-2xl font-semibold border-b border-gray-700 pb-2">Approved Channels</h3>
      <div id="user-approved" class="space-y-3"></div>
    </div>
  </div>

  <!-- Admin Section -->
  <div id="admin-section" class="hidden space-y-8">
    <div class="max-w-4xl mx-auto flex items-center justify-between bg-gray-800/90 backdrop-blur-sm p-5 rounded-2xl shadow-xl">
      <h2 class="text-2xl md:text-3xl font-extrabold text-red-500 tracking-wide">Pending Channel Requests</h2>
      <span class="material-icons text-white text-3xl cursor-pointer hover:text-red-400" title="Refresh" onclick="loadAdminRequests()">refresh</span>
    </div>
    <div id="admin-requests" class="space-y-4 max-w-4xl mx-auto"></div>
  </div>

<!-- Toast -->
<div id="toast-container" class="fixed bottom-6 right-6 flex flex-col gap-3 z-50"></div>

<!-- Firebase Scripts -->
<script src="https://www.gstatic.com/firebasejs/9.22.2/firebase-app-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.22.2/firebase-auth-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.22.2/firebase-database-compat.js"></script>

<!-- Dashboard JS -->
<script type="module">
  document.addEventListener('DOMContentLoaded', () => {
  const firebaseConfig = {
    apiKey: "AIzaSyB9GaCbYFH22WbiLs1pc_UJTsM_0Tetj6E",
    authDomain: "tnm3ulive.firebaseapp.com",
    databaseURL: "https://tnm3ulive-default-rtdb.asia-southeast1.firebasedatabase.app",
    projectId: "tnm3ulive",
    storageBucket: "tnm3ulive.firebasestorage.app",
    messagingSenderId: "80664356882",
    appId: "1:80664356882:web:c8464819b0515ec9b210cb",
    measurementId: "G-FNS9JWZ9LS"
  };
  firebase.initializeApp(firebaseConfig);
  const auth = firebase.auth();
  const db = firebase.database();

  const userSection = document.getElementById('user-section');
  const adminSection = document.getElementById('admin-section');
  const userPending = document.getElementById('user-pending');
  const userApproved = document.getElementById('user-approved');
  const adminRequestsList = document.getElementById('admin-requests');

  function showToast(message, type = "info") {
    const toast = document.createElement('div');
    toast.className = `
      flex items-center gap-3 px-4 py-3 rounded-xl shadow-lg text-white transition-all duration-300 transform
      opacity-0 translate-x-10
      ${type === "success" ? "bg-green-500" :
        type === "error" ? "bg-red-500" :
        "bg-gray-700"}
    `;
    const icon = document.createElement('span');
    icon.className = 'material-icons';
    icon.textContent = type === "success" ? 'check_circle' : type === "error" ? 'error' : 'info';
    toast.appendChild(icon);
    const msg = document.createElement('span');
    msg.textContent = message;
    toast.appendChild(msg);
    document.getElementById('toast-container').appendChild(toast);
    requestAnimationFrame(() => {
      toast.style.opacity = '1';
      toast.style.transform = 'translateX(0)';
    });
    setTimeout(() => {
      toast.style.opacity = '0';
      toast.style.transform = 'translateX(50px)';
      toast.addEventListener('transitionend', () => toast.remove());
    }, 3000);
  }

  // Auth listener
  auth.onAuthStateChanged(async user => {
    if (!user) {
      showToast('Please log in', 'error');
      setTimeout(() => window.location.href = 'signin', 1000);
      return;
    }

    const isAdmin = await db.ref(`admins/${user.uid}`).get().then(snap => snap.exists());
    if (isAdmin) {
      adminSection.classList.remove('hidden');
      loadAdminRequests();
    } else {
      userSection.classList.remove('hidden');
      loadUserChannels(user.uid);
    }
    loadPublicChannels();
  });

  // Upload image to ImgBB
  async function uploadToImgBB(file) {
    const formData = new FormData();
    formData.append("image", file);
    const res = await fetch("https://api.imgbb.com/1/upload?key=8604e4b4050c63c460d0bca39cf28708", {
      method: "POST", body: formData
    });
    const data = await res.json();
    if (data.success) return data.data.url;
    throw new Error("Image upload failed");
  }

  // Submit channel
  window.submitChannel = async function () {
    const name = document.getElementById('channel-name').value.trim();
    const url = document.getElementById('channel-url').value.trim();
    const category = document.getElementById('channel-category').value;
    const fileInput = document.getElementById('channel-icon-file');
    const statusText = document.getElementById('upload-status');
    const user = auth.currentUser;

    if (!user) return showToast("User not signed in", "error");
    if (!name || !url || fileInput.files.length === 0) return showToast("Fill all fields and upload image", "error");

    try {
      statusText.textContent = "Uploading image...";
      const iconUrl = await uploadToImgBB(fileInput.files[0]);
      statusText.textContent = "Image uploaded ✔";

      const requestId = db.ref('channelRequests').push().key;
      await db.ref(`channelRequests/${requestId}`).set({
        name,
        icon: iconUrl,
        url,
        category,
        submittedBy: user.uid,
        submittedByName: user.displayName || user.email,
        status: 'pending',
        timestamp: Date.now()
      });

      showToast('Channel request submitted', 'success');
      document.getElementById('channel-name').value = '';
      document.getElementById('channel-url').value = '';
      fileInput.value = '';
      statusText.textContent = '';
      loadUserChannels(user.uid);
    } catch (err) {
      console.error(err);
      statusText.textContent = "Upload failed ❌";
      showToast("Failed to upload image", "error");
    }
  };

  // Load user channels
  function loadUserChannels(uid) {
    const q = db.ref('channelRequests').orderByChild('submittedBy').equalTo(uid);
    q.on('value', snap => {
      userPending.innerHTML = '';
      userApproved.innerHTML = '';
      if (!snap.exists()) return;

      const items = [];
      snap.forEach(childSnap => {
        items.push({ id: childSnap.key, ...childSnap.val() });
      });

      items.sort((a, b) => (a.timestamp || 0) - (b.timestamp || 0));

      items.forEach(c => {
        const status = (c.status || 'pending').toLowerCase();
        const card = document.createElement('div');
        card.className = 'flex items-center gap-4 p-3 bg-gray-700 rounded-xl shadow-md hover:shadow-lg transition-shadow';
        card.innerHTML = `
          <img src="${c.icon}" class="w-16 h-16 rounded-lg object-cover border border-gray-600"/>
          <div class="flex-1">
            <h4 class="font-semibold text-white">${c.name}</h4>
            <p class="text-gray-300">${c.category}</p>
          </div>
          <span class="px-2 py-1 rounded-xl text-sm ${status === 'approved' ? 'bg-green-500' : 'bg-yellow-500'}">${status}</span>
        `;
        if (status === 'pending') userPending.appendChild(card);
        else if (status === 'approved') userApproved.appendChild(card);
      });
    });
  }

 // Admin functions
window.loadAdminRequests = function () {
  const requestsRef = db.ref('channelRequests').orderByChild('status').equalTo('pending');
  requestsRef.on('value', snap => {
    adminRequestsList.innerHTML = '';
    if (!snap.exists()) {
      adminRequestsList.innerHTML = '<p class="text-gray-400 text-center py-4">No pending requests</p>';
      return;
    }
    snap.forEach(child => {
      const r = child.val();
      const li = document.createElement('div');
      li.className = 'channel-card flex flex-col md:flex-row items-start md:items-center justify-between gap-4';
      
      // Editable card
      li.innerHTML = `
        <div class="flex items-center gap-4 flex-1">
          <img src="${r.icon}" class="w-16 h-16 rounded-lg object-cover border border-gray-600" id="icon-preview-${child.key}"/>
          <div class="flex-1 flex flex-col gap-2">
            <input type="text" class="input-field" value="${r.name}" id="name-${child.key}" placeholder="Channel Name" />
            <input type="text" class="input-field" value="${r.url}" id="url-${child.key}" placeholder="Stream URL" />
            <select id="category-${child.key}" class="input-field">
              <option ${r.category === 'News' ? 'selected' : ''}>News</option>
              <option ${r.category === 'Music' ? 'selected' : ''}>Music</option>
              <option ${r.category === 'Entertainment' ? 'selected' : ''}>Entertainment</option>
            </select>
            <input type="file" class="file-input mt-2" id="icon-file-${child.key}" accept="image/*" />
          </div>
        </div>
      `;

      const btns = document.createElement('div');
      btns.className = 'flex gap-2 mt-4 md:mt-0';
      const approve = document.createElement('button');
      approve.textContent = 'Approve';
      approve.className = 'bg-green-500 text-white px-3 py-1 rounded-lg hover:bg-green-600';
      approve.onclick = () => approveRequest(child.key, r);
      const reject = document.createElement('button');
      reject.textContent = 'Reject';
      reject.className = 'bg-red-500 text-white px-3 py-1 rounded-lg hover:bg-red-600';
      reject.onclick = () => rejectRequest(child.key);
      btns.appendChild(approve);
      btns.appendChild(reject);
      li.appendChild(btns);
      adminRequestsList.appendChild(li);
    });
  });
};

// Approve: move to channels then delete request
async function approveRequest(id, channelData) {
  try {
    // Get edited values
    const editedName = document.getElementById(`name-${id}`).value.trim() || channelData.name;
    const editedUrl = document.getElementById(`url-${id}`).value.trim() || channelData.url;
    const editedCategory = document.getElementById(`category-${id}`).value || channelData.category;
    const iconFileInput = document.getElementById(`icon-file-${id}`);

    let iconUrl = channelData.icon;

    // If new icon uploaded, upload it
    if (iconFileInput.files.length > 0) {
      const file = iconFileInput.files[0];
      iconUrl = await uploadToImgBB(file); // use existing ImgBB upload function
      document.getElementById(`icon-preview-${id}`).src = iconUrl;
    }

    // Push to channels
    const newChannelRef = db.ref('channels').push();
    await newChannelRef.set({
      name: editedName,
      icon: iconUrl,
      url: editedUrl,
      category: editedCategory,
      createdBy: channelData.submittedBy,
      createdAt: Date.now()
    });

    // Remove request
    await db.ref(`channelRequests/${id}`).remove();
    showToast(`${editedName} approved and added!`, 'success');

  } catch (err) {
    console.error(err);
    showToast("Error approving: " + err, 'error');
  }
}

  // Logout
  document.getElementById('logout-btn').addEventListener('click', async () => {
    await auth.signOut();
    showToast('Logged out', 'info');
    setTimeout(() => window.location.href = 'signin', 1000);
  });
});

</script>
</body>
</html>
