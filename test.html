<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1, viewport-fit=cover">
<title>TNM3U Admin Dashboard</title>
<script src="https://cdn.tailwindcss.com"></script>
<link href="https://fonts.googleapis.com/icon?family=Material+Icons" rel="stylesheet"/>
<link href="https://fonts.googleapis.com/css2?family=Baloo+2&display=swap" rel="stylesheet"/>
<style>
  body {
    font-family: 'Baloo 2', cursive;
    background-color: #111827;
    color: #fff;
    margin: 0;
  }
  ::selection { background: #2563eb; color: #fff; }
  ::-moz-selection { background: #2563eb; color: #fff; }
</style>
</head>
<body>

<main class="p-6 max-w-7xl mx-auto mt-12 space-y-6">

  <h1 class="text-3xl font-extrabold text-red-500 text-center mb-6">Admin Dashboard</h1>

  <!-- Channels Count by Category -->
  <div class="grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-3 gap-6" id="category-cards">
    <!-- Category cards will be inserted here -->
  </div>

  <!-- Additional Dashboard Section -->
  <div class="bg-gray-800 p-6 rounded-xl shadow-xl mt-6">
    <h2 class="text-xl font-semibold text-red-500 mb-4">Dashboard Details</h2>

    <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
      <!-- Recent Submissions -->
      <div class="bg-gray-700 p-4 rounded-lg">
        <h3 class="text-gray-200 font-semibold">Recent Submissions</h3>
        <ul class="text-gray-400 text-sm mt-2 space-y-1" id="recent-submissions">
          <li>No data yet</li>
        </ul>
      </div>

      <!-- Top Users -->
      <div class="bg-gray-700 p-4 rounded-lg">
        <h3 class="text-gray-200 font-semibold">Top Contributors</h3>
        <ul class="text-gray-400 text-sm mt-2 space-y-1" id="top-users">
          <li>No data yet</li>
        </ul>
      </div>
    </div>
  </div>

</main>

<!-- Firebase + Logic -->
<script type="module">
import { initializeApp } from "https://www.gstatic.com/firebasejs/9.22.2/firebase-app.js";
import { getDatabase, ref, onValue, child, get } from "https://www.gstatic.com/firebasejs/9.22.2/firebase-database.js";

const firebaseConfig = {
    apiKey: "AIzaSyB9GaCbYFH22WbiLs1pc_UJTsM_0Tetj6E",
    authDomain: "tnm3ulive.firebaseapp.com",
    databaseURL: "https://tnm3ulive-default-rtdb.asia-southeast1.firebasedatabase.app",
    projectId: "tnm3ulive",
    storageBucket: "tnm3ulive.firebasestorage.app",
    messagingSenderId: "80664356882",
    appId: "1:80664356882:web:c8464819b0515ec9b210cb",
    measurementId: "G-FNS9JWZ9LS"
};

const app = initializeApp(firebaseConfig);
const db = getDatabase(app);

const categories = ["Tamil","Telugu","Kannada","Malayalam","Hindi","Kids","Sports"];
const categoryCardsContainer = document.getElementById("category-cards");

// Create cards for each category
categories.forEach(cat => {
  const card = document.createElement("div");
  card.className = "bg-gray-800 p-6 rounded-xl shadow-xl flex flex-col items-center justify-center";
  card.innerHTML = `
    <span class="material-icons text-red-500 text-5xl mb-2">live_tv</span>
    <h2 class="text-2xl font-bold text-white" id="cat-${cat}-count">0</h2>
    <p class="text-gray-300 mt-1">${cat} Channels</p>
  `;
  categoryCardsContainer.appendChild(card);

  // Firebase listener for this category
  const catRef = ref(db, "channelRequests");
  onValue(catRef, snapshot => {
    let count = 0;
    snapshot.forEach(child => {
      const data = child.val();
      if(data.category === cat) count++;
    });
    document.getElementById(`cat-${cat}-count`).textContent = count;
  });
});

// Recent Submissions
const recentSubmissionsRef = ref(db, "channelRequests");
onValue(recentSubmissionsRef, snapshot => {
  const ul = document.getElementById("recent-submissions");
  ul.innerHTML = '';
  const items = [];
  snapshot.forEach(child => {
    const data = child.val();
    items.push(data);
  });
  // Sort by timestamp descending and take latest 5
  items.sort((a,b) => (b.timestamp||0) - (a.timestamp||0)).slice(0,5).forEach(item => {
    const li = document.createElement("li");
    const dateStr = item.timestamp ? new Date(item.timestamp).toLocaleString() : "No date";
    li.textContent = `${item.name} (${item.category}) — ${dateStr}`;
    ul.appendChild(li);
  });
});

// Top Users (by number of submissions)
onValue(recentSubmissionsRef, snapshot => {
  const ul = document.getElementById("top-users");
  ul.innerHTML = '';
  const userCounts = {};
  snapshot.forEach(child => {
    const user = child.val().submittedBy || "Unknown";
    userCounts[user] = (userCounts[user] || 0) + 1;
  });
  const topUsers = Object.entries(userCounts).sort((a,b) => b[1]-a[1]).slice(0,5);

  topUsers.forEach(([uid,count]) => {
    // Optionally fetch user's name if stored under /users/{uid}/name
    const userRef = ref(db, `users/${uid}/name`);
    get(userRef).then(userSnap => {
      const name = userSnap.exists() ? userSnap.val() : uid;
      const li = document.createElement("li");
      li.textContent = `${name} — ${count} submissions`;
      ul.appendChild(li);
    }).catch(() => {
      const li = document.createElement("li");
      li.textContent = `${uid} — ${count} submissions`;
      ul.appendChild(li);
    });
  });
});
</script>

</body>
</html>