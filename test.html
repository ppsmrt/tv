<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>TNM3U Admin — App UI</title>
  <meta name="robots" content="noindex, nofollow" />
  <script src="https://cdn.tailwindcss.com"></script>
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;600;700&display=swap" rel="stylesheet">
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.0/css/all.min.css"/>
  <style>
    :root{--bg:#ffffff;--muted:#6b7280;--card:#f8fafc;--accent:#2563eb}
    html,body{height:100%}
    body{font-family:Inter,system-ui,Segoe UI,Roboto,Arial;color:#0f172a;background:var(--bg);-webkit-font-smoothing:antialiased}
    .app-shell{max-width:980px;margin:18px auto;display:flex;flex-direction:column;height:calc(100vh - 36px)}
    .card{background:var(--card);border-radius:14px;box-shadow:0 6px 18px rgba(8,15,38,0.06);}
    .fab{position:fixed;right:20px;bottom:26px;background:var(--accent);color:#fff;width:64px;height:64px;border-radius:16px;display:flex;align-items:center;justify-content:center;font-size:22px;box-shadow:0 8px 22px rgba(37,99,235,0.18);}
    .toast{position:fixed;right:20px;bottom:100px;z-index:60;background:#111827;color:#fff;padding:12px 16px;border-radius:10px;box-shadow:0 8px 20px rgba(2,6,23,0.4)}
    .slide-up{transform:translateY(100%);transition:transform 320ms cubic-bezier(.2,.8,.2,1)}
    .slide-up.open{transform:translateY(0)}
    @media(min-width:768px){.layout-row{display:grid;grid-template-columns:420px 1fr;gap:18px}}
  </style>
</head>
<body>
  <div class="app-shell px-4 md:px-6">

    <!-- Top bar -->
    <header class="flex items-center justify-between py-3">
      <div class="flex items-center gap-3">
        <div class="w-10 h-10 rounded-lg bg-gradient-to-br from-blue-600 to-indigo-500 flex items-center justify-center text-white font-semibold">TN</div>
        <div>
          <div class="text-sm text-slate-500">Admin Console</div>
          <h1 class="text-xl font-semibold">TNM3U Admin</h1>
        </div>
      </div>
      <div class="flex items-center gap-3">
        <button id="logoutBtn" class="text-sm px-3 py-2 rounded-lg border border-slate-200 hover:bg-slate-50">Logout</button>
      </div>
    </header>

    <!-- Main content -->
    <div class="flex-1 layout-row gap-4">

      <!-- Left: quick form (card) -->
      <aside class="card p-4 h-full overflow-auto">
        <h2 class="font-semibold mb-3">Add / Edit Channel</h2>
        <form id="channelForm" class="space-y-3">
          <input type="hidden" id="channelId" />

          <div>
            <label class="text-sm text-slate-600">Channel name</label>
            <input id="name" class="w-full mt-1 p-3 rounded-lg border border-slate-200" placeholder="e.g., News Live" required />
          </div>

          <div>
            <label class="text-sm text-slate-600">Stream URL</label>
            <input id="stream" type="url" class="w-full mt-1 p-3 rounded-lg border border-slate-200" placeholder="https://.../stream.m3u8" required />
          </div>

          <div class="grid grid-cols-2 gap-3">
            <div>
              <label class="text-sm text-slate-600">Category</label>
              <select id="category" class="w-full mt-1 p-3 rounded-lg border border-slate-200">
                <option>Tamil</option><option>News</option><option>Movies</option><option>Sports</option><option>Music</option>
              </select>
            </div>
            <div>
              <label class="text-sm text-slate-600">Language</label>
              <select id="language" class="w-full mt-1 p-3 rounded-lg border border-slate-200">
                <option>English</option><option>Tamil</option><option>Telugu</option>
              </select>
            </div>
          </div>

          <div>
            <label class="text-sm text-slate-600">Upload icon</label>
            <div class="mt-2 relative">
              <input type="file" id="uploadIcon" accept="image/*" class="absolute inset-0 w-full h-full opacity-0 cursor-pointer" />
              <div class="p-3 rounded-lg border border-dashed border-slate-200 text-slate-400 text-sm">Click to choose or drag image</div>
            </div>
            <input type="hidden" id="icon" />
            <p id="uploadStatus" class="text-xs text-slate-400 mt-1"></p>
          </div>

          <div>
            <label class="text-sm text-slate-600">Channel type</label>
            <select id="channelType" class="w-full mt-1 p-3 rounded-lg border border-slate-200">
              <option>Entertainment</option><option>News</option><option>Sports</option><option>Local Channels</option>
            </select>
          </div>

          <div>
            <label class="text-sm text-slate-600">Country</label>
            <input id="country" class="w-full mt-1 p-3 rounded-lg border border-slate-200" placeholder="India" />
          </div>

          <div>
            <label class="text-sm text-slate-600">Tags</label>
            <input id="tags" class="w-full mt-1 p-3 rounded-lg border border-slate-200" placeholder="news, live, tamil" />
          </div>

          <div>
            <label class="text-sm text-slate-600">Description</label>
            <textarea id="description" rows="3" class="w-full mt-1 p-3 rounded-lg border border-slate-200" placeholder="Short description"></textarea>
          </div>

          <div class="flex gap-2">
            <button id="submitBtn" type="submit" class="flex-1 bg-blue-600 text-white p-3 rounded-lg">Save channel</button>
            <button id="resetBtn" type="button" class="flex-0 px-4 py-3 border rounded-lg">Clear</button>
          </div>
        </form>
      </aside>

      <!-- Right: list & controls -->
      <main class="flex-1 flex flex-col gap-4">
        <div class="card p-3 flex items-center justify-between">
          <div class="flex items-center gap-3 w-full">
            <input id="searchInput" placeholder="Search channels" class="flex-1 p-3 rounded-lg border border-slate-200" />
            <select id="filterCategory" class="p-3 rounded-lg border border-slate-200">
              <option value="All">All</option><option>News</option><option>Sports</option><option>Movies</option>
            </select>
            <select id="sortOption" class="p-3 rounded-lg border border-slate-200">
              <option value="az">A - Z</option><option value="latest">Latest</option><option value="oldest">Oldest</option>
            </select>
          </div>
        </div>

        <div class="flex-1 overflow-auto">
          <div id="channelList" class="grid grid-cols-1 sm:grid-cols-2 gap-3"></div>
        </div>
      </main>
    </div>

    <footer class="text-center text-sm text-slate-400 mt-4">IPTV Admin • TNM3U — v1.0</footer>
  </div>

  <!-- Floating add button -->
  <button id="fab" class="fab"><i class="fa-solid fa-plus"></i></button>

  <!-- Slide-up modal (mobile-style) -->
  <div id="panel" class="fixed left-0 right-0 bottom-0 z-50">
    <div id="panelInner" class="bg-white rounded-t-2xl shadow-xl slide-up p-4 md:hidden">
      <div class="flex items-center justify-between mb-3">
        <h3 class="font-semibold">Add / Edit Channel</h3>
        <button id="closePanel" class="text-slate-500"><i class="fa-solid fa-xmark"></i></button>
      </div>
      <!-- small form copy for mobile will be wired to same inputs programmatically -->
      <div class="text-sm text-slate-500">Use the main form on larger screens. Mobile slide panel mirrors the same fields.</div>
    </div>
  </div>

  <!-- Toast container (created dynamically) -->

  <!-- Firebase + logic -->
  <script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/10.12.3/firebase-app.js";
    import { getDatabase, ref, push, set, update, remove, onValue } from "https://www.gstatic.com/firebasejs/10.12.3/firebase-database.js";
    import { getAuth, signOut } from "https://www.gstatic.com/firebasejs/10.12.3/firebase-auth.js";

    // Firebase config (your project)
    const firebaseConfig = {
      apiKey: "AIzaSyB9GaCbYFH22WbiLs1pc_UJTsM_0Tetj6E",
      authDomain: "tnm3ulive.firebaseapp.com",
      databaseURL: "https://tnm3ulive-default-rtdb.asia-southeast1.firebasedatabase.app",
      projectId: "tnm3ulive",
      storageBucket: "tnm3ulive.appspot.com",
      messagingSenderId: "80664356882",
      appId: "1:80664356882:web:c8464819b0515ec9b210cb",
      measurementId: "G-FNS9JWZ9LS"
    };

    const app = initializeApp(firebaseConfig);
    const db = getDatabase(app);
    const auth = getAuth(app);

    // Elements
    const form = document.getElementById('channelForm');
    const channelList = document.getElementById('channelList');
    const submitBtn = document.getElementById('submitBtn');
    const resetBtn = document.getElementById('resetBtn');
    const fab = document.getElementById('fab');
    const panelInner = document.getElementById('panelInner');
    const closePanel = document.getElementById('closePanel');

    const nameInput = document.getElementById('name');
    const streamInput = document.getElementById('stream');
    const categoryInput = document.getElementById('category');
    const languageInput = document.getElementById('language');
    const channelTypeSelect = document.getElementById('channelType');
    const countryInput = document.getElementById('country');
    const tagsInput = document.getElementById('tags');
    const descriptionBox = document.getElementById('description');
    const uploadIconInput = document.getElementById('uploadIcon');
    const iconHidden = document.getElementById('icon');
    const uploadStatus = document.getElementById('uploadStatus');

    const filterCategory = document.getElementById('filterCategory');
    const searchInput = document.getElementById('searchInput');
    const sortOption = document.getElementById('sortOption');

    // Small mobile panel toggle
    fab.addEventListener('click', () => {
      panelInner.classList.add('open');
      // scroll to top to simulate focusing
      window.scrollTo({top:0,behavior:'smooth'});
    });
    closePanel.addEventListener('click', () => panelInner.classList.remove('open'));

    // IMGBB upload
    uploadIconInput.addEventListener('change', async () => {
      const file = uploadIconInput.files[0];
      if (!file) return;
      uploadStatus.textContent = 'Uploading...';
      const formData = new FormData();
      formData.append('image', file);
      try {
        const res = await fetch('https://api.imgbb.com/1/upload?key=4a342055cd88165647c66ee5f4350b68', {method:'POST',body:formData});
        const data = await res.json();
        if (data.success) {
          iconHidden.value = data.data.url;
          showToast('Image uploaded');
          uploadStatus.textContent = '';
        } else {
          showToast('Upload failed','error');
          uploadStatus.textContent = '';
        }
      } catch(err){
        console.error(err); showToast('Upload error','error'); uploadStatus.textContent = '';
      }
    });

    // Toast
    function showToast(msg, type='info'){
      const existing = document.querySelector('.toast'); if(existing) existing.remove();
      const t = document.createElement('div'); t.className='toast'; t.textContent=msg; document.body.appendChild(t);
      setTimeout(()=>t.remove(),3000);
    }

    // Auto tags
    function generateTags(){
      const parts = [];
      [nameInput, categoryInput, channelTypeSelect, languageInput, countryInput].forEach(el=>{ if(el?.value) el.value.split(/[ ,]+/).forEach(v=>v&&parts.push(v.toLowerCase())); });
      parts.push('tnm3u','live','stream');
      tagsInput.value = [...new Set(parts)].join(',');
    }
    [nameInput, categoryInput, channelTypeSelect, languageInput, countryInput].forEach(el=>el?.addEventListener('input',generateTags));

    // Auto description (basic)
    const descTpl = { News:name=>`${name} - live news stream on tnm3u.`, Sports:name=>`Live sports and highlights on ${name}.` };
    function autoDesc(){ const n=nameInput.value||'this channel'; const t=channelTypeSelect.value; if(descTpl[t]) descriptionBox.value = descTpl[t](n); }
    nameInput.addEventListener('input',autoDesc); channelTypeSelect.addEventListener('change',autoDesc);

    // CRUD logic
    let channelsData={};
    const channelsRef = ref(db,'channels');
    onValue(channelsRef,snap=>{ channelsData = snap.val()||{}; renderChannels(); });

    async function saveChannel(e){ e.preventDefault(); submitBtn.disabled=true; try{
        const id = document.getElementById('channelId').value;
        const now = new Date().toISOString();
        const payload = { name:nameInput.value.trim(), icon:iconHidden.value.trim(), stream:streamInput.value.trim(), category:categoryInput.value, channelType:channelTypeSelect.value, language:languageInput.value, country:countryInput.value.trim(), tags:tagsInput.value.trim(), description:descriptionBox.value.trim() };
        if(!payload.name||!payload.icon||!payload.stream){ showToast('Fill required fields','error'); submitBtn.disabled=false; return; }
        if(id){ await update(ref(db,'channels/'+id), {...payload, editedAt:now}); showToast('Updated'); }
        else{ const p=push(ref(db,'channels')); await set(p,{...payload, createdAt:now}); showToast('Saved'); }
        form.reset(); iconHidden.value='';
      }catch(err){ console.error(err); showToast('Save error','error'); }
      finally{ submitBtn.disabled=false; }
    }
    form.addEventListener('submit',saveChannel);
    resetBtn.addEventListener('click',()=>{ form.reset(); iconHidden.value=''; });

    // render
    function renderChannels(){ channelList.innerHTML=''; const q=(searchInput.value||'').toLowerCase(); const cat=filterCategory.value; const sort=sortOption.value; const arr = Object.entries(channelsData).filter(([id,ch])=>{ const okCat = cat==='All'||ch.category===cat; const okQ = ch.name.toLowerCase().includes(q); return okCat && okQ; });
      if(sort==='az') arr.sort((a,b)=>a[1].name.localeCompare(b[1].name)); else if(sort==='latest') arr.sort((a,b)=>new Date(b[1].createdAt||0)-new Date(a[1].createdAt||0)); else if(sort==='oldest') arr.sort((a,b)=>new Date(a[1].createdAt||0)-new Date(b[1].createdAt||0));
      if(!arr.length){ channelList.innerHTML='<div class="p-6 text-slate-500">No channels</div>'; return; }
      arr.forEach(([id,ch])=>{ const el=document.createElement('div'); el.className='p-3 card flex items-center gap-3'; el.innerHTML=`<img src="${ch.icon}" class="w-14 h-14 rounded-lg object-contain border"/><div class="flex-1"><div class="font-semibold">${ch.name}</div><div class="text-xs text-slate-500">${ch.category} • ${ch.channelType||'N/A'}</div></div><div class="flex gap-2"><button data-id="${id}" class="editBtn px-3 py-2 border rounded text-slate-700">Edit</button><button data-id="${id}" class="delBtn px-3 py-2 bg-red-50 text-red-600 rounded">Del</button></div>`; channelList.appendChild(el); }); attachActions(); }

    function attachActions(){ document.querySelectorAll('.editBtn').forEach(b=>b.onclick=()=>{ const id=b.dataset.id; const ch=channelsData[id]; document.getElementById('channelId').value=id; nameInput.value=ch.name; iconHidden.value=ch.icon; streamInput.value=ch.stream; categoryInput.value=ch.category; channelTypeSelect.value=ch.channelType||'Entertainment'; languageInput.value=ch.language; countryInput.value=ch.country; tagsInput.value=ch.tags||''; descriptionBox.value=ch.description||''; window.scrollTo({top:0,behavior:'smooth'}); }); document.querySelectorAll('.delBtn').forEach(b=>b.onclick=async()=>{ if(confirm('Delete channel?')){ try{ await remove(ref(db,'channels/'+b.dataset.id)); showToast('Deleted'); }catch(e){ showToast('Delete error','error'); } } }); }

    [filterCategory,searchInput,sortOption].forEach(el=>el.addEventListener('change',renderChannels)); searchInput.addEventListener('input',renderChannels);

    // logout
    document.getElementById('logoutBtn').addEventListener('click',()=>{ signOut(auth).then(()=>{ showToast('Logged out'); setTimeout(()=>location.href='/',800); }).catch(e=>showToast('Logout failed','error')); });

    // initial
    generateTags(); autoDesc();
  </script>
</body>
</html>
