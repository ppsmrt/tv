<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8"/>
<meta name="viewport" content="width=device-width, initial-scale=1, viewport-fit=cover"/>
<title>Player - Live TV</title>

<!-- Tailwind CSS -->
<script src="https://cdn.tailwindcss.com"></script>

<!-- Material Icons -->
<link href="https://fonts.googleapis.com/icon?family=Material+Icons" rel="stylesheet"/>

<!-- Baloo 2 Font -->
<link href="https://fonts.googleapis.com/css2?family=Baloo+2&display=swap" rel="stylesheet"/>

<style>
  html, body {
    font-family: 'Baloo 2', cursive;
    background-color: #1f2937; /* Tailwind gray-800 */
    color: white;
    margin: 0; padding: 0; min-height: 100vh;
  }
  #video {
    width: 100%;
    max-height: 60vh;
    background: black;
    object-fit: cover;
  }
  .controls {
    transition: opacity 0.3s;
  }
  .controls.hidden {
    opacity: 0;
    pointer-events: none;
  }
  .ad-strip {
    height: 4px;
    background-color: rgba(255,255,255,0.2);
    margin-top: 8px;
    position: relative;
    overflow-x: auto;
    white-space: nowrap;
  }
  .ad-progress {
    height: 100%;
    background-color: #f87171; /* Tailwind red-400 */
    width: 0%;
    transition: width 0.3s;
  }
  .ad-track {
    display: inline-flex;
    gap: 12px;
    padding: 4px 0;
    align-items: center;
  }
  .ad-item {
    display: flex;
    flex-direction: column;
    align-items: center;
    min-width: 120px;
    color: white;
    font-weight: 700;
    font-size: 0.75rem;
  }
  .ad-item img {
    width: 120px;
    height: 80px;
    object-fit: contain;
    border-radius: 6px;
    margin-bottom: 4px;
  }
  #controls {
    position: absolute;
    bottom: 12px;
    left: 12px;
    right: 12px;
    background: rgba(0,0,0,0.5);
    border-radius: 12px;
    padding: 8px 12px;
    display: flex;
    justify-content: space-between;
    align-items: center;
  }
  #controls .left, #controls .right {
    display: flex;
    align-items: center;
    gap: 12px;
  }
  #progressContainer {
    position: relative;
    width: 200px;
    height: 6px;
    background: #374151; /* Tailwind gray-700 */
    border-radius: 3px;
    cursor: pointer;
  }
  #progressBar {
    position: absolute;
    top: 0; left: 0; height: 100%;
    background: #ef4444; /* Tailwind red-500 */
    width: 0%;
    border-radius: 3px;
  }
  #currentTime, #duration {
    font-size: 0.875rem;
    width: 40px;
    text-align: center;
    user-select: none;
  }
  button.material-icons {
    cursor: pointer;
    font-size: 24px;
    user-select: none;
  }
  button.material-icons:hover {
    color: #ef4444;
  }
  .player-card {
    position: relative;
    max-width: 900px;
    margin: 2rem auto;
    border-radius: 12px;
    overflow: hidden;
    background: #374151; /* Tailwind gray-700 */
  }
  main {
    padding-bottom: 3rem;
  }
</style>
</head>
<body>

<main>
  <div class="player-card">
    <video id="video" playsinline webkit-playsinline></video>

    <div class="ad-strip" aria-hidden="true">
      <div id="adProgress" class="ad-progress"></div>
      <div id="adTrack" class="ad-track"></div>
    </div>

    <div id="controls" class="controls">
      <div class="left">
        <button id="playBtn" class="material-icons" aria-label="Play/Pause">play_arrow</button>
        <span id="currentTime">00:00</span>
        <div id="progressContainer" aria-label="Video progress bar" role="slider" tabindex="0" aria-valuemin="0" aria-valuemax="100" aria-valuenow="0">
          <div id="progressBar"></div>
        </div>
        <span id="duration">00:00</span>
      </div>
      <div class="right">
        <button id="pipBtn" class="material-icons" aria-label="Picture-in-Picture">picture_in_picture_alt</button>
        <button id="fsBtn" class="material-icons" aria-label="Fullscreen">fullscreen</button>
      </div>
    </div>
  </div>
</main>

<!-- Firebase and HLS.js -->
<script type="module">
  import { initializeApp } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-app.js";
  import { getDatabase, ref, onValue } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-database.js";
  import Hls from "https://cdn.jsdelivr.net/npm/hls.js@1.4.0/dist/hls.min.js";

  // Firebase config
  const firebaseConfig = {
    apiKey: "AIzaSyB9GaCbYFH22WbiLs1pc_UJTsM_0Tetj6E",
    authDomain: "tnm3ulive.firebaseapp.com",
    databaseURL: "https://tnm3ulive-default-rtdb.asia-southeast1.firebasedatabase.app",
    projectId: "tnm3ulive",
    storageBucket: "tnm3ulive.firebasestorage.app",
    messagingSenderId: "80664356882",
    appId: "1:80664356882:web:c8464819b0515ec9b210cb",
    measurementId: "G-FNS9JWZ9LS"
  };

  // Utils
  function slugify(name) {
    return name.trim().toLowerCase().replace(/[^a-z0-9\s-]/g,'').replace(/\s+/g,'-');
  }
  function formatTime(seconds) {
    if (isNaN(seconds)) return '00:00';
    const m = Math.floor(seconds / 60).toString().padStart(2, '0');
    const s = Math.floor(seconds % 60).toString().padStart(2, '0');
    return `${m}:${s}`;
  }

  // DOM elements
  const video = document.getElementById('video');
  const playBtn = document.getElementById('playBtn');
  const fsBtn = document.getElementById('fsBtn');
  const pipBtn = document.getElementById('pipBtn');
  const adTrack = document.getElementById('adTrack');
  const adProgress = document.getElementById('adProgress');
  const progressBar = document.getElementById('progressBar');
  const progressContainer = document.getElementById('progressContainer');
  const currentTimeEl = document.getElementById('currentTime');
  const durationEl = document.getElementById('duration');

  // Initialize Firebase
  const app = initializeApp(firebaseConfig);
  const db = getDatabase(app);

  // Get stream slug from URL
  const urlParams = new URLSearchParams(window.location.search);
  const streamSlug = urlParams.get('stream') || '';

  let hls;
  let ads = [];
  let adIndex = 0;
  let adInterval;

  // Load channels from Firebase
  onValue(ref(db, 'channels'), snapshot => {
    if (!snapshot.exists()) {
      alert('No channels found.');
      return;
    }
    const channels = Object.values(snapshot.val());
    let channel = channels.find(c => slugify(c.name) === streamSlug);
    if (!channel) {
      // Try partial match
      channel = channels.find(c => slugify(c.name).includes(streamSlug));
    }
    if (!channel) {
      alert('Stream not found.');
      return;
    }

    // Setup video stream
    function attachStream(url) {
      if (hls) {
        hls.destroy();
        hls = null;
      }
      if (Hls.isSupported() && url.endsWith('.m3u8')) {
        hls = new Hls({
          enableWorker: true,
          maxRetry: 8,
          fragLoadingTimeOut: 15000,
          fragLoadingMaxRetry: 8,
          startFragPrefetch: true,
        });
        hls.loadSource(url);
        hls.attachMedia(video);
        hls.on(Hls.Events.MANIFEST_PARSED, () => {
          video.play().catch(e => console.warn("Autoplay blocked:", e));
        });
        hls.on(Hls.Events.ERROR, (event, data) => {
          console.warn("HLS.js error", data);
          if (data.fatal) {
            switch (data.type) {
              case Hls.ErrorTypes.NETWORK_ERROR:
                console.warn("Network error, retrying...");
                hls.startLoad();
                break;
              case Hls.ErrorTypes.MEDIA_ERROR:
                console.warn("Media error, recovering...");
                hls.recoverMediaError();
                break;
              default:
                console.error("Cannot recover", data);
                break;
            }
          }
        });
      } else {
        // Safari fallback
        video.src = url;
        video.play().catch(e => console.warn("Autoplay blocked on Safari:", e));
      }
    }

    attachStream(channel.stream);

    // Setup ads
    ads = [
      { img: channel.icon || '', text: `Streaming ${channel.name} Live Now!` },
      { img: 'https://tvicn.wordpress.com/wp-content/uploads/2025/09/20250903_0045275084995112584913406.png', text: 'Premium Player Controls' },
      { img: 'https://via.placeholder.com/120x80?text=Ad+2', text: 'Subscribe Now' },
      { img: 'https://via.placeholder.com/120x80?text=Ad+3', text: 'New Shows' }
    ];
    adTrack.innerHTML = '';
    ads.forEach(ad => {
      const div = document.createElement('div');
      div.className = 'ad-item';
      const img = document.createElement('img');
      img.src = ad.img;
      img.alt = ad.text;
      const text = document.createElement('div');
      text.textContent = ad.text;
      div.appendChild(img);
      div.appendChild(text);
      adTrack.appendChild(div);
    });

    // Optional: Animate ad progress bar (loop)
    let adProgressPercent = 0;
    clearInterval(adInterval);
    adInterval = setInterval(() => {
      adProgressPercent += 1;
      if (adProgressPercent > 100) adProgressPercent = 0;
      adProgress.style.width = adProgressPercent + '%';
    }, 100);
  });

  // Play/pause toggle
  playBtn.addEventListener('click', () => {
    if (video.paused) {
      video.play();
      playBtn.textContent = 'pause';
    } else {
      video.pause();
      playBtn.textContent = 'play_arrow';
    }
  });

  // Update progress bar and time
  video.addEventListener('timeupdate', () => {
    if (!video.duration) return;
    const progressPercent = (video.currentTime / video.duration) * 100;
    progressBar.style.width = progressPercent + '%';
    currentTimeEl.textContent = formatTime(video.currentTime);
    durationEl.textContent = formatTime(video.duration);
    progressContainer.setAttribute('aria-valuenow', Math.floor(progressPercent));
  });

  // Seek video on progress bar click
  progressContainer.addEventListener('click', e => {
    const rect = progressContainer.getBoundingClientRect();
    const clickX = e.clientX - rect.left;
    const newTime = (clickX / rect.width) * video.duration;
    video.currentTime = newTime;
  });

  // Keyboard accessibility for progress bar
  progressContainer.addEventListener('keydown', e => {
    if (!video.duration) return;
    let newTime = video.currentTime;
    if (e.key === 'ArrowRight' || e.key === 'ArrowUp') {
      newTime = Math.min(video.currentTime + 5, video.duration);
      video.currentTime = newTime;
      e.preventDefault();
    } else if (e.key === 'ArrowLeft' || e.key === 'ArrowDown') {
      newTime = Math.max(video.currentTime - 5, 0);
      video.currentTime = newTime;
      e.preventDefault();
    }
  });

  // Fullscreen toggle
  fsBtn.addEventListener('click', () => {
    if (!document.fullscreenElement) {
      video.parentElement.requestFullscreen();
    } else {
      document.exitFullscreen();
    }
  });

  // Picture-in-Picture toggle
  pipBtn.addEventListener('click', async () => {
    try {
      if (document.pictureInPictureElement) {
        await document.exitPictureInPicture();
      } else {
        await video.requestPictureInPicture();
      }
    } catch (err) {
      console.warn('PiP not supported or failed:', err);
    }
  });

  // Auto-hide controls after inactivity
  let controlsTimeout;
  const controls = document.getElementById('controls');
  function showControls() {
    controls.classList.remove('hidden');
    clearTimeout(controlsTimeout);
    controlsTimeout = setTimeout(() => controls.classList.add('hidden'), 3000);
  }
  video.addEventListener('mousemove', showControls);
  video.addEventListener('touchstart', showControls);
  showControls();

  // Initialize play button icon based on video state
  video.addEventListener('play', () => playBtn.textContent = 'pause');
  video.addEventListener('pause', () => playBtn.textContent = 'play_arrow');

</script>

</body>
</html>
