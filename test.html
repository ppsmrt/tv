<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8"/>
<meta name="viewport" content="width=device-width, initial-scale=1, viewport-fit=cover"/>
<title>Player - Live TV</title>

<!-- Tailwind CSS -->
<script src="https://cdn.tailwindcss.com"></script>
<link href="https://fonts.googleapis.com/icon?family=Material+Icons" rel="stylesheet"/>
<style>
  body {
    font-family: 'SF Pro Display', -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, Oxygen, Ubuntu, Cantarell, "Open Sans", "Helvetica Neue", sans-serif;
    background: #111827;
    color: white;
    margin: 0;
    min-height: 100vh;
    display: flex;
    flex-direction: column;
  }
  header {
    position: fixed;
    top:0; left:0; right:0;
    height:64px;
    background: rgba(17,24,39,0.95);
    backdrop-filter: blur(6px);
    display:flex;
    align-items:center;
    padding:0 1rem;
    z-index:100;
  }
  header h1 {
    font-size:1.25rem;
    font-weight:700;
    flex:1;
  }
  video {
    width:100%;
    height:auto;
    max-height: calc(100vh - 120px);
    background:black;
  }
  main {
    padding-top:64px;
    flex:1;
    display:flex;
    flex-direction:column;
    align-items:center;
    justify-content:center;
  }
</style>
</head>
<body>

<header>
  <button onclick="history.back()" class="material-icons mr-4 text-blue-400">arrow_back</button>
  <h1 id="channelName">Loading...</h1>
</header>

<main>
  <video id="player" controls autoplay></video>
  <div id="channelInfo" class="mt-4 flex items-center space-x-3">
    <img id="channelLogo" src="" alt="" class="w-12 h-12 rounded-lg hidden"/>
    <span id="channelTitle" class="text-lg font-semibold"></span>
  </div>
</main>

<script type="module">
  // Firebase SDK imports
  import { initializeApp } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-app.js";
  import { getDatabase, ref, onValue } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-database.js";

  // Firebase config (same as index)
  const firebaseConfig = {
    apiKey: "AIzaSyB9GaCbYFH22WbiLs1pc_UJTsM_0Tetj6E",
    authDomain: "tnm3ulive.firebaseapp.com",
    databaseURL: "https://tnm3ulive-default-rtdb.asia-southeast1.firebasedatabase.app",
    projectId: "tnm3ulive",
    storageBucket: "tnm3ulive.firebasestorage.app",
    messagingSenderId: "80664356882",
    appId: "1:80664356882:web:c8464819b0515ec9b210cb",
    measurementId: "G-FNS9JWZ9LS"
  };

  // Init Firebase
  const app = initializeApp(firebaseConfig);
  const db = getDatabase(app);

  // UI elements
  const player = document.getElementById('player');
  const channelNameEl = document.getElementById('channelName');
  const channelTitleEl = document.getElementById('channelTitle');
  const channelLogoEl = document.getElementById('channelLogo');

  // Get channel name from query (?gr-tv)
  const query = window.location.search.substring(1); // remove "?"
  const requestedName = query.toLowerCase();

  // Fetch channels
  const channelsRef = ref(db, 'channels');
  onValue(channelsRef, snapshot => {
    if (snapshot.exists()) {
      const data = snapshot.val();
      const channels = Object.values(data);

      // Find matching channel by slug (name with dashes)
      const channel = channels.find(c =>
        c.name.toLowerCase().replace(/\s+/g, '-') === requestedName
      );

      if (channel) {
        channelNameEl.textContent = channel.name;
        channelTitleEl.textContent = channel.name;
        if (channel.icon) {
          channelLogoEl.src = channel.icon;
          channelLogoEl.alt = channel.name + " logo";
          channelLogoEl.classList.remove("hidden");
        }
        if (channel.stream) {
          player.src = channel.stream;
        } else {
          player.outerHTML = "<p class='text-gray-400 text-center mt-6'>No stream available.</p>";
        }
      } else {
        channelNameEl.textContent = "Channel not found";
        player.outerHTML = "<p class='text-gray-400 text-center mt-6'>This channel does not exist.</p>";
      }
    } else {
      channelNameEl.textContent = "No channels available";
      player.outerHTML = "<p class='text-gray-400 text-center mt-6'>No channels in database.</p>";
    }
  });
</script>
</body>
</html>