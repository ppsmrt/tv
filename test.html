document.addEventListener('DOMContentLoaded', () => {
  const firebaseConfig = {
    apiKey: "AIzaSyB9GaCbYFH22WbiLs1pc_UJTsM_0Tetj6E",
    authDomain: "tnm3ulive.firebaseapp.com",
    databaseURL: "https://tnm3ulive-default-rtdb.asia-southeast1.firebasedatabase.app",
    projectId: "tnm3ulive",
    storageBucket: "tnm3ulive.firebasestorage.app",
    messagingSenderId: "80664356882",
    appId: "1:80664356882:web:c8464819b0515ec9b210cb",
    measurementId: "G-FNS9JWZ9LS"
  };
  firebase.initializeApp(firebaseConfig);
  const auth = firebase.auth();
  const db = firebase.database();

  const userSection = document.getElementById('user-section');
  const adminSection = document.getElementById('admin-section');
  const userPending = document.getElementById('user-pending');
  const userApproved = document.getElementById('user-approved');
  const adminRequestsList = document.getElementById('admin-requests');

  function showToast(message, type = "info") {
    const toast = document.createElement('div');
    toast.className = `
      flex items-center gap-3 px-4 py-3 rounded-xl shadow-lg text-white transition-all duration-300 transform
      opacity-0 translate-x-10
      ${type === "success" ? "bg-green-500" :
        type === "error" ? "bg-red-500" :
        "bg-gray-700"}
    `;
    const icon = document.createElement('span');
    icon.className = 'material-icons';
    icon.textContent = type === "success" ? 'check_circle' : type === "error" ? 'error' : 'info';
    toast.appendChild(icon);
    const msg = document.createElement('span');
    msg.textContent = message;
    toast.appendChild(msg);
    document.getElementById('toast-container').appendChild(toast);
    requestAnimationFrame(() => {
      toast.style.opacity = '1';
      toast.style.transform = 'translateX(0)';
    });
    setTimeout(() => {
      toast.style.opacity = '0';
      toast.style.transform = 'translateX(50px)';
      toast.addEventListener('transitionend', () => toast.remove());
    }, 3000);
  }

  // Auth listener
  auth.onAuthStateChanged(async user => {
    if (!user) {
      showToast('Please log in', 'error');
      setTimeout(() => window.location.href = 'signin', 1000);
      return;
    }

    const isAdmin = await db.ref(`admins/${user.uid}`).get().then(snap => snap.exists());
    if (isAdmin) {
      adminSection.classList.remove('hidden');
      loadAdminRequests();
    } else {
      userSection.classList.remove('hidden');
      loadUserChannels(user.uid);
    }
    loadPublicChannels();
  });

  // Upload image to ImgBB
  async function uploadToImgBB(file) {
    const formData = new FormData();
    formData.append("image", file);
    const res = await fetch("https://api.imgbb.com/1/upload?key=8604e4b4050c63c460d0bca39cf28708", {
      method: "POST", body: formData
    });
    const data = await res.json();
    if (data.success) return data.data.url;
    throw new Error("Image upload failed");
  }

  // Submit channel
  window.submitChannel = async function () {
    const name = document.getElementById('channel-name').value.trim();
    const url = document.getElementById('channel-url').value.trim();
    const category = document.getElementById('channel-category').value;
    const fileInput = document.getElementById('channel-icon-file');
    const statusText = document.getElementById('upload-status');
    const user = auth.currentUser;

    if (!user) return showToast("User not signed in", "error");
    if (!name || !url || fileInput.files.length === 0) return showToast("Fill all fields and upload image", "error");

    try {
      statusText.textContent = "Uploading image...";
      const iconUrl = await uploadToImgBB(fileInput.files[0]);
      statusText.textContent = "Image uploaded ✔";

      const requestId = db.ref('channelRequests').push().key;
      await db.ref(`channelRequests/${requestId}`).set({
        name,
        icon: iconUrl,
        url,
        category,
        submittedBy: user.uid,
        submittedByName: user.displayName || user.email,
        status: 'pending',
        timestamp: Date.now()
      });

      showToast('Channel request submitted', 'success');
      document.getElementById('channel-name').value = '';
      document.getElementById('channel-url').value = '';
      fileInput.value = '';
      statusText.textContent = '';
      loadUserChannels(user.uid);
    } catch (err) {
      console.error(err);
      statusText.textContent = "Upload failed ❌";
      showToast("Failed to upload image", "error");
    }
  };

  // Load user channels
  function loadUserChannels(uid) {
    const q = db.ref('channelRequests').orderByChild('submittedBy').equalTo(uid);
    q.on('value', snap => {
      userPending.innerHTML = '';
      userApproved.innerHTML = '';
      if (!snap.exists()) return;

      const items = [];
      snap.forEach(childSnap => {
        items.push({ id: childSnap.key, ...childSnap.val() });
      });

      items.sort((a, b) => (a.timestamp || 0) - (b.timestamp || 0));

      items.forEach(c => {
        const status = (c.status || 'pending').toLowerCase();
        const card = document.createElement('div');
        card.className = 'flex items-center gap-4 p-3 bg-gray-700 rounded-xl shadow-md hover:shadow-lg transition-shadow';
        card.innerHTML = `
          <img src="${c.icon}" class="w-16 h-16 rounded-lg object-cover border border-gray-600"/>
          <div class="flex-1">
            <h4 class="font-semibold text-white">${c.name}</h4>
            <p class="text-gray-300">${c.category}</p>
          </div>
          <span class="px-2 py-1 rounded-xl text-sm ${status === 'approved' ? 'bg-green-500' : 'bg-yellow-500'}">${status}</span>
        `;
        if (status === 'pending') userPending.appendChild(card);
        else if (status === 'approved') userApproved.appendChild(card);
      });
    });
  }

  // Load public channels
  function loadPublicChannels() {
    const publicChannels = document.getElementById('public-channels');
    db.ref('channels').on('value', snap => {
      publicChannels.innerHTML = '';
      if (!snap.exists()) {
        publicChannels.innerHTML = '<p class="text-gray-400 text-center py-4">No channels available</p>';
        return;
      }
      snap.forEach(child => {
        const c = child.val();
        const card = document.createElement('div');
        card.className = 'bg-gray-800 rounded-xl p-4 shadow-lg hover:shadow-2xl transition-all';
        card.innerHTML = `
          <img src="${c.icon}" class="w-full h-40 object-cover rounded-lg mb-3"/>
          <h4 class="font-semibold text-white text-lg">${c.name}</h4>
          <p class="text-gray-400">${c.category}</p>
          <a href="${c.url}" target="_blank" class="text-red-400 font-bold hover:underline block mt-2">Watch Now</a>
        `;
        publicChannels.appendChild(card);
      });
    });
  }

  // Admin functions
  window.loadAdminRequests = function () {
    const requestsRef = db.ref('channelRequests').orderByChild('status').equalTo('pending');
    requestsRef.on('value', snap => {
      adminRequestsList.innerHTML = '';
      if (!snap.exists()) {
        adminRequestsList.innerHTML = '<p class="text-gray-400 text-center py-4">No pending requests</p>';
        return;
      }
      snap.forEach(child => {
        const r = child.val();
        const li = document.createElement('div');
        li.className = 'channel-card';
        li.innerHTML = `
          <div class="flex items-center gap-4">
            <img src="${r.icon}" class="w-16 h-16 rounded-lg object-cover border border-gray-600"/>
            <div>
              <h4 class="font-semibold text-white">${r.name}</h4>
              <p class="text-gray-300">${r.category}</p>
            </div>
          </div>
        `;
        const btns = document.createElement('div');
        btns.className = 'flex gap-2';
        const approve = document.createElement('button');
        approve.textContent = 'Approve';
        approve.className = 'bg-green-500 text-white px-3 py-1 rounded-lg hover:bg-green-600';
        approve.onclick = () => approveRequest(child.key, r);
        const reject = document.createElement('button');
        reject.textContent = 'Reject';
        reject.className = 'bg-red-500 text-white px-3 py-1 rounded-lg hover:bg-red-600';
        reject.onclick = () => rejectRequest(child.key);
        btns.appendChild(approve);
        btns.appendChild(reject);
        li.appendChild(btns);
        adminRequestsList.appendChild(li);
      });
    });
  };

  // Approve: move to channels then delete request
  async function approveRequest(id, channelData) {
    try {
      const newChannelRef = db.ref('channels').push();
      await newChannelRef.set({
        name: channelData.name,
        icon: channelData.icon,
        url: channelData.url,
        category: channelData.category,
        createdBy: channelData.submittedBy,
        createdAt: Date.now()
      });
      await db.ref(`channelRequests/${id}`).remove();
      showToast(`${channelData.name} approved and added!`, 'success');
    } catch (err) {
      console.error(err);
      showToast("Error approving: " + err, 'error');
    }
  }

  // Reject: delete request
  async function rejectRequest(requestId) {
    try {
      await db.ref(`channelRequests/${requestId}`).remove();
      showToast("Request deleted successfully.", "success");
    } catch (err) {
      console.error(err);
      showToast("Error deleting: " + err, "error");
    }
  }

  // Logout
  document.getElementById('logout-btn').addEventListener('click', async () => {
    await auth.signOut();
    showToast('Logged out', 'info');
    setTimeout(() => window.location.href = 'signin', 1000);
  });
});
