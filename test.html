<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8"/>
<meta name="viewport" content="width=device-width, initial-scale=1, viewport-fit=cover"/>
<title>Player - Live TV</title>

<!-- Tailwind CSS -->
<script src="https://cdn.tailwindcss.com"></script>

<!-- Material Icons -->
<link href="https://fonts.googleapis.com/icon?family=Material+Icons" rel="stylesheet"/>

<!-- Baloo 2 Font -->
<link href="https://fonts.googleapis.com/css2?family=Baloo+2&display=swap" rel="stylesheet"/>

<style>
  html, body { font-family: 'Baloo 2', cursive; }
  body { background-color: #1f2937; color: #fff; min-height: 100vh; display: flex; flex-direction: column; }

  header { position: fixed; top:0; left:0; right:0; z-index:50; background:#d92a1a; padding:1rem; display:flex; justify-content:space-between; align-items:center; }
  header h1 { font-weight:700; font-size:1.5rem; }
  .close-btn { color:white; display:flex; align-items:center; gap:0.25rem; text-decoration:none; font-weight:500; }

  main { flex:1; padding-top:4rem; padding-bottom:4rem; }
  .player-card { margin:1rem; background:#374151; border-radius:1rem; overflow:hidden; }
  .video-wrap { position:relative; }
  video { width:100%; max-height:60vh; object-fit:cover; background:black; }

  .controls { position:absolute; bottom:0.5rem; left:0.5rem; right:0.5rem; display:flex; justify-content:space-between; align-items:center; background:rgba(0,0,0,0.5); padding:0.5rem; border-radius:0.5rem; transition:opacity 0.3s; }
  .controls.hidden { opacity:0; pointer-events:none; }
  .icon-btn { background:none; border:none; color:white; cursor:pointer; }

  .ad-strip { height:4px; background:rgba(255,255,255,0.2); margin-top:0.5rem; overflow:hidden; }
  .ad-track { display:flex; gap:0.5rem; transition:transform 0.5s linear; }
  .ad-item { display:flex; flex-direction:column; align-items:center; font-size:0.75rem; color:#fff; min-width:80px; }

  footer { display:flex; justify-content:space-around; align-items:center; background:#111827; padding:0.5rem 0; position:fixed; bottom:0; left:0; right:0; }
  .bottom-nav-btn { background:none; border:none; color:#9ca3af; display:flex; flex-direction:column; align-items:center; font-size:0.75rem; cursor:pointer; }
  .bottom-nav-btn.active { color:#f87171; }
</style>
</head>

<body>
<header>
  <h1 id="channelTitle">Player</h1>
  <a class="close-btn" href="index.html"><span class="material-icons">close</span>Close</a>
</header>

<main>
  <div class="player-card">
    <div class="video-wrap" id="videoWrap">
      <video id="video" playsinline webkit-playsinline></video>
      <div class="controls" id="controls">
        <div class="left">
          <button id="playBtn" class="icon-btn" aria-label="Play/Pause"><span class="material-icons">play_arrow</span></button>
        </div>
        <div class="right">
          <button id="pipBtn" class="icon-btn" aria-label="Picture-in-Picture"><span class="material-icons">picture_in_picture_alt</span></button>
          <button id="fsBtn" class="icon-btn" aria-label="Fullscreen"><span class="material-icons">fullscreen</span></button>
        </div>
      </div>
    </div>
    <div class="ad-strip"><div class="ad-track" id="adTrack"></div></div>
  </div>
</main>

<footer>
  <button class="bottom-nav-btn" onclick="window.location.href='index.html'"><span class="material-icons">home</span>Home</button>
  <button class="bottom-nav-btn active"><span class="material-icons">live_tv</span>Live</button>
  <button class="bottom-nav-btn"><span class="material-icons">search</span>Search</button>
  <button class="bottom-nav-btn" onclick="window.location.href='signin.html'"><span class="material-icons">person</span>Profile</button>
</footer>

<script type="module">
import { initializeApp } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-app.js";
import { getDatabase, ref, onValue } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-database.js";
import Hls from 'https://cdn.jsdelivr.net/npm/hls.js@1.4.0/dist/hls.min.js';

const firebaseConfig = {
    apiKey: "AIzaSyB9GaCbYFH22WbiLs1pc_UJTsM_0Tetj6E",
    authDomain: "tnm3ulive.firebaseapp.com",
    databaseURL: "https://tnm3ulive-default-rtdb.asia-southeast1.firebasedatabase.app",
    projectId: "tnm3ulive",
    storageBucket: "tnm3ulive.firebasestorage.app",
    messagingSenderId: "80664356882",
    appId: "1:80664356882:web:c8464819b0515ec9b210cb",
    measurementId: "G-FNS9JWZ9LS"
};

const app = initializeApp(firebaseConfig);
const db = getDatabase(app);

// Utils
function qs(name){ const u=new URL(location.href); return u.searchParams.get(name); }
function slugify(name){ return name.trim().toLowerCase().replace(/[^a-z0-9\s-]/g,'').replace(/\s+/g,'-'); }

// DOM
const video = document.getElementById('video');
const playBtn = document.getElementById('playBtn');
const fsBtn = document.getElementById('fsBtn');
const pipBtn = document.getElementById('pipBtn');
const channelTitle = document.getElementById('channelTitle');
const adTrack = document.getElementById('adTrack');
const controls = document.getElementById('controls');

let controlsTimeout;
video.volume = 0.5;

// Fetch stream from Firebase
const streamSlug = qs('stream') || '';
onValue(ref(db,'channels'), snapshot=>{
    if(!snapshot.exists()) return;
    const data = snapshot.val();
    const list = Object.values(data).map(c=>({ name:c.name, logo:c.icon, url:c.stream }));
    let match = list.find(ch=>slugify(ch.name) === streamSlug);
    if(!match) match = list.find(ch=>slugify(ch.name).includes(streamSlug));
    if(!match){ channelTitle.textContent='Stream not found'; return; }

    channelTitle.textContent = match.name;

    // HLS Streaming
    const url = match.url;
    if(Hls.isSupported() && url.endsWith('.m3u8')){
        const hls = new Hls({ enableWorker:true, maxRetry:8, fragLoadingTimeOut:15000, startFragPrefetch:true });
        hls.loadSource(url);
        hls.attachMedia(video);
        hls.on(Hls.Events.MANIFEST_PARSED, ()=>video.play().catch(e=>console.warn("Autoplay blocked:",e)));
        hls.on(Hls.Events.ERROR, (event,data)=>{
            if(data.fatal){
                switch(data.type){
                    case Hls.ErrorTypes.NETWORK_ERROR: hls.startLoad(); break;
                    case Hls.ErrorTypes.MEDIA_ERROR: hls.recoverMediaError(); break;
                    default: console.error("Cannot recover HLS",data); break;
                }
            }
        });
    } else { video.src = url; video.play().catch(e=>console.warn("Autoplay blocked:",e)); }

    // Ads
    const ads = [
        {img:match.logo,text:`Streaming ${match.name} Live Now!`},
        {img:'https://tvicn.wordpress.com/wp-content/uploads/2025/09/20250903_0045275084995112584913406.png',text:'Premium Player Controls'},
        {img:'https://via.placeholder.com/120x80?text=Ad+2',text:'Subscribe Now'},
        {img:'https://via.placeholder.com/120x80?text=Ad+3',text:'New Shows'}
    ];
    adTrack.innerHTML='';
    ads.concat(ads).forEach(a=>{
        const div=document.createElement('div');
        div.className='ad-item';
        const im=document.createElement('img'); im.src=a.img; im.alt=a.text;
        const t=document.createElement('div'); t.textContent=a.text; t.style.fontWeight='700';
        div.appendChild(im); div.appendChild(t);
        adTrack.appendChild(div);
    });
});

// Controls
playBtn.addEventListener('click', ()=>{ if(video.paused){ video.play(); playBtn.querySelector('span').textContent='pause'; } else { video.pause(); playBtn.querySelector('span').textContent='play_arrow'; }});
fsBtn.addEventListener('click', ()=>{ if(!document.fullscreenElement) video.parentElement.requestFullscreen(); else document.exitFullscreen(); });
pipBtn.addEventListener('click', async ()=>{ if(document.pictureInPictureElement) await document.exitPictureInPicture(); else await video.requestPictureInPicture(); });
const showControls=()=>{ controls.classList.remove('hidden'); clearTimeout(controlsTimeout); controlsTimeout=setTimeout(()=>controls.classList.add('hidden'),3000); };
video.addEventListener('mousemove',showControls);
video.addEventListener('touchstart',showControls);
</script>
</body>
</html>