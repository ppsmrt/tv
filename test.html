<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8"/>
<meta name="viewport" content="width=device-width, initial-scale=1, viewport-fit=cover"/>
<title>Live TV - Dashboard</title>

<!-- Tailwind -->
<script src="https://cdn.tailwindcss.com"></script>

<!-- Material Icons -->
<link href="https://fonts.googleapis.com/icon?family=Material+Icons" rel="stylesheet"/>

<!-- Baloo 2 -->
<link href="https://fonts.googleapis.com/css2?family=Baloo+2&display=swap" rel="stylesheet"/>

<style>
  html, body {
    font-family: 'Baloo 2', cursive;
    background-color: #111827;
    color: #fff;
    margin: 0;
    min-height: 100vh;
  }
  header {
    height: 64px;
    display: flex;
    align-items: center;
    padding: 0 1.5rem;
    background: rgba(31,41,55,0.9);
    box-shadow: 0 2px 8px rgba(0,0,0,0.5);
    z-index: 20;
    justify-content: space-between;
  }
  main {
    padding: 20px 1rem 100px;
    max-width: 1200px;
    margin: 0 auto;
  }
  input, select, button {
    width: 100%;
    padding: 12px;
    margin: 6px 0;
    border-radius: 12px;
    border: none;
    background: #1f2937;
    color: white;
    font-weight: 500;
    outline: none;
  }
  input::file-selector-button {
    background: #f87171;
    color: white;
    padding: 6px 12px;
    border-radius: 8px;
    border: none;
    margin-right: 10px;
    cursor: pointer;
    font-weight: 600;
  }
  button {
    background: #f87171;
    font-weight: 700;
    transition: background 0.3s ease;
  }
  button:hover {
    background: #ef4444;
  }
.input-field {
    width: 100%;
    padding: 14px;
    border-radius: 14px;
    border: none;
    background: #1f2937;
    color: #fff;
    font-weight: 500;
    outline: none;
    transition: all 0.3s ease;
  }
  .input-field:focus {
    box-shadow: 0 0 0 3px rgba(248, 113, 113, 0.5);
    background: #111827;
  }
  .file-input::file-selector-button {
    background: #f87171;
    color: white;
    padding: 8px 16px;
    border-radius: 10px;
    border: none;
    cursor: pointer;
    font-weight: 600;
    transition: all 0.3s ease;
  }
  .file-input::file-selector-button:hover {
    background: #ef4444;
  }
/* Admin card hover effect */
  #admin-requests .channel-card {
    background: rgba(31, 41, 55, 0.85);
    border-radius: 1rem;
    padding: 1rem;
    display: flex;
    flex-wrap: wrap;
    justify-content: space-between;
    align-items: center;
    gap: 1rem;
    transition: all 0.3s ease;
    box-shadow: 0 4px 15px rgba(0,0,0,0.4);
  }

  #admin-requests .channel-card:hover {
    transform: scale(1.03);
    box-shadow: 0 8px 25px rgba(0,0,0,0.6);
  }

  /* Buttons inside admin cards */
  #admin-requests button {
    padding: 0.5rem 1rem;
    border-radius: 0.75rem;
    font-weight: 600;
    transition: all 0.3s ease;
  }
  #admin-requests .approve-btn {
    background-color: #22c55e;
  }
  #admin-requests .approve-btn:hover {
    background-color: #16a34a;
    transform: translateY(-2px);
  }
  #admin-requests .reject-btn {
    background-color: #ef4444;
  }
  #admin-requests .reject-btn:hover {
    background-color: #dc2626;
    transform: translateY(-2px);
  }


</style>
</head>
<body>

<!-- Header -->
<header>
  <div class="flex items-center gap-2">
    <span class="material-icons text-white text-3xl">live_tv</span>
    <h1 class="text-xl font-bold text-white">Live TV Dashboard</h1>
  </div>
  <span id="logout-btn" class="material-icons text-white text-2xl cursor-pointer hover:text-red-500" title="Logout">
    logout
  </span>
</header>

<!-- Welcome -->
<div class="bg-gray-800/80 px-6 py-3 border-b border-gray-700">
  <p id="welcome-msg" class="text-lg font-semibold">Welcome, User</p>
</div>

<main>
  <!-- User Section -->
  <!-- User Section -->
<div id="user-section" class="hidden space-y-10">

  <!-- Submit Channel Card -->
  <div class="bg-gradient-to-br from-gray-800 via-gray-900 to-gray-800 p-8 rounded-3xl shadow-2xl max-w-lg mx-auto space-y-6 transform transition-all duration-300 hover:scale-105">
    <h2 class="text-3xl font-extrabold text-red-500 text-center tracking-wide">Submit a Channel</h2>

    <div class="space-y-4">
      <input type="text" id="channel-name" placeholder="Channel Name" class="input-field"/>
      
      <!-- File Upload for Icon -->
      <div class="flex flex-col">
        <input type="file" id="channel-icon-file" accept="image/*" class="file-input"/>
        <small id="upload-status" class="text-gray-400 block text-sm mt-1"></small>
      </div>

      <input type="text" id="channel-url" placeholder="Stream URL" class="input-field"/>
      
      <select id="channel-category" class="input-field">
        <option value="News">News</option>
        <option value="Music">Music</option>
        <option value="Entertainment">Entertainment</option>
      </select>

      <button onclick="submitChannel()" class="w-full bg-red-500 hover:bg-red-600 text-white font-bold py-3 rounded-xl shadow-lg transition-all duration-300 transform hover:-translate-y-1">
        Submit Channel
      </button>
    </div>
  </div>

  <!-- Pending Requests -->
  <div class="space-y-4 max-w-3xl mx-auto">
    <h3 class="text-2xl font-semibold border-b border-gray-700 pb-2">Pending Requests</h3>
    <div id="user-pending" class="space-y-3"></div>
  </div>

  <!-- Approved Channels -->
  <div class="space-y-4 max-w-3xl mx-auto">
    <h3 class="text-2xl font-semibold border-b border-gray-700 pb-2">Approved Channels</h3>
    <div id="user-approved" class="space-y-3"></div>
  </div>
</div>

  <!-- Admin Section -->
  <!-- Admin Section -->
<div id="admin-section" class="hidden space-y-8">

  <!-- Section Header -->
  <div class="max-w-4xl mx-auto flex items-center justify-between bg-gray-800/90 backdrop-blur-sm p-5 rounded-2xl shadow-xl">
    <h2 class="text-2xl md:text-3xl font-extrabold text-red-500 tracking-wide">Pending Channel Requests</h2>
    <span class="material-icons text-white text-3xl cursor-pointer hover:text-red-400" title="Refresh" onclick="loadAdminRequests()">refresh</span>
  </div>

  <!-- Requests List -->
  <div id="admin-requests" class="space-y-4 max-w-4xl mx-auto">
    <!-- Cards will be dynamically injected here via JS -->
  </div>
</div>


<!-- Firebase -->
<script src="https://www.gstatic.com/firebasejs/9.22.2/firebase-app-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.22.2/firebase-auth-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.22.2/firebase-database-compat.js"></script>

<script>
const firebaseConfig = {
  apiKey: "AIzaSyB9GaCbYFH22WbiLs1pc_UJTsM_0Tetj6E",
  authDomain: "tnm3ulive.firebaseapp.com",
  databaseURL: "https://tnm3ulive-default-rtdb.asia-southeast1.firebasedatabase.app",
  projectId: "tnm3ulive",
  storageBucket: "tnm3ulive.firebasestorage.app",
  messagingSenderId: "80664356882",
  appId: "1:80664356882:web:c8464819b0515ec9b210cb",
  measurementId: "G-FNS9JWZ9LS"
};
firebase.initializeApp(firebaseConfig);
const auth = firebase.auth();
const db = firebase.database();

const userSection = document.getElementById('user-section');
const adminSection = document.getElementById('admin-section');
const welcomeMsg = document.getElementById('welcome-msg');
const userPending = document.getElementById('user-pending');
const userApproved = document.getElementById('user-approved');
const adminRequestsList = document.getElementById('admin-requests');

// Auth Listener
auth.onAuthStateChanged(async user => {
  if (!user) {
    alert('Please log in'); 
    window.location.href = 'login.html'; 
    return; 
  }

  welcomeMsg.textContent = `Welcome, ${user.displayName || user.email}`;

  const isAdmin = await db.ref(`admins/${user.uid}`).get().then(snap => snap.exists());
  if (isAdmin) {
    adminSection.classList.remove('hidden');
    loadAdminRequests();
  } else {
    userSection.classList.remove('hidden');
    loadUserChannels(user.uid);
  }
});

// Upload to ImgBB
async function uploadToImgBB(file) {
  const formData = new FormData();
  formData.append("image", file);
  const res = await fetch("https://api.imgbb.com/1/upload?key=8604e4b4050c63c460d0bca39cf28708", { method: "POST", body: formData });
  const data = await res.json();
  if (data.success) return data.data.url;
  throw new Error("Image upload failed");
}

// Submit Channel
async function submitChannel() {
  const name = document.getElementById('channel-name').value.trim();
  const url = document.getElementById('channel-url').value.trim();
  const category = document.getElementById('channel-category').value;
  const fileInput = document.getElementById('channel-icon-file');
  const statusText = document.getElementById('upload-status');
  const user = auth.currentUser;

  if (!name || !url || fileInput.files.length === 0) {
    alert('Please fill all fields and upload an image'); 
    return;
  }

  try {
    statusText.textContent = "Uploading image...";
    const iconUrl = await uploadToImgBB(fileInput.files[0]);
    statusText.textContent = "Image uploaded ✔";

    const requestId = db.ref('channelRequests').push().key;
    await db.ref(`channelRequests/${requestId}`).set({
      name,
      icon: iconUrl,
      url,
      category,
      submittedBy: user.uid,
      submittedByName: user.displayName || user.email,
      status: 'pending',
      timestamp: Date.now()
    });

    alert('Channel request submitted');
    document.getElementById('channel-name').value = '';
    document.getElementById('channel-url').value = '';
    fileInput.value = '';
    statusText.textContent = '';
    loadUserChannels(user.uid);
  } catch (err) {
    console.error(err); 
    statusText.textContent = "Upload failed ❌"; 
    alert("Failed to upload image.");
  }
}

// Load User Channels
function loadUserChannels(uid) {
  const q = db.ref('channelRequests').orderByChild('submittedBy').equalTo(uid);
  q.on('value', snap => {
    userPending.innerHTML = '';
    userApproved.innerHTML = '';
    if (!snap.exists()) {
      userPending.innerHTML = '<p class="text-gray-400 text-center py-4">No channel requests yet</p>';
      return;
    }

    const items = [];
    snap.forEach(childSnap => items.push({ id: childSnap.key, ...childSnap.val() }));
    items.sort((a, b) => (a.timestamp || 0) - (b.timestamp || 0));

    items.forEach(c => {
      const card = document.createElement('div');
      card.className = 'flex items-center gap-4 p-3 bg-gray-700 rounded-xl shadow-md hover:shadow-lg transition-shadow';
      card.innerHTML = `
        <img src="${c.icon || 'https://via.placeholder.com/64'}" class="w-16 h-16 rounded-lg object-cover border border-gray-600"/>
        <div class="flex-1">
          <h4 class="font-semibold text-white">${c.name || 'Untitled'}</h4>
          <p class="text-gray-300">${c.category || 'Uncategorized'}</p>
          <span class="text-sm text-gray-400">Submitted by: ${c.submittedByName || c.submittedBy}</span>
        </div>
        <span class="px-2 py-1 rounded-xl text-sm ${c.status === 'approved' ? 'bg-green-500' : c.status === 'rejected' ? 'bg-red-500' : 'bg-yellow-500'}">${c.status}</span>
      `;

      if (c.status === 'pending') userPending.appendChild(card);
      if (c.status === 'approved') userApproved.appendChild(card);
    });
  });
}

// Logout
document.getElementById('logout-btn').addEventListener('click', () => {
  auth.signOut().then(() => window.location.href = '/').catch(e => alert("Error logging out."));
});

// Admin Functions
function loadAdminRequests() {
  const requestsRef = db.ref('channelRequests').orderByChild('status').equalTo('pending');
  requestsRef.on('value', snap => {
    adminRequestsList.innerHTML = '';
    if (!snap.exists()) {
      adminRequestsList.innerHTML = '<p class="text-gray-400 text-center py-4">No pending requests</p>';
      return;
    }

    snap.forEach(child => {
      const r = child.val();
      const li = document.createElement('div');
      li.className = 'channel-card justify-between flex items-center p-3 bg-gray-700 rounded-xl shadow-md hover:shadow-lg';
      li.innerHTML = `
        <div class="flex items-center gap-4">
          <img src="${r.icon || 'https://via.placeholder.com/50'}" alt="${r.name || 'Channel'}" class="w-16 h-16 rounded-lg object-cover border border-gray-600"/>
          <div>
            <h4 class="font-semibold text-white">${r.name}</h4>
            <p class="text-gray-300">${r.category}</p>
            <span class="text-sm text-gray-400">Submitted by: ${r.submittedByName || r.submittedBy}</span>
          </div>
        </div>
      `;
      const btns = document.createElement('div');
      btns.className = 'flex gap-2';
      const approve = document.createElement('button');
      approve.textContent = 'Approve';
      approve.className = 'approve-btn';
      approve.onclick = () => approveRequest(child.key, r);
      const reject = document.createElement('button');
      reject.textContent = 'Reject';
      reject.className = 'reject-btn';
      reject.onclick = () => rejectRequest(child.key);
      btns.appendChild(approve);
      btns.appendChild(reject);
      li.appendChild(btns);
      adminRequestsList.appendChild(li);
    });
  });
}

// Approve Request
function approveRequest(id, channelData) {
  db.ref(`channelRequests/${id}`).update({ status: 'approved' })
    .then(() => alert(`${channelData.name} approved!`))
    .catch(err => alert("Error approving: " + err));
}

// Reject Request
function rejectRequest(id) {
  db.ref(`channelRequests/${id}`).update({ status: 'rejected' })
    .then(() => alert("Request rejected"))
    .catch(err => alert("Error rejecting: " + err));
}
</script>
</body>
</html>