<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1, viewport-fit=cover">
<title>Premium OTT Player</title>

<!-- Tailwind CSS -->
<script src="https://cdn.tailwindcss.com"></script>
<link href="https://fonts.googleapis.com/icon?family=Material+Icons" rel="stylesheet">
<link href="https://fonts.googleapis.com/css2?family=Baloo+2&display=swap" rel="stylesheet">
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css"/>

<!-- Shaka Player -->
<script src="https://cdnjs.cloudflare.com/ajax/libs/shaka-player/4.7.0/shaka-player.compiled.js"></script>

<style>
html, body {margin:0; padding:0; width:100%; height:100%; background:#111; font-family:'Baloo 2', cursive; overflow:hidden;}
#videoContainer {position:relative; width:100%; height:100vh; display:flex; flex-direction:column; justify-content:flex-end; background:black;}
#video {width:100%; height:100%; object-fit:cover; transition:transform 0.2s ease;}
#controls {position:absolute; bottom:10px; left:10px; right:10px; display:flex; justify-content:space-between; align-items:center; padding:10px 15px; background:rgba(255,255,255,0.15); color:white; border-radius:8px; z-index:10;}
#progressContainer {position:absolute; bottom:60px; left:0; width:100%; height:5px; background:rgba(255,255,255,0.2); cursor:pointer; z-index:9;}
#buffer {position:absolute; top:0; left:0; height:100%; background:rgba(255,255,255,0.5); width:0%;}
#progress {position:absolute; top:0; left:0; height:100%; background:#f87171; width:0%;}
button {background:none; border:none; color:white; font-size:24px;}
button:hover {color:#f87171;}
input[type=range]{width:70px;}
#loadingSpinner{position:absolute;top:50%;left:50%;transform:translate(-50%,-50%);width:40px;height:40px;border:5px solid rgba(255,255,255,0.3);border-top-color:#f87171;border-radius:50%;animation:spin 1s linear infinite;display:none; z-index:20;}
@keyframes spin{0%{transform:translate(-50%,-50%) rotate(0deg);}100%{transform:translate(-50%,-50%) rotate(360deg);}}
#header{position:absolute;top:0; left:0; width:100%; display:flex; justify-content:space-between; align-items:center; padding:10px 15px; z-index:20; background:rgba(0,0,0,0.4);}
.header-left{display:flex; align-items:center; gap:10px; color:white;}
.header-right{display:flex; align-items:center; gap:10px;}
.quality-menu{position:absolute; bottom:60px; right:10px; background:rgba(0,0,0,0.8); color:white; border-radius:6px; padding:5px; display:none; flex-direction:column; z-index:25;}
.quality-menu button{font-size:14px; padding:6px 10px; text-align:left;}
.quality-menu button:hover{background:rgba(255,255,255,0.2);}
.ticker{position:absolute; top:0; left:0; width:100%; background:rgba(0,0,0,0.4); color:white; font-size:14px; padding:6px 0; white-space:nowrap; overflow:hidden; z-index:5;}
.ticker span{display:inline-block; padding-left:100%; animation:scroll 25s linear infinite;}
@keyframes scroll{0% {transform:translateX(0);} 100%{transform:translateX(-100%);}}
#rotateMsg{position:absolute; top:50%; left:50%; transform:translate(-50%, -50%); color:white; background:rgba(0,0,0,0.5); padding:10px 20px; border-radius:10px; z-index:30; display:none; text-align:center;}
</style>
</head>
<body>
<div id="videoContainer">
  <video id="video" playsinline webkit-playsinline></video>
  <div id="loadingSpinner"></div>

  <div id="header">
    <div class="header-left">
      <button onclick="history.back()" class="material-icons text-white">arrow_back</button>
      <span class="material-icons">live_tv</span>
      <span id="videoTitle" class="text-white font-semibold text-sm">Video Title</span>
    </div>
    <div class="header-right">
      <a href="https://facebook.com" target="_blank" class="text-blue-500"><i class="fab fa-facebook"></i></a>
      <a href="https://t.me/" target="_blank" class="text-sky-400"><i class="fab fa-telegram"></i></a>
      <a href="https://youtube.com" target="_blank" class="text-red-500"><i class="fab fa-youtube"></i></a>
    </div>
  </div>

  <div class="ticker"><span>ðŸ”¥ Join Telegram Channel for Updates | Ads Here ðŸ”¥</span></div>
  <div id="progressContainer"><div id="buffer"></div><div id="progress"></div></div>
  <div id="controls">
    <div class="flex items-center space-x-3">
      <button id="playBtn" class="material-icons">play_arrow</button>
      <button id="muteBtn" class="material-icons">volume_up</button>
      <input id="volumeSlider" type="range" min="0" max="1" step="0.05" value="1"/>
      <button id="favBtn"><i class="fa-regular fa-heart"></i></button>
    </div>
    <div class="flex items-center space-x-2">
      <button id="qualityBtn" class="material-icons">high_quality</button>
      <button id="fsBtn" class="material-icons">fullscreen</button>
    </div>
  </div>
  <div id="qualityMenu" class="quality-menu"></div>
  <div id="rotateMsg">Rotate your device for best experience</div>
</div>

<script type="module">
import { initializeApp } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-app.js";
import { getDatabase, ref, get } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-database.js";

const video=document.getElementById('video');
const playBtn=document.getElementById('playBtn');
const fsBtn=document.getElementById('fsBtn');
const muteBtn=document.getElementById('muteBtn');
const volumeSlider=document.getElementById('volumeSlider');
const controls=document.getElementById('controls');
const videoTitle=document.getElementById('videoTitle');
const progress=document.getElementById('progress');
const buffer=document.getElementById('buffer');
const progressContainer=document.getElementById('progressContainer');
const loadingSpinner=document.getElementById('loadingSpinner');
const favBtn=document.getElementById('favBtn');
const qualityBtn=document.getElementById('qualityBtn');
const qualityMenu=document.getElementById('qualityMenu');
const rotateMsg=document.getElementById('rotateMsg');

let shakaPlayer=null,favorites=JSON.parse(localStorage.getItem('favorites'))||[];

// Firebase
const firebaseConfig={apiKey:"AIzaSyB9GaCbYFH22WbiLs1pc_UJTsM_0Tetj6E",authDomain:"tnm3ulive.firebaseapp.com",databaseURL:"https://tnm3ulive-default-rtdb.asia-southeast1.firebasedatabase.app",projectId:"tnm3ulive",storageBucket:"tnm3ulive.firebasestorage.app",messagingSenderId:"80664356882",appId:"1:80664356882:web:c8464819b0515ec9b210cb"};
const app=initializeApp(firebaseConfig);
const db=getDatabase(app);
function qs(name){return new URL(location.href).searchParams.get(name);}

// --- Shaka Player ---
function initShaka(){
  shaka.polyfill.installAll(); 
  if(!shaka.Player.isBrowserSupported()) return;
  shakaPlayer=new shaka.Player(video);
  shakaPlayer.configure({streaming:{rebufferingGoal:4,bufferingGoal:30},abr:{enabled:true}});
  shakaPlayer.addEventListener('error',e=>console.error('Shaka Error',e.detail||e));
}

// --- Load Stream ---
let slug=qs('stream'); if(slug) slug=slug.replace(/-/g,' ').toLowerCase();
if(!slug) alert('No stream specified');
else{
  get(ref(db,'channels')).then(snap=>{
    if(snap.exists()){
      let found=false;
      snap.forEach(child=>{
        const data=child.val();
        if(data.name&&data.name.toLowerCase()===slug){
          found=true;
          videoTitle.textContent=data.name||'Live Stream';
          localStorage.setItem('selectedVideo',data.stream);
          localStorage.setItem('selectedVideoTitle',data.name||'Live Stream');
          initShaka();
          loadingSpinner.style.display='block';
          shakaPlayer.load(data.stream).then(()=>{
            loadingSpinner.style.display='none';
            video.play();
            updateQualityMenu();
          }).catch(err=>{
            console.error(err);
            loadingSpinner.style.display='none';
            video.src=data.stream;
            video.play();
          });
        }
      });
      if(!found) alert('Channel not found');
    } else alert('No channels in DB');
  });
}

// --- Controls ---
function showControls(){controls.classList.remove('hidden');}
showControls(); // Always visible
playBtn.addEventListener('click',()=>{if(video.paused){video.play();playBtn.textContent='pause';}else{video.pause();playBtn.textContent='play_arrow';}});
muteBtn.addEventListener('click',()=>{video.muted=!video.muted;muteBtn.textContent=video.muted?'volume_off':'volume_up';});
volumeSlider.addEventListener('input',()=>{video.volume=volumeSlider.value; video.muted=video.volume===0; muteBtn.textContent=video.muted?'volume_off':'volume_up';});

// Progress
video.addEventListener('timeupdate',()=>{progress.style.width=((video.currentTime/video.duration)*100)+'%';});
video.addEventListener('progress',()=>{ if(video.buffered.length>0) buffer.style.width=((video.buffered.end(video.buffered.length-1)/video.duration)*100)+'%';});
progressContainer.addEventListener('click',e=>{const rect=progressContainer.getBoundingClientRect(); const pct=(e.clientX-rect.left)/rect.width; video.currentTime=pct*video.duration;});

// Fullscreen
fsBtn.addEventListener('click', async ()=>{
  if(video.parentElement.requestFullscreen) await video.parentElement.requestFullscreen();
  else if(video.webkitEnterFullscreen) video.webkitEnterFullscreen();
  video.style.objectFit='cover';
});
document.addEventListener('fullscreenchange',checkOrientation);

// Favorites
function updateFav(){const src=localStorage.getItem('selectedVideo'); const isFav=favorites.some(f=>f.src===src); favBtn.innerHTML=isFav?'<i class="fa-solid fa-heart text-red-500"></i>':'<i class="fa-regular fa-heart"></i>'; }
updateFav();
favBtn.addEventListener('click',()=>{const src=localStorage.getItem('selectedVideo'); const title=localStorage.getItem('selectedVideoTitle')||'Unknown'; const idx=favorites.findIndex(f=>f.src===src); if(idx===-1){favorites.push({src,title});}else{favorites.splice(idx,1);} localStorage.setItem('favorites',JSON.stringify(favorites)); updateFav();});

// Quality Selector
function updateQualityMenu(){
  if(!shakaPlayer) return;
  const tracks=shakaPlayer.getVariantTracks();
  qualityMenu.innerHTML='';
  tracks.forEach(t=>{
    const btn=document.createElement('button');
    btn.textContent=t.height+'p';
    btn.onclick=()=>{shakaPlayer.selectVariantTrack(t,true); qualityMenu.style.display='none';};
    qualityMenu.appendChild(btn);
  });
}
qualityBtn.addEventListener('click',()=>{qualityMenu.style.display=qualityMenu.style.display==='flex'?'none':'flex';});

// --- Rotate Device Message ---
function checkOrientation(){
  if(window.innerHeight>window.innerWidth && document.fullscreenElement){
    rotateMsg.style.display='block';
  }else{
    rotateMsg.style.display='none';
  }
}
window.addEventListener('resize', checkOrientation);
</script>
</body>
</html>