<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1, viewport-fit=cover">
<title>Premium Mobile TV Player</title>
<script src="https://cdn.tailwindcss.com"></script>
<link href="https://fonts.googleapis.com/icon?family=Material+Icons" rel="stylesheet">
<link href="https://fonts.googleapis.com/css2?family=Baloo+2&display=swap" rel="stylesheet">
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css"/>
<script src="https://cdnjs.cloudflare.com/ajax/libs/shaka-player/4.7.0/shaka-player.compiled.js"></script>
<style>
html, body { margin:0; padding:0; width:100%; height:100%; background:#111; font-family:'Baloo 2', cursive; overflow-x:hidden;}
#videoContainer { position:relative; width:100%; height:100%; display:flex; flex-direction:column; justify-content:flex-end; background:black; }
#video { width:100%; height:100%; object-fit:cover; transition:transform 0.2s ease; }
.ticker { position:absolute; top:0; left:0; width:100%; background:rgba(0,0,0,0.3); color:white; font-size:14px; padding:6px 0; white-space:nowrap; overflow:hidden; z-index:5;}
.ticker span { display:inline-block; padding-left:100%; animation:scroll 25s linear infinite; }
@keyframes scroll { 0% { transform:translateX(0);} 100%{transform:translateX(-100%);} }
#controls { position:relative; display:flex; justify-content:space-between; align-items:center; padding:10px 15px; background:rgba(0,0,0,0.5); width:100%; z-index:10; }
#controls.hidden { opacity:0; pointer-events:none; transition:opacity 0.3s;}
#progressContainer { position:relative; width:100%; height:5px; background:rgba(255,255,255,0.2); cursor:pointer; }
#buffer { position:absolute; top:0; left:0; height:100%; background:rgba(255,255,255,0.5); width:0%; }
#progress { position:absolute; top:0; left:0; height:100%; background:#f87171; width:0%; }
button { background:none; border:none; color:white; font-size:24px; }
button:hover { color:#f87171; }
input[type=range] { width:70px; }
#loadingSpinner { position:absolute;top:50%;left:50%;transform:translate(-50%,-50%);width:40px;height:40px;border:5px solid rgba(255,255,255,0.3);border-top-color:#f87171;border-radius:50%;animation:spin 1s linear infinite;display:none; z-index:20;}
@keyframes spin{0%{transform:translate(-50%,-50%) rotate(0deg);}100%{transform:translate(-50%,-50%) rotate(360deg);}}
</style>
</head>
<body>
<div id="videoContainer">
  <video id="video" playsinline webkit-playsinline></video>
  <div id="loadingSpinner"></div>
  <div class="ticker"><span>ðŸ”¥ Join Telegram Channel for Updates | Ads & Announcements Here ðŸ”¥</span></div>
  <div id="progressContainer"><div id="buffer"></div><div id="progress"></div></div>
  <div id="controls">
    <div class="flex items-center space-x-3">
      <button id="playBtn" class="material-icons">play_arrow</button>
      <button id="muteBtn" class="material-icons">volume_up</button>
      <input id="volumeSlider" type="range" min="0" max="1" step="0.05" value="1"/>
      <button id="favBtn"><i class="fa-regular fa-heart"></i></button>
      <span id="videoTitle" class="ml-2 text-white text-sm font-semibold">Video Title</span>
    </div>
    <div>
      <button id="fsBtn" class="material-icons">fullscreen</button>
    </div>
  </div>
</div>

<script type="module">
import { initializeApp } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-app.js";
import { getDatabase, ref, get } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-database.js";

const video=document.getElementById('video');
const playBtn=document.getElementById('playBtn');
const fsBtn=document.getElementById('fsBtn');
const muteBtn=document.getElementById('muteBtn');
const volumeSlider=document.getElementById('volumeSlider');
const controls=document.getElementById('controls');
const videoTitle=document.getElementById('videoTitle');
const progress=document.getElementById('progress');
const buffer=document.getElementById('buffer');
const progressContainer=document.getElementById('progressContainer');
const loadingSpinner=document.getElementById('loadingSpinner');
const favBtn=document.getElementById('favBtn');

let shakaPlayer=null,favorites=JSON.parse(localStorage.getItem('favorites'))||[],controlsTimeout,scale=1,initialDistance=null;

// Firebase
const firebaseConfig={apiKey:"AIzaSyB9GaCbYFH22WbiLs1pc_UJTsM_0Tetj6E",authDomain:"tnm3ulive.firebaseapp.com",databaseURL:"https://tnm3ulive-default-rtdb.asia-southeast1.firebasedatabase.app",projectId:"tnm3ulive",storageBucket:"tnm3ulive.firebasestorage.app",messagingSenderId:"80664356882",appId:"1:80664356882:web:c8464819b0515ec9b210cb"};
const app=initializeApp(firebaseConfig);
const db=getDatabase(app);
function qs(name){return new URL(location.href).searchParams.get(name);}

// --- Shaka Player ---
function initShaka(){shaka.polyfill.installAll(); if(!shaka.Player.isBrowserSupported()) return; shakaPlayer=new shaka.Player(video); shakaPlayer.configure({streaming:{rebufferingGoal:4,bufferingGoal:30},abr:{enabled:true}}); shakaPlayer.addEventListener('error',e=>console.error('Shaka Error',e.detail||e));}

// --- Load Stream ---
let slug=qs('stream'); if(slug) slug=slug.replace(/-/g,' ').toLowerCase();
if(!slug) alert('No stream specified');
else{
  get(ref(db,'channels')).then(snap=>{
    if(snap.exists()){
      let found=false;
      snap.forEach(child=>{
        const data=child.val();
        if(data.name&&data.name.toLowerCase()===slug){
          found=true;
          videoTitle.textContent=data.name||'Live Stream';
          localStorage.setItem('selectedVideo',data.stream);
          localStorage.setItem('selectedVideoTitle',data.name||'Live Stream');
          initShaka();
          loadingSpinner.style.display='block';
          shakaPlayer.load(data.stream).then(()=>{loadingSpinner.style.display='none'; video.play();}).catch(err=>{console.error(err); loadingSpinner.style.display='none'; video.src=data.stream; video.play();});
        }
      });
      if(!found) alert('Channel not found');
    } else alert('No channels in DB');
  });
}

// --- Controls ---
function showControls(){controls.classList.remove('hidden'); clearTimeout(controlsTimeout); controlsTimeout=setTimeout(()=>controls.classList.add('hidden'),3000);}
video.addEventListener('mousemove',showControls);
video.addEventListener('touchstart',showControls);

playBtn.addEventListener('click',()=>{if(video.paused){video.play();playBtn.textContent='pause';}else{video.pause();playBtn.textContent='play_arrow';}});
muteBtn.addEventListener('click',()=>{video.muted=!video.muted;muteBtn.textContent=video.muted?'volume_off':'volume_up';});
volumeSlider.addEventListener('input',()=>{video.volume=volumeSlider.value; video.muted=video.volume===0; muteBtn.textContent=video.muted?'volume_off':'volume_up';});

// Progress bar
video.addEventListener('timeupdate',()=>{progress.style.width=((video.currentTime/video.duration)*100)+'%';});
video.addEventListener('progress',()=>{ if(video.buffered.length>0) buffer.style.width=((video.buffered.end(video.buffered.length-1)/video.duration)*100)+'%';});
progressContainer.addEventListener('click',e=>{const rect=progressContainer.getBoundingClientRect(); const pct=(e.clientX-rect.left)/rect.width; video.currentTime=pct*video.duration;});

// Fullscreen
fsBtn.addEventListener('click',()=>{if(!document.fullscreenElement){video.parentElement.requestFullscreen();}else{document.exitFullscreen();}});
document.addEventListener('fullscreenchange',()=>{video.style.objectFit='cover';});

// Pinch & wheel zoom
video.addEventListener('wheel',e=>{scale+=e.deltaY*-0.001;scale=Math.min(Math.max(1,scale),3);video.style.transform=`scale(${scale})`;});
video.addEventListener('touchstart',e=>{if(e.touches.length===2) initialDistance=Math.hypot(e.touches[0].pageX-e.touches[1].pageX,e.touches[0].pageY-e.touches[1].pageY);});
video.addEventListener('touchmove',e=>{if(e.touches.length===2&&initialDistance){const d=Math.hypot(e.touches[0].pageX-e.touches[1].pageX,e.touches[0].pageY-e.touches[1].pageY); scale=Math.min(Math.max(1,scale*(d/initialDistance)),3); video.style.transform=`scale(${scale})`; initialDistance=d;}});
video.addEventListener('touchend',e=>{if(e.touches.length<2) initialDistance=null;});

// Favorites
function updateFav(){const src=localStorage.getItem('selectedVideo'); const isFav=favorites.some(f=>f.src===src); favBtn.innerHTML=isFav?'<i class="fa-solid fa-heart text-red-500"></i>':'<i class="fa-regular fa-heart"></i>'; }
updateFav();
favBtn.addEventListener('click',()=>{const src=localStorage.getItem('selectedVideo'); const title=localStorage.getItem('selectedVideoTitle')||'Unknown'; const idx=favorites.findIndex(f=>f.src===src); if(idx===-1){favorites.push({src,title});}else{favorites.splice(idx,1);} localStorage.setItem('favorites',JSON.stringify(favorites)); updateFav();});
</script>
</body>
</html>