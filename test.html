<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8"/>
<meta name="viewport" content="width=device-width, initial-scale=1, viewport-fit=cover"/>
<title>Live TV - Stream Live</title>

<!-- Tailwind CSS -->
<script src="https://cdn.tailwindcss.com"></script>

<!-- Material Icons -->
<link href="https://fonts.googleapis.com/icon?family=Material+Icons" rel="stylesheet"/>

<!-- Baloo 2 Font -->
<link href="https://fonts.googleapis.com/css2?family=Baloo+2&display=swap" rel="stylesheet"/>

<style>
  html, body {
    font-family: 'Baloo 2', cursive;
    background-color: #111827;
    color: #fff;
    margin: 0;
    min-height: 100vh;
  }

  header {
    height: 64px;
    display: flex;
    align-items: center;
    padding: 0 1.5rem;
    background: rgba(31,41,55,0.9);
    box-shadow: 0 2px 8px rgba(0,0,0,0.5);
    z-index: 20;
  }

  main {
    padding: 20px 1rem 100px;
    max-width: 1200px;
    margin: 0 auto;
  }
</style>
</head>

<body class="bg-gray-900 text-white">

<!-- Header -->
<header>
  <span class="material-icons">live_tv</span>
  <h1 class="ml-2 text-lg font-bold">Live Tv</h1>
  <span id="logout-btn" class="material-icons ml-auto cursor-pointer hover:text-red-500 transition" title="Logout">logout</span>
</header>

<main> 
  <!-- Welcome -->
  <p id="welcome-msg" class="text-white text-lg mt-4"></p>

  <!-- User Section -->
<div id="user-section" class="hidden max-w-5xl mx-auto w-full px-4 sm:px-6 lg:px-8 py-6">
  <h2 class="text-xl font-semibold text-white mb-4">Your Channel Requests</h2>

  <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
    <!-- Pending Requests -->
    <div class="bg-white/10 backdrop-blur-md rounded-xl shadow-lg border border-white/20 p-4 flex flex-col">
      <h3 class="text-lg font-bold text-white mb-3">Pending Requests</h3>
      <div id="pending-requests" class="space-y-3 max-h-72 overflow-y-auto pr-2">
        <!-- Pending items will appear here -->
      </div>
    </div>

    <!-- Approved Channels -->
    <div class="bg-white/10 backdrop-blur-md rounded-xl shadow-lg border border-white/20 p-4 flex flex-col">
      <h3 class="text-lg font-bold text-white mb-3">Approved Channels</h3>
      <div id="approved-channels" class="space-y-3 max-h-72 overflow-y-auto pr-2">
        <!-- Approved channels will appear here -->
      </div>
    </div>
  </div>
</div>

<!-- Admin Section -->
<div id="admin-section" class="hidden max-w-6xl mx-auto w-full px-4 sm:px-6 lg:px-8 py-6">
  <h2 class="text-xl font-semibold text-white mb-4">Admin Panel</h2>
  <p id="admin-hint" class="text-gray-300 mb-6">Loading admin data...</p>

  <div class="bg-white/10 backdrop-blur-md rounded-xl shadow-lg border border-white/20 p-4">
    <h3 class="text-lg font-bold text-white mb-3">Pending Channel Approvals</h3>
    <div id="admin-requests" class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-4 max-h-[500px] overflow-y-auto pr-2">
      <!-- Admin requests will appear here -->
    </div>
  </div>
</div>

</main>

<!-- Toast container -->
<div id="toast" class="fixed top-5 right-5 z-50 flex flex-col space-y-2 max-w-sm"></div>

<script type="module">
import { initializeApp } from "https://www.gstatic.com/firebasejs/9.22.2/firebase-app.js";
import { getAuth, onAuthStateChanged, signOut } from "https://www.gstatic.com/firebasejs/9.22.2/firebase-auth.js";
import { getDatabase, ref, set, get, onValue, push, remove, query, orderByChild, equalTo } from "https://www.gstatic.com/firebasejs/9.22.2/firebase-database.js";

// Firebase Config
const firebaseConfig = {
  apiKey: "AIzaSyB9GaCbYFH22WbiLs1pc_UJTsM_0Tetj6E",
  authDomain: "tnm3ulive.firebaseapp.com",
  databaseURL: "https://tnm3ulive-default-rtdb.asia-southeast1.firebasedatabase.app",
  projectId: "tnm3ulive",
  storageBucket: "tnm3ulive.firebasestorage.app",
  messagingSenderId: "80664356882",
  appId: "1:80664356882:web:c8464819b0515ec9b210cb",
  measurementId: "G-FNS9JWZ9LS"
};

const app = initializeApp(firebaseConfig);
const auth = getAuth(app);
const db = getDatabase(app);

// DOM
const userSection = document.getElementById('user-section');
const adminSection = document.getElementById('admin-section');
const welcomeMsg  = document.getElementById('welcome-msg');
const userPending = document.getElementById('user-pending');
const userApproved= document.getElementById('user-approved');
const adminRequestsList = document.getElementById('admin-requests');
const adminHint   = document.getElementById('admin-hint');
const toastContainer = document.getElementById('toast');
const submitBtn   = document.getElementById('submit-btn');

// Toast
function showToast(message, type='info', duration=3000){
  const toast = document.createElement('div');
  toast.className = `flex items-center space-x-3 p-4 rounded-lg shadow-lg font-medium
    ${type==='success'?'bg-green-500': type==='error'?'bg-red-500':'bg-blue-500'} text-white
    opacity-0 translate-x-10 transition-all duration-300`;
  toast.textContent = message;
  toastContainer.appendChild(toast);
  requestAnimationFrame(() => { toast.classList.remove('opacity-0','translate-x-10'); });
  setTimeout(() => { toast.classList.add('opacity-0','translate-x-10'); toast.addEventListener('transitionend',()=>toast.remove()); }, duration);
}

// Helpers
async function getUserName(uid){
  if(!uid) return 'Unknown';
  try{
    const snap = await get(ref(db, `users/${uid}/name`));
    return snap.exists()? snap.val() : uid;
  } catch(e){ console.error(e); return uid; }
}

function statusPill(status){
  if(status==='approved') return '<span class="pill bg-green-500 text-white">Approved</span>';
  if(status==='pending') return '<span class="pill bg-yellow-500 text-gray-900">Pending</span>';
  if(status==='rejected') return '<span class="pill bg-red-500 text-white">Rejected</span>';
  return '<span class="pill bg-gray-500 text-white">Unknown</span>';
}

// Auth + Section visibility
document.addEventListener('DOMContentLoaded', () => {
  onAuthStateChanged(auth, async (user)=>{
    if(!user){
      showToast("Please log in", "error");
      window.location.href='signin';
      return;
    }
    welcomeMsg.textContent = `Welcome, ${user.email}`;

    try {
      const adminSnap = await get(ref(db, `admins/${user.uid}`));
      const isAdmin = adminSnap.exists();

      if(isAdmin){
        adminSection.classList.remove('hidden');
        adminHint.textContent = 'Showing all PENDING requests';
        loadAdminRequests();
      } else {
        userSection.classList.remove('hidden');
        loadUserChannels(user.uid);
      }
    } catch(e){
      console.error(e);
      showToast("Unable to verify admin status", "error");
    }
  });
});

// Logout
document.getElementById('logout-btn').addEventListener('click', ()=>{
  signOut(auth).then(()=>{ showToast("Logged out","success"); window.location.href='/'; })
  .catch(e=>{ console.error(e); showToast("Error logging out","error"); });
});

// Submit Channel
submitBtn.addEventListener('click', async ()=>{
  try{
    const name = document.getElementById('channel-name').value.trim();
    const icon = document.getElementById('channel-icon').value.trim();
    const url  = document.getElementById('channel-url').value.trim();
    const category = document.getElementById('channel-category').value;
    const user = auth.currentUser;

    if(!name || !icon || !url){ showToast("Please fill all fields","error"); return; }

    const reqRef = push(ref(db, 'channelRequests'));
    await set(reqRef, { name, icon, url, category, submittedBy:user.uid, status:'pending', timestamp:Date.now() });
    document.getElementById('channel-name').value='';
    document.getElementById('channel-icon').value='';
    document.getElementById('channel-url').value='';
    showToast("Channel request submitted!","success");
  } catch(e){
    console.error(e); showToast("Submit failed","error");
  }
});

// User channels
const lastStatuses = new Map();
function loadUserChannels(uid){
  const q = query(ref(db,'channelRequests'), orderByChild('submittedBy'), equalTo(uid));
  onValue(q, async snap=>{
    userPending.innerHTML=''; userApproved.innerHTML='';
    if(!snap.exists()){ userPending.innerHTML='<p class="text-gray-400 text-center py-4">No requests yet</p>'; return; }

    const items = []; snap.forEach(cs=>items.push({id:cs.key,...cs.val()}));
    items.sort((a,b)=> (a.timestamp||0)-(b.timestamp||0));

    for(const c of items){
      const userName = await getUserName(c.submittedBy);
      const prev = lastStatuses.get(c.id);
      if(prev && prev!==c.status){
        if(prev==='pending' && c.status==='approved') showToast(`"${c.name}" approved ðŸŽ‰`,"success");
        if(prev==='pending' && c.status==='rejected') showToast(`"${c.name}" rejected`,"error");
      }
      lastStatuses.set(c.id, c.status);

      const card = document.createElement('div');
      card.className='flex items-center gap-4 p-3 bg-gray-700 rounded-xl shadow-md hover:shadow-lg transition-shadow';
      card.innerHTML=`
        <img src="${c.icon||'https://via.placeholder.com/64'}" class="w-16 h-16 rounded-lg object-cover border border-gray-600"/>
        <div class="flex-1">
          <h4 class="font-semibold text-white">${c.name||'Untitled'}</h4>
          <p class="text-gray-300">${c.category||'Uncategorized'}</p>
          <span class="text-sm text-gray-400">Submitted by: ${userName}</span>
        </div>
        ${statusPill(c.status)}
      `;
      if(c.status==='pending') userPending.appendChild(card);
      if(c.status==='approved') userApproved.appendChild(card);
    }
  });
}

// Admin requests
function loadAdminRequests(){
  const requestsRef = ref(db,'channelRequests');
  onValue(requestsRef, async snap=>{
    adminRequestsList.innerHTML='';
    if(!snap.exists()){ adminRequestsList.innerHTML='<p class="text-gray-400 text-center py-4">No pending requests</p>'; return; }

    const rows=[]; snap.forEach(cs=>{ const r=cs.val(); if(r.status==='pending') rows.push({id:cs.key,...r}); });
    rows.sort((a,b)=>(a.timestamp||0)-(b.timestamp||0));
    if(!rows.length){ adminRequestsList.innerHTML='<p class="text-gray-400 text-center py-4">No pending requests</p>'; return; }

    for(const r of rows){
      const userName = await getUserName(r.submittedBy);
      const li=document.createElement('div'); li.className='channel-card justify-between flex items-center p-3 bg-gray-700 rounded-xl shadow-md hover:shadow-lg transition-shadow';
      li.innerHTML=`
        <div class="flex items-center gap-4">
          <img src="${r.icon||'https://via.placeholder.com/64'}" class="w-16 h-16 rounded-lg border border-gray-600"/>
          <div>
            <h4 class="font-semibold text-white">${r.name||'Untitled Channel'}</h4>
            <p class="text-gray-300">${r.category||'Uncategorized'}</p>
            <span class="text-sm text-gray-400">Submitted by: ${userName}</span>
          </div>
        </div>
      `;
      const btns=document.createElement('div'); btns.className='flex gap-2';
      const approve=document.createElement('button');
      approve.textContent='Approve'; approve.className='px-3 py-1 bg-green-500 rounded hover:bg-green-600 text-white font-semibold';
      approve.onclick=()=>approveRequest(r.id,r);
      const reject=document.createElement('button');
      reject.textContent='Reject'; reject.className='px-3 py-1 bg-red-500 rounded hover:bg-red-600 text-white font-semibold';
      reject.onclick=()=>rejectRequest(r.id);
      btns.appendChild(approve); btns.appendChild(reject);
      li.appendChild(btns); adminRequestsList.appendChild(li);
    }
  });
}

async function approveRequest(id,data){
  try{
    const adminId = auth.currentUser.uid;
    const newChannelRef = push(ref(db,'channels'));
    await set(newChannelRef,{
      name:data.name||'Unnamed',
      icon:data.icon||'',
      category:data.category||'Uncategorized',
      stream:data.url||'',
      createdBy:data.submittedBy,
      approvedBy:adminId,
      approvedAt:Date.now()
    });
    await remove(ref(db,`channelRequests/${id}`));
    showToast("Channel approved","success");
  }catch(e){ console.error(e); showToast("Approve failed","error"); }
}

async function rejectRequest(id){
  try{ await remove(ref(db,`channelRequests/${id}`)); showToast("Channel rejected","error"); }
  catch(e){ console.error(e); showToast("Reject failed","error"); }
}
</script>
</body>
</html>
