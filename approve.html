<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1, viewport-fit=cover">
<title>Admin Panel - Approve Channels</title>
<script src="https://cdn.tailwindcss.com"></script>
<link href="https://fonts.googleapis.com/css2?family=Baloo+2&display=swap" rel="stylesheet"/>
<style>
body { font-family: 'Baloo 2', cursive; background-color: #111827; color: white; }
.card { background: #1f2937; border-radius: 12px; padding: 16px; display: flex; gap: 12px; margin-bottom: 12px; }
.card img { width: 60px; height: 60px; border-radius: 8px; object-fit: cover; }
.btn { padding: 8px 14px; border-radius: 6px; font-weight: bold; transition: 0.3s; }
.btn-approve { background: #10b981; color: white; }
.btn-approve:hover { background: #059669; }
.btn-reject { background: #ef4444; color: white; }
.btn-reject:hover { background: #dc2626; }
.btn-edit { background: #3b82f6; color: white; }
.btn-edit:hover { background: #2563eb; }
.modal { display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.6); justify-content: center; align-items: center; }
.modal-content { background: #1f2937; padding: 20px; border-radius: 10px; width: 90%; max-width: 400px; }
</style>
</head>
<body>

<header class="p-4 text-center text-2xl font-bold bg-red-600">Admin Approval Panel</header>
<main class="p-6 max-w-4xl mx-auto">
  <h2 class="text-3xl font-extrabold mb-6 text-center">Pending Channel Requests</h2>
  <div id="requests-container" class="space-y-4"></div>
</main>

<!-- Edit Modal -->
<div id="editModal" class="modal">
  <div class="modal-content">
    <h3 class="text-xl font-bold mb-4">Edit Channel</h3>
    <input type="text" id="editName" placeholder="Channel Name" class="w-full mb-3 p-2 bg-gray-700 rounded text-white">
    <input type="text" id="editStream" placeholder="Stream URL" class="w-full mb-3 p-2 bg-gray-700 rounded text-white">
    <select id="editCategory" class="w-full mb-4 p-2 bg-gray-700 text-white rounded">
      <option value="Tamil">Tamil</option>
      <option value="Telugu">Telugu</option>
      <option value="Kannada">Kannada</option>
      <option value="Malayalam">Malayalam</option>
      <option value="Hindi">Hindi</option>
      <option value="Kids">Kids</option>
      <option value="Sports">Sports</option>
    </select>
    <div class="flex justify-end gap-3">
      <button id="cancelEdit" class="btn btn-reject">Cancel</button>
      <button id="saveEdit" class="btn btn-approve">Save</button>
    </div>
  </div>
</div>

<!-- Firebase Admin Logic -->
<script type="module">
import { initializeApp } from "https://www.gstatic.com/firebasejs/9.22.2/firebase-app.js";
import { getAuth, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/9.22.2/firebase-auth.js";
import { getDatabase, ref, onValue, remove, set, push, update } from "https://www.gstatic.com/firebasejs/9.22.2/firebase-database.js";

const firebaseConfig = {
  apiKey: "AIzaSyB9GaCbYFH22WbiLs1pc_UJTsM_0Tetj6E",
  authDomain: "tnm3ulive.firebaseapp.com",
  databaseURL: "https://tnm3ulive-default-rtdb.asia-southeast1.firebasedatabase.app",
  projectId: "tnm3ulive",
  storageBucket: "tnm3ulive.firebasestorage.app",
  messagingSenderId: "80664356882",
  appId: "1:80664356882:web:c8464819b0515ec9b210cb",
  measurementId: "G-FNS9JWZ9LS"
};

const app = initializeApp(firebaseConfig);
const auth = getAuth(app);
const db = getDatabase(app);

const container = document.getElementById("requests-container");
const editModal = document.getElementById("editModal");
const editName = document.getElementById("editName");
const editStream = document.getElementById("editStream");
const editCategory = document.getElementById("editCategory");
const saveEdit = document.getElementById("saveEdit");
const cancelEdit = document.getElementById("cancelEdit");

let currentEditId = null;
let adminName = "";

onAuthStateChanged(auth, async user=>{
  if(!user){ window.location.href="signin"; return; }
  const adminSnap = await (await fetch(`https://tnm3ulive-default-rtdb.asia-southeast1.firebasedatabase.app/admins/${user.uid}.json`)).json();
  adminName = adminSnap?.name || "Admin";

  const reqRef = ref(db, "channelRequests");
  onValue(reqRef, snap=>{
    container.innerHTML="";
    if(!snap.exists()){ container.innerHTML='<p class="text-center text-gray-400">No pending requests</p>'; return; }

    snap.forEach(cs=>{
      const c = cs.val();
      const id = cs.key;

      const card = document.createElement("div");
      card.className="card";
      card.innerHTML = `
        <img src="${c.icon}" alt="${c.name}">
        <div class="flex-1">
          <h4 class="text-xl font-bold">${c.name}</h4>
          <p class="text-gray-400">${c.category}</p>
          <p class="text-sm text-gray-500">By: ${c.submittedBy}</p>
        </div>
        <div class="flex flex-col gap-2">
          <button class="btn btn-approve">Approve</button>
          <button class="btn btn-edit">Edit</button>
          <button class="btn btn-reject">Reject</button>
        </div>
      `;

      card.querySelector(".btn-approve").addEventListener("click",()=>approveChannel(id,c));
      card.querySelector(".btn-reject").addEventListener("click",()=>rejectChannel(id));
      card.querySelector(".btn-edit").addEventListener("click",()=>{
        currentEditId=id;
        editName.value=c.name;
        editStream.value=c.stream;
        editCategory.value=c.category;
        editModal.style.display="flex";
      });

      container.appendChild(card);
    });
  });
});

async function approveChannel(id,data){
  const channelRef = push(ref(db,"channels"));
  await set(channelRef,{
    name: data.name,
    icon: data.icon,
    stream: data.stream,
    category: data.category,
    approvedBy: adminName,
    approvedAt: Date.now()
  });
  await remove(ref(db,`channelRequests/${id}`));
}

async function rejectChannel(id){
  await remove(ref(db,`channelRequests/${id}`));
}

saveEdit.addEventListener("click", async()=>{
  if(!currentEditId) return;
  await update(ref(db,`channelRequests/${currentEditId}`),{
    name: editName.value,
    stream: editStream.value,
    category: editCategory.value,
    lastEditedBy: adminName
  });
  editModal.style.display="none";
});

cancelEdit.addEventListener("click",()=>editModal.style.display="none");
</script>

</body>
</html>