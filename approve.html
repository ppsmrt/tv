<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1, viewport-fit=cover">
<title>Admin Panel - Approve Channels</title>
<script src="https://cdn.tailwindcss.com"></script>
<link href="https://fonts.googleapis.com/css2?family=Baloo+2&display=swap" rel="stylesheet"/>
<style>
body { font-family: 'Baloo 2', cursive; background-color: #111827; color: white; }
.card { background: #1f2937; border-radius: 12px; padding: 16px; display: flex; gap: 12px; margin-bottom: 12px; }
.card img { width: 60px; height: 60px; border-radius: 8px; object-fit: cover; }
.btn { padding: 8px 14px; border-radius: 6px; font-weight: bold; transition: 0.3s; }
.btn-approve { background: #10b981; color: white; }
.btn-approve:hover { background: #059669; }
.btn-reject { background: #ef4444; color: white; }
.btn-reject:hover { background: #dc2626; }
.btn-edit { background: #3b82f6; color: white; }
.btn-edit:hover { background: #2563eb; }
.modal { display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.6); justify-content: center; align-items: center; z-index: 50; }
.modal-content { background: #1f2937; padding: 20px; border-radius: 10px; width: 90%; max-width: 400px; }
.toast { position: fixed; bottom: 20px; right: 20px; background: #1f2937; color: white; padding: 12px 20px; border-radius: 8px; font-weight: bold; z-index: 100; }
</style>
</head>
<body>
  
<!-- Header -->
<div id="header">
  
<main class="p-6 max-w-4xl mx-auto">
  <h2 class="text-3xl font-extrabold mb-6 text-center">Pending Channel Requests</h2>
  <div id="requests-container" class="space-y-4"></div>
</main>

<!-- Edit Modal -->
<div id="editModal" class="modal">
  <div class="modal-content">
    <h3 class="text-xl font-bold mb-4">Edit Channel</h3>
    <input type="text" id="editName" placeholder="Channel Name" class="w-full mb-3 p-2 bg-gray-700 rounded text-white">
    <input type="text" id="editStream" placeholder="Stream URL" class="w-full mb-3 p-2 bg-gray-700 rounded text-white">
    <select id="editCategory" class="w-full mb-4 p-2 bg-gray-700 text-white rounded">
      <option value="Tamil">Tamil</option>
      <option value="Telugu">Telugu</option>
      <option value="Kannada">Kannada</option>
      <option value="Malayalam">Malayalam</option>
      <option value="Hindi">Hindi</option>
      <option value="Kids">Kids</option>
      <option value="Sports">Sports</option>
    </select>
    <div class="flex justify-end gap-3">
      <button id="cancelEdit" class="btn btn-reject">Cancel</button>
      <button id="saveEdit" class="btn btn-approve">Save</button>
    </div>
  </div>
</div>

<!-- Footer -->
  <div id="footer"></div>
  
<!-- Toast -->
<div id="toast-container"></div>
  
  <!-- JS -->
  <script type="module" src="assets/js/header.js"></script>
  <script type="module" src="assets/js/footer.js"></script>

<!-- Firebase Admin Logic -->
<script type="module">
import { initializeApp } from "https://www.gstatic.com/firebasejs/9.22.2/firebase-app.js";
import { getAuth, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/9.22.2/firebase-auth.js";
import { getDatabase, ref, onValue, remove, set, push, update } from "https://www.gstatic.com/firebasejs/9.22.2/firebase-database.js";

const firebaseConfig = {
  apiKey: "AIzaSyB9GaCbYFH22WbiLs1pc_UJTsM_0Tetj6E",
  authDomain: "tnm3ulive.firebaseapp.com",
  databaseURL: "https://tnm3ulive-default-rtdb.asia-southeast1.firebasedatabase.app",
  projectId: "tnm3ulive",
  storageBucket: "tnm3ulive.firebasestorage.app",
  messagingSenderId: "80664356882",
  appId: "1:80664356882:web:c8464819b0515ec9b210cb",
  measurementId: "G-FNS9JWZ9LS"
};

const app = initializeApp(firebaseConfig);
const auth = getAuth(app);
const db = getDatabase(app);

const container = document.getElementById("requests-container");
const editModal = document.getElementById("editModal");
const editName = document.getElementById("editName");
const editStream = document.getElementById("editStream");
const editCategory = document.getElementById("editCategory");
const saveEdit = document.getElementById("saveEdit");
const cancelEdit = document.getElementById("cancelEdit");
const toastContainer = document.getElementById("toast-container");

let currentEditId = null;
let adminName = "";

/** Toast Function */
function showToast(msg, type="info") {
  const div = document.createElement("div");
  div.className = `toast ${type==="success"?"bg-green-600":type==="error"?"bg-red-600":"bg-blue-600"}`;
  div.textContent = msg;
  toastContainer.appendChild(div);
  setTimeout(()=>div.remove(), 3000);
}

/** Cache for user names */
const userCache = {};
async function getUserName(uid) {
  if (!uid) return "Unknown";
  if (userCache[uid]) return userCache[uid];
  try {
    const res = await fetch(`https://tnm3ulive-default-rtdb.asia-southeast1.firebasedatabase.app/users/${uid}.json`);
    const data = await res.json();
    const name = data?.name || uid;
    userCache[uid] = name;
    return name;
  } catch {
    return uid;
  }
}

onAuthStateChanged(auth, async user=>{
  if(!user){ alert("Please login as admin"); window.location.href="signin"; return; }

  // Fetch admin name
  const adminSnap = await fetch(`https://tnm3ulive-default-rtdb.asia-southeast1.firebasedatabase.app/admins/${user.uid}.json`);
  const data = await adminSnap.json();
  adminName = data?.name || "Admin";
  console.log("Logged in as:", adminName);

  // Load pending requests
  const reqRef = ref(db, "channelRequests");
  onValue(reqRef, async snap=>{
    container.innerHTML="";
    if(!snap.exists()){ 
      container.innerHTML='<p class="text-center text-gray-400">No pending requests</p>'; 
      return; 
    }

    const requests = [];
    snap.forEach(cs=>{
      const c = cs.val();
      const id = cs.key;
      requests.push({ id, ...c });
    });

    // Resolve all usernames first
    const cards = await Promise.all(requests.map(async c=>{
      const submitterName = await getUserName(c.submittedBy);

      const card = document.createElement("div");
      card.className="card";
      card.innerHTML = `
        <img src="${c.icon}" alt="${c.name}">
        <div class="flex-1">
          <h4 class="text-xl font-bold">${c.name}</h4>
          <p class="text-gray-400">${c.category}</p>
          <p class="text-sm text-gray-500">By: ${submitterName}</p>
          ${c.lastEditedBy ? `<p class="text-xs text-yellow-400">Edited by: ${c.lastEditedBy}</p>` : ""}
        </div>
        <div class="flex flex-col gap-2">
          <button class="btn btn-approve">Approve</button>
          <button class="btn btn-edit">Edit</button>
          <button class="btn btn-reject">Reject</button>
        </div>
      `;

      card.querySelector(".btn-approve").addEventListener("click",()=>approveChannel(c.id, c));
      card.querySelector(".btn-reject").addEventListener("click",()=>rejectChannel(c.id));
      card.querySelector(".btn-edit").addEventListener("click",()=>{
        currentEditId=c.id;
        editName.value=c.name;
        editStream.value=c.stream;
        editCategory.value=c.category;
        editModal.style.display="flex";
      });

      return card;
    }));

    // Render all cards
    cards.forEach(card=>container.appendChild(card));
  });
});

async function approveChannel(id,data){
  try {
    const channelRef = push(ref(db,"channels"));
    await set(channelRef,{
      ...data,
      approvedBy: adminName,
      approvedAt: Date.now()
    });
    await remove(ref(db,`channelRequests/${id}`)); // remove from pending
    showToast("Channel Approved!", "success");
    console.log(`Approved: ${data.name}`);
  } catch (err) {
    console.error("Approve Error:", err);
    showToast("Approve Failed!", "error");
  }
}

async function rejectChannel(id){
  try {
    await remove(ref(db,`channelRequests/${id}`)); // delete request
    showToast("Channel Rejected!", "error");
    console.log(`Rejected request ID: ${id}`);
  } catch (err) {
    console.error("Reject Error:", err);
    showToast("Reject Failed!", "error");
  }
}

saveEdit.addEventListener("click", async()=>{
  if(!currentEditId) return;
  try {
    await update(ref(db,`channelRequests/${currentEditId}`),{
      name: editName.value,
      stream: editStream.value,
      category: editCategory.value,
      lastEditedBy: adminName
    });
    editModal.style.display="none";
    showToast("Channel Updated!", "success");
  } catch (err) {
    console.error("Edit Error:", err);
    showToast("Update Failed!", "error");
  }
});

cancelEdit.addEventListener("click",()=>editModal.style.display="none");
</script>

</body>
</html>
